{"date":"2018-01-17T00:00:00.000Z","title":"Google Analytics et le bandeau cookie CNIL","excerpt":"Vous avez tous au moins été confrontés une fois, lors de la visite d'un site, à un message précisant que ce dernier utilise des cookies. Ce message parfois agaçant est dû à une loi passée il y a quelques années par la commission européenne. Profitons donc de l'intégration récente de ce bandeau sur ce blog pour en parler.","readingTime":"12mn","authors":["mlenglet"],"categories":["javascript"],"content":"\nVous avez tous au moins été confrontés une fois, lors de la visite d'un site, à un message précisant que ce dernier utilise des cookies. Ce message parfois agaçant (jetez un coup d'oeil à _[I don't care about cookies](https://www.i-dont-care-about-cookies.eu/){:rel=\"nofollow\"}_) est dû à une loi passée il y a quelques années par la commission européenne. Profitons donc de l'intégration récente de ce bandeau sur ce blog pour en parler.\n\n## Se conformer à la loi\n\nSuite à de nombreux abus sur l'utilisation des cookies (pistage des utilisateurs à travers les différents sites qu'ils visitent, etc), l'Union Européenne a mis en place une directive censée protéger les utilisateurs et leur permettre de donner leur autorisation ou non aux sites qu'ils fréquentent d'utiliser des cookies.\n\n### Explication de la directive\n\nEn application de la directive européenne dite \"paquet télécom\", les internautes doivent être informés et donner leur consentement préalablement à l'insertion de traceurs. Ils doivent disposer d'une possibilité de choisir de ne pas être tracés lorsqu'ils visitent un site ou utilisent une application. Les éditeurs ont donc l'obligation de solliciter au préalable le consentement des utilisateurs. Ce consentement est valable 13 mois maximum.\n\n### Mauvaise application\n\nCette directive demeure très mal appliquée. En fait la plupart des sites le font de façon non conforme à la directive, en se limitant à une simple \"bannière\" informant de l'utilisation de \"cookies\" sans donner d'information sur les utilisations, sans différencier les cookies \"techniques\" des cookies de \"pistage\", ni d'offrir de choix réel à l’utilisateur désirant maintenir les cookies techniques (comme les cookies de gestion du panier d'achat) et refuser les cookies de \"pistage\". De fait de nombreux sites ne fonctionnent pas correctement si les cookies sont refusés, ce qui est non conforme.\n\n### Sanctions\n\nLe non-respect de cette loi peut entraîner, en France, de lourdes sanctions de la part de la CNIL.\nLorsque des manquements à la loi sont portés à sa connaissance, la formation restreinte de cette dernière peut prononcer à l’égard du responsable de traitement fautif :\n\n- **Un avertissement, qui peut être rendu public.** Dans l'hypothèse où le Président de la CNIL a, au préalable, prononcé une mise en demeure, et que le responsable de traitement ne s'y est pas conformé, la formation restreinte peut prononcer, à l'issue d'une procédure contradictoire :\n- **Une sanction pécuniaire** (sauf pour les traitements de l’État) d’un montant maximal de 150.000€, et, en cas de récidive, jusqu’à 300.000 €. Cette sanction peut être rendue publique ; la formation restreinte peut également ordonner l'insertion de sa décision dans la presse, aux frais de l'organisme sanctionné. Le montant des amendes est perçu par le Trésor Public et non par la CNIL.\n- **Une injonction de cesser le traitement.**\n- **Un retrait de l’autorisation accordée par la CNIL** en application de [l’article 25 de la loi](https://www.cnil.fr/fr/loi-78-17-du-6-janvier-1978-modifiee#Article25){:rel=\"nofollow\"}\n\n![saline]({{site.baseurl}}/assets/2018-01-17-cookie-banner/brouette-sel.jpg){:class=\"center-image\"}\n_Chargement de sel pour une entreprise ayant été sanctionné par la CNIL_{:style=\"text-align:center;display:block;\"}\n\n### Cas de Google Analytics\n\nCertains traceurs sont cependant dispensés du recueil de ce consentement.\nPour en faire partie, les outils de mesure d'audience doivent respecter les conditions suivantes :\n\n- L'éditeur du site doit délivrer une information claire et complète ;\n- Un mécanisme d’opposition doit être accessible simplement et doit pouvoir être utilisable sur tous les navigateurs, et tous les types de terminaux (y compris les smartphones et tablettes) ;\n- Les données collectées ne doivent pas être recoupées avec d’autres traitements (fichiers clients ou statistiques de fréquentation d'autres sites par exemple) ;\n- Le cookie déposé doit servir uniquement à la production de statistiques anonymes ;\n- Le cookie ne doit pas permettre de suivre la navigation de l’internaute sur d’autres sites ;\n- L’adresse IP permettant de géolocaliser l’internaute ne doit pas être plus précise que l’échelle de la ville. Concrètement les deux derniers octets de l’adresse IP doivent être supprimés ;\n- Les cookies permettant la traçabilité des internautes et les adresses IP ne doivent pas être conservés au-delà de 13 mois à compter de la première visite.\n\nCertains outils respectent l'ensemble de ces critères comme [Matomo](https://matomo.org/){:rel=\"nofollow\"} (anciennement Piwik) ou [Xiti](https://www.xiti.com/){:rel=\"nofollow\"}. Malheureusement, Google Analytics n'en fait pas partie, notamment car les cookies posés par ce dernier ont une durée de vie supérieure à 13 mois.\nÉtant l'outil que nous avons choisi pour ce blog, nous devions donc intégrer un \"bandeau cookie\".\n\n## L'implémentation sur notre blog\n\nNous avons développé cette fonctionnalité récemment sur ce blog. Les seuls cookies posés par ce site sont ceux de Google Analytics, c'est pourquoi la solution a été orientée vers celle-ci. Elle s'inspire d'un [code d'exemple disponible directement sur le compte Github de la CNIL](https://github.com/LINCnil/Cookie-consent_Google-Analytics){:rel=\"nofollow\"}.\n\n### Le HTML/CSS\n\nComme la CNIL le recommande, on part sur un bandeau avertissant l'utilisateur avec un bouton/lien lui permettant d'avoir plus d'informations et de s'opposer à l'utilisation des cookies. Si l'utilisateur clique sur le site n'importe où en dehors de ce bandeau, il sera considéré que l'utilisateur a approuvé l'utilisation des cookies.\n\n![Bandeau Cookie - learn the difference]({{site.baseurl}}/assets/2018-01-17-cookie-banner/learn-the-difference.jpg){:class=\"center-image\"}\n\nLe choix final de l'utilisateur (après clic sur le bouton dans le bandeau) sera affiché dans une boite de dialogue contenant une explication détaillée de pourquoi les cookies sont nécessaires et deux boutons permettant d'accepter ou de refuser l'utilisation des cookies.\nCette boite de dialogue comportera un \"overlay\" obligeant l'utilisateur à faire son choix avant de continuer à utiliser le site.\n\n```html\n<!-- Bandeau cookie comportant le message et le bouton pour éventuellement s'opposer -->\n<div id=\"cookie-banner\" class=\"cookie-banner\">\n    Ce site utilise Google Analytics. En continuant à naviguer, vous nous autorisez à déposer un cookie à des fins de mesure d'audience.\n    <button id=\"cookie-more-button\" name=\"cookie-more\">En savoir plus ou s'opposer</button>\n</div>\n\n<!-- Boite de dialogue comportant une description détaillée et deux boutons (confirmation, rejet) -->\n<div id=\"cookie-inform-and-ask\" class=\"cookie-inform-and-ask\">\n    <div class=\"cookie-dialog\">\n        <h1>Les cookies Google Analytics</h1>\n        <p>Ce site utilise des cookies de Google Analytics. Ces cookies nous aident à identifier le contenu qui vous intéresse le plus ainsi qu'à repérer certains dysfonctionnements. Vos données de navigations sur ce site sont envoyées à Google Inc.</p>\n        <div>\n          <button id=\"ga-cancel-button\" name=\"ga-cancel\">S'opposer</button>\n          <button id=\"ga-confirm-button\" name=\"ga-confirm\">Accepter</button>\n        </div>\n    </div>\n</div>\n```\n\n```scss\n// Le bandeau cookie\n.cookie-banner {\n  display: none;\n  position: fixed;\n  top: 0;\n  width: 100%;\n\n  &.active {\n    display: block;\n  }\n}\n\n// Overlay de la boite de dialogue\n.cookie-inform-and-ask {\n  background-color: $semi-transparent-black;\n  display: none;\n  height: 100%;\n  left: 0;\n  position: fixed;\n  top: 0;\n  width: 100%;\n\n  &.active {\n    display: block;\n  }\n\n  // La vraie boîte de dialogue\n  .cookie-dialog {\n    left: 50%;\n    position: absolute;\n    top: 50%;\n    transform: translate(-50%, -50%);\n    width: 70%;\n  }\n}\n```\n\n### Le JavaScript\n\nLe code utilisé est du JavaScript natif. La seule librairie utilisée est [JS-Cookie](https://github.com/js-cookie/js-cookie){:rel=\"nofollow\"} qui nous permet de faciliter la manipulation des cookies.\nLe but du code sera triple :\n- Gérer les choix et actions utilisateurs\n- Gérer les cookies (création, suppression, vérification)\n- Gérer la fonctionnalité _[doNotTrack](https://fr.wikipedia.org/wiki/Do_Not_Track){:rel=\"nofollow\"}_ des navigateurs\n\nNous créons d'abord une fonction spécifique pour démarrer Google Analytics. C'est le code basique fourni par Google sur sa [documentation](https://developers.google.com/analytics/devguides/collection/analyticsjs/){:rel=\"nofollow\"} :\n```js\nfunction startGoogleAnalytics() {\n  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){\n  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),\n  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)\n  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');\n\n  ga('create', 'UA-XXXXX-Y', 'auto');\n  ga('send', 'pageview');\n}\n```\n\nReprenons les éléments DOM correspondant au HTML que nous avons créé ci-dessus. Retenez-bien le nom des constantes, elles seront utilisées tout au long des prochaines fonctions :\n```js\nconst cookieBanner = document.getElementById('cookie-banner');\nconst cookieInformAndAsk = document.getElementById('cookie-inform-and-ask');\nconst cookieMoreButton = document.getElementById('cookie-more-button');\nconst gaCancelButton = document.getElementById('ga-cancel-button');\nconst gaConfirmButton = document.getElementById('ga-confirm-button');\n```\n\nLa stratégie sera la suivante :\n```js\nfunction processCookieConsent() {\n  // 1. On récupère l'éventuel cookie indiquant le choix passé de l'utilisateur\n  const consentCookie = Cookies.getJSON('hasConsent');\n  // 2. On récupère la valeur \"doNotTrack\" du navigateur\n  const doNotTrack = navigator.doNotTrack || navigator.msDoNotTrack;\n\n  // 3. Si le cookie existe et qu'il vaut explicitement \"false\" ou que le \"doNotTrack\" est défini à \"OUI\"\n  //    l'utilisateur s'oppose à l'utilisation des cookies. On exécute une fonction spécifique pour ce cas.\n  if (doNotTrack === 'yes' || doNotTrack === '1' || consentCookie === false) {\n    reject();\n    return;\n  }\n\n  // 4. Si le cookie existe et qu'il vaut explicitement \"true\", on démarre juste Google Analytics\n  if (consentCookie === true) {\n    startGoogleAnalytics();\n    return;\n  }\n\n  // 5. Si le cookie n'existe pas et que le \"doNotTrack\" est défini à \"NON\", on crée le cookie \"hasConsent\" avec pour\n  //    valeur \"true\" pour une durée de 13 mois (la durée maximum autorisée) puis on démarre Google Analytics\n  if (doNotTrack === 'no' || doNotTrack === '0') {\n    Cookies.set('hasConsent', true, { expires: 395 });\n    startGoogleAnalytics();\n    return;\n  }\n\n  // 6. Si le cookie n'existe pas et que le \"doNotTrack\" n'est pas défini, alors on affiche le bandeau et on crée les listeners\n  cookieBanner.classList.add('active');\n  cookieMoreButton.addEventListener('click', onMoreButtonClick, false);\n  document.addEventListener('click', onDocumentClick, false);\n}\n```\n\nLorsque l'utilisateur a décidé de s'opposer à l'utilisation des cookies, il faut... poser des cookies...\n\n![Ironic]({{site.baseurl}}/assets/2018-01-17-cookie-banner/ironic.jpg){:class=\"center-image\"}\n\nLe but est d'enregistrer le choix de l'utilisateur pendant la durée maximum légale (13 mois).\nDans cette fonction, on créera aussi des cookies spécifiques à Google Analytics pour l'empêcher de fonctionner (voir la [documentation](https://developers.google.com/analytics/devguides/collection/analyticsjs/user-opt-out){:rel=\"nofollow\"}).\nOn créera donc la fonction suivante (utilisée dans le workflow ci-dessus) :\n```js\nconst GA_PROPERTY = 'UA-XXXXX-Y'\nconst GA_COOKIE_NAMES = ['__utma', '__utmb', '__utmc', '__utmz', '_ga', '_gat'];\n\nfunction reject() {\n  // création du cookie spécifique empêchant Google Analytics de démarrer\n  Cookies.set(`ga-disable-${GA_PROPERTY}`, true, { expires: 395 });\n  // insertion de cette valeur dans l'objet window\n  window[`ga-disable-${GA_PROPERTY}`] = true;\n\n  // création du cookie précisant le choix utilisateur\n  Cookies.set('hasConsent', false, { expires: 395 });\n\n  // suppression de tous les cookies précédemment créés par Google Analytics\n  GA_COOKIE_NAMES.forEach(cookieName => Cookies.remove(cookieName));\n}\n```\nLa dernière étape est de créer les handlers pour les différents listeners :\n\n- Lorsque l'utilisateur clique n'importe où sur la page\n```js\nfunction onDocumentClick(event) {\n  const target = event.target;\n\n  // Si l'utilisateur a cliqué sur le bandeau ou le bouton dans ce dernier alors on ne fait rien.\n  if (target.id === 'cookie-banner'\n    || target.parentNode.id === 'cookie-banner'\n    || target.parentNode.parentNode.id === 'cookie-banner'\n    || target.id === 'cookie-more-button') {\n    return;\n  }\n\n  event.preventDefault();\n\n  // On crée le cookie signifiant le consentement de l'utilisateur et on démarre Google Analytics\n  Cookies.set('hasConsent', true, { expires: 365 });\n  startGoogleAnalytics();\n\n  // On cache le bandeau\n  cookieBanner.className = cookieBanner.className.replace('active', '').trim();\n\n  // On supprime le listener sur la page et celui sur le bouton du bandeau\n  document.removeEventListener('click', onDocumentClick, false);\n  cookieMoreButton.removeEventListener('click', onMoreButtonClick, false);\n}\n```\n- Lorsque l'utilisateur sur le bouton \"En savoir plus ou s'opposer\" du bandeau\n```js\nfunction onMoreButtonClick(event) {\n  event.preventDefault();\n\n  // On affiche la boîte de dialogue permettant à l'utilisateur de faire son choix\n  cookieInformAndAsk.classList.add('active');\n\n  // On cache le bandeau\n  cookieBanner.className = cookieBanner.className.replace('active', '').trim();\n\n  // On crée les listeners sur les boutons de la boîte de dialogue\n  gaCancelButton.addEventListener('click', onGaCancelButtonClick, false);\n  gaConfirmButton.addEventListener('click', onGaConfirmButtonClick, false);\n\n  // On supprime le listener sur la page et celui sur le bouton du bandeau\n  document.removeEventListener('click', onDocumentClick, false);\n  cookieMoreButton.removeEventListener('click', onMoreButtonClick, false);\n}\n```\n- Lorsque l'utilisateur accepte l'utilisation des cookies sur la boîte de dialogue\n```js\nfunction onGaConfirmButtonClick(event) {\n  event.preventDefault();\n\n  // On crée le cookie signifiant le consentement de l'utilisateur et on démarre Google Analytics\n  Cookies.set('hasConsent', true, { expires: 365 });\n  startGoogleAnalytics();\n\n  // On cache la boîte de dialogue\n  cookieInformAndAsk.className = cookieBanner.className.replace('active', '').trim();\n\n  // On supprime les listeners sur les boutons de la boîte de dialogue\n  gaCancelButton.removeEventListener('click', onGaCancelButtonClick, false);\n  gaConfirmButton.removeEventListener('click', onGaConfirmButtonClick, false);\n}\n```\n- Lorsque l'utilisateur refuse l'utilisation des cookies sur la boîte de dialogue\n```js\nfunction onGaCancelButtonClick(event) {\n  event.preventDefault();\n\n  // On lance la procédure de refus de l'utilisation des cookies\n  reject();\n\n  // On cache la boîte de dialogue\n  cookieInformAndAsk.className = cookieBanner.className.replace('active', '').trim();\n\n  // On supprime les listeners sur les boutons de la boîte de dialogue\n  gaCancelButton.removeEventListener('click', onGaCancelButtonClick, false);\n  gaConfirmButton.removeEventListener('click', onGaConfirmButtonClick, false);\n}\n```\n\n## Vers la RGPD\n\nSi vous avez bien suivi cet article et si vous l'avez adapté aux besoins de votre site, vous avez maintenant un bandeau cookie parfaitement fonctionnel et respectant les recommandations de la CNIL !\nÉvidemment un site comme celui-ci (un simple blog) est un cas simple où il y a peu voire pas de cookies posés du tout. En réalité, votre site est déjà quasiment prêt pour la future mise en application de la RGPD à quelques ajustements près.\nSi vous ne savez pas ce qu'est la RGPD, c'est en gros une évolution de la directive européenne dont nous avons parlé précédemment vers une version XXL. Pour de plus amples informations, je vous invite à lire l'excellent article de mon collègue [Pouzor](/authors/pouzor/) : [RGPD - Ce qu'il va changer](/fr/rgpd-ce-qu-il-va-changer/).\n\n![Cookie Monster]({{site.baseurl}}/assets/2018-01-17-cookie-banner/cookie-monster.jpg){:class=\"center-image\"}\n"}