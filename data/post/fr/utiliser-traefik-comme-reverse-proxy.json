{"date":"2021-10-20T00:00:00.000Z","title":"Utiliser traefik comme reverse proxy","excerpt":"Besoin d’exposer facilement des sites et applications web sur Internet avec un certificat SSL valide ? C’est ici :)","readingTime":"11mn","authors":["jmoati"],"categories":["architecture"],"content":"\n![Cover](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/cover.jpg)\n\n## Introduction\n\nJ'ai à la maison un nas, un Raspberry pi sous Octopi, un serveur sous Debian, bref, une multitude d'objets communiquants qui délivrent des sites et des applications mais qui ne sont pas facilement accessibles à l'extérieur de chez moi, et encore moins par le biais d'une connexion sécurisée.\n\nPour rendre tout ce joli monde accessible avec la seule IP publique dont je dispose, il me sera nécessaire d'utiliser un système de reverse proxy.\n\nMais c’est quoi au fait un reverse proxy ?\n\n> Un **proxy inverse** (_reverse proxy_) est un type de [serveur](https://fr.wikipedia.org/wiki/Serveur_informatique \"Serveur informatique\"), habituellement placé en [frontal](https://fr.wikipedia.org/wiki/Frontal_(serveur) \"Frontal (serveur)\") de [serveurs web](https://fr.wikipedia.org/wiki/Serveur_web \"Serveur web\"). Contrairement au serveur [proxy](https://fr.wikipedia.org/wiki/Proxy \"Proxy\") qui permet à un utilisateur d'accéder au réseau [Internet](https://fr.wikipedia.org/wiki/Internet \"Internet\"), le proxy inverse permet à un utilisateur d'Internet d'accéder à des serveurs internes. Une des applications courantes du proxy inverse est la [répartition de charge](https://fr.wikipedia.org/wiki/R%C3%A9partition_de_charge \"Répartition de charge\") (load-balancing).\n>\n> Wikipedia\n\n\nIl existe beaucoup de solutions de reverse proxy sur le marché mais nous allons nous focaliser sur celle de traefik qui nous permettra de :\n - rediriger des requêtes HTTP ou TCP à un autre serveur\n - faire de l'auto-discovery avec Docker par exemple\n - disposer d'une connexion sécurisée grâce à un certificat let's encrypt\n\nBien sûr pour que tout fonctionne, vous devez disposer d'un nom de domaine (dans mon cas wilson.net) et faire pointer les différentes zones dns sur votre serveur.\n\n![Mes zones dns](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/11-zones.jpg)\n\nSinon vous pouvez aussi simuler un nom de domaine dans votre fichier `/etc/hosts` mais dans ce cas la génération d'un certificat SSL ne sera pas possible.\n\nJe vous invite à suivre cet article pour que nous mettions tout cela en place :)\n\n\n## Mise en place de Traefik\n\nPour commencer, vous devez mettre en place Traefik sur un serveur accessible à Internet.\n\nPour moi, ce sera la machine 192.168.0.1 : c'est celle sur laquelle je redirige les ports 80 (HTTP) et 443 (HTTPS) de ma freebox.\n\n![Mes ports dans la freebox](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/01-ports.jpg)\n\nVous pouvez aussi bien installer l'exécutable, compiler le logiciel à partir de ses sources ou bien comme dans notre exemple, le déployer avec une image Docker.\n\nNous allons utiliser docker-compose pour ne pas avoir à retaper toujours la commande et pouvoir l'agrémenter au fil du temps de nouveaux éléments de configuration.\n\nCréons donc notre premier fichier `/srv/docker-compose.yaml`:\n``` yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n```\n\nSi, pour une raison ou une autre, notre serveur doit redémarrer, `restart: always` nous permettra d’avoir notre service reverse-proxy qui se relancera automatiquement tout seul.\n\nDans la partie `ports` nous rendons accessibles nos ports du service *reverse-proxy* à l'extérieur de celui-ci.\n\nDans la partie `volume` nous partageons des fichiers et/ou des répertoires avec notre service.\n\nC'est bien beau de partager le fichier `/srv/traefik.toml` avec notre container, mais il faudrait peut-être le créer, non ?\n\nNous allons donc créer le fichier de configuration de traefik qui déclarera à minima les deux endpoints précédents dans un fichier `/srv/traefik.toml`\n\n``` toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n```\n\nNous pouvons ensuite lancer notre service de reverse proxy en nous trouvant dans le répertoire `/srv` avec la commande :\n\n``` shell\ndocker-compose up -d\n```\n\n![Démarrage de traefik avec docker-compose](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/02-docker-compose-up.jpg)\n\nBien sûr si on visite la page de notre serveur, on obtient pour le moment une petite 404, mais c'est déjà la preuve qu'il est là et qu'il n'attend plus que de nous servir un contenu.\n\n![Traefik renvoie une 404](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/03-nothing-for-the-moment.jpg)\n\n## Configurer le tableau de bord\n\nNous avons pu voir que notre reverse-proxy traefik tourne mais il n'a rien à afficher pour le moment.\n\nNous allons lui ajouter le tableau de bord ce qui nous permettra de savoir si nos services, endpoints et règles de routages sont correctement prises en compte par traefik.\n\nNous allons tout d'abord ajouter `[api]` pour activer le dashboard et l'api ainsi que `[providers.docker]` pour activer le support de Docker et des labels.\n\nTraefik a besoin de connaître le chemin vers le socket de Docker afin d'activer son provider.\n\nNotre fichier de configuration `/srv/traefik.toml` devrait maintenant ressembler à cela :\n\n``` toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n\n[api]\n\n[providers.docker]\n  endpoint = \"unix:///var/run/docker.sock\"\n```\n\nNous allons devoir générer un mot de passe afin d'accéder au tableau de bord pour qu'il ne soit pas accessible à n'importe qui.\n\nCela se fait avec htpasswd.\n\nComme nous ne voulons pas l'installer sur notre belle machine, nous allons faire appel à une image Docker de apache pour hasher notre mot de passe :\n\n``` shell\ndocker run --rm --name apache httpd:alpine htpasswd -nb wilson schizo\n```\n\n![Génération du mot de passe](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/04-password.jpg)\n\nDans cet exemple, *wilson* est mon login tandis que *schizo* sera mon mot de passe.\n\nLe résultat est donné sous la forme : `wilson:$apr1$1eZu7RXg$Ql9Z5AvZNc0Oe4In900mi0`\n\nUne fois le mot de passe hashé en notre possession, nous allons ajouter un middleware basicauth qui sera en charge de sécuriser l'accès à la page avec la demande du mot de passe avec `traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0`.\n\nDéfinir le endpoint (http) avec `traefik.http.routers.api.entrypoints=http`.\n\nDire que l'on veut faire appel au service *api* qui est mis à disposition par le provider *internal* : `traefik.http.routers.api.service=api@internal`\n\nIl ne nous reste donc plus qu'à adapter le fichier `/srv/docker-compose.yaml` qui devrait nous donner :\n\n```yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n```\n\nJe souhaite attirer votre attention sur le fait que j'ai dû doubler les `$` pour échapper le caractère `$` qui cherche à faire appel à une variable.\n\nIl est important de garder la cohérence des noms entre les routers et les middlewares.\n\nLà, le nom de ma règle est api, vous pouvez mettre ce que vous désirez du moment que vous ne l'utilisez pas pour un autre service et que le nom est le même partout.\n\nOn peut maintenant demander à notre service de prendre en compte les modifications en nous trouvant dans le répertoire `/srv` et en exécutant une nouvelle fois la commande :\n\n``` shell\ndocker-compose up -d\n```\n\nVoici ce que j'obtiens quand j'accède à l'url définie dans ma règle de routage plus haut :\n\n![Dashboard](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/05-dashboard.jpg)\n\n\n## Reverse proxy d'un site accessible sur le réseau local\n\nJ'ai sur mon réseau mon nas, que je souhaiterais rendre accessible de l'extérieur.\n\n![Mon nas synology](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/06-nas-http.jpg)\n\nIl va falloir le déclarer par le provider `file` car il ne peut pas être découvert automatiquement comme avec Docker.\n\nNous allons donc créer pour cela un fichier `/srv/services.toml` :\n\n```toml\n[http]\n  [http.services]\n    [http.services.nas]\n      [http.services.nas.loadBalancer]\n        [[http.services.nas.loadBalancer.servers]]\n          url = \"http://192.168.0.11:5000/\"\n```\n\nMon nas a ici comme ip `192.168.0.11` et attend des requêtes http sur le port 5000.\n\nJe vais ajouter le provider file dans mon fichier `/srv/traefik.toml` afin de charger ce fichier de services :\n\n```toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n\n[api]\n\n[providers.docker]\n  endpoint = \"unix:///var/run/docker.sock\"\n\n[providers.file]\n  filename = \"/etc/traefik/services.toml\"\n```\n\nComme vous pouvez le constater, le container cherchera le fichier dans son répertoire `/etc/traefik`, toutefois, nous le mettrons dans `/srv`.\n\nNous allons définir ces règles de routages dans `/srv/docker-compose.yaml` sous forme de labels :\n\n```yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /srv/services.toml:/etc/traefik/services.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n\n    - \"traefik.http.routers.nas.entrypoints=http\"\n    - \"traefik.http.routers.nas.rule=Host(`nas.wilson.net`)\"\n    - \"traefik.http.routers.nas.service=nas@file\"\n```\n\nVous l'avez sûrement déjà compris mais le nom du service est toujours sous la forme [nom du service]@[provider].\n\n`rule` me permet de définir quelle route me permet d'accéder à mon service. Ici, je matche uniquement sur le nom de domaine qui doit être `nas.wilson.net`.\n\nN'oublions pas de demander à docker-compose de prendre notre nouvelle configuration en compte :\n\n``` shell\ndocker-compose up -d\n```\n\nVoilà, quand j'accède maintenant à mon nas par le host déclaré plus haut j'ai cela :\n\n![Mon nas synology reversed](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/07-nas-reversed.jpg)\n\n\n## Génération d'un certificat SSL\n\n\nNous pouvons très facilement générer des certificats SSL avec let's encrypt qui seront automatiquement renouvelés et cela gratuitement.\n\nVous n'avez donc plus aucune excuse maintenant pour ne pas passer à HTTP2 et sécuriser les données de vos utilisateurs.\n\nPour générer un certificat let's encrypt, il me faut créer et rendre accessible à traefik un fichier `/srv/acme.json` afin qu'il puisse y conserver les différents certificats :\n\n```shell\n touch /srv/acme.json\n ```\n\npuis ajouter le fichier dans la partie volume : `/srv/acme.json:/acme.json` de votre fichier `/srv/docker-compose.yaml`\n\nDans `/srv/traefik.toml`, je déclare un certificatesResolver qui me permettra d'obtenir des certificats avec :\n\n```toml\n[certificatesResolvers.wilson.acme]\n  email = \"VOTRE@MAIL.COM\"\n  storage = \"acme.json\"\n  [certificatesResolvers.wilson.acme.httpChallenge]\n    entryPoint = \"http\"\n```\n\nCe qui me donnera comme fichier `/srv/traefik.toml` :\n\n```toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n\n[api]\n\n[providers.docker]\n  endpoint = \"unix:///var/run/docker.sock\"\n\n[providers.file]\n  filename = \"/etc/traefik/services.toml\"\n\n[certificatesResolvers.wilson.acme]\n  email = \"VOTRE@MAIL.COM\"\n  storage = \"acme.json\"\n  [certificatesResolvers.wilson.acme.httpChallenge]\n    entryPoint = \"http\"\n```\n\nAttention, votre email doit être obligatoirement renseigné.\n\nDans `/srv/docker-compose.yaml` il nous reste à ajouter des labels pour faire le certificat SSL de mon nas ce qui donnera :\n\n```yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /srv/services.toml:/etc/traefik/services.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n\n    - \"traefik.http.routers.nas.entrypoints=https,http\"\n    - \"traefik.http.routers.nas.rule=Host(`nas.wilson.net`)\"\n    - \"traefik.http.routers.nas.service=nas@file\"\n    - \"traefik.http.routers.nas.tls=true\"\n    - \"traefik.http.routers.nas.tls.certresolver=wilson\"\n```\n\n`entrypoints` indique que je souhaite un accès https, sinon, http.\n\n`tls`, que je souhaite utiliser un certificat SSL.\n\n`tls.certresolver` quel certresolver je devrais utiliser.\n\nN'oublions pas de demander à docker-compose de prendre notre nouvelle configuration en compte :\n\n``` shell\ndocker-compose up -d\n```\n\nUne fois ceci fait, j'ai un accès à mon nas sécurisé par HTTPS :D\n\n![Mon nas synology https](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/08-nas-https.jpg)\n\nEt puis bien sûr, je peux le voir aussi dans mon dashboard traefik :\n\n![Mon nas synology dashboard](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/09-traefik-dashboard-nas.jpg)\n\n## Reverse proxy de services tournants sous Docker\n\nMaintenant que nous savons écrire les différentes règles de routage pour un service ainsi que générer un certificat SSL, il va nous être enfantin de faire la même chose pour un service Docker.\n\nAprès avoir lu l'article [DOMOTISER SON ESPACE DE TRAVAIL](https://blog.eleven-labs.com/fr/domotize-your-workspace/), j'ai voulu mettre en place Home Assistant à la maison.\n\nHome Assistant peut être mis en place avec un container Docker, nous allons donc ajouter les lignes dans notre fichier `/srv/docker-compose.yml` qui devrait maintenant ressembler à cela :\n\n```yaml\nversion: '3'\n\nservices:\n  home-assistant:\n    restart: always\n    image: homeassistant/home-assistant\n    volumes:\n    - /srv/docker/home-assistant:/config\n    labels:\n    - \"traefik.enable=true\"\n    - \"traefik.http.routers.home.rule=Host(`home.wilson.net`)\"\n    - \"traefik.http.routers.home.entrypoints=https,http\"\n    - \"traefik.http.routers.home.tls=true\"\n    - \"traefik.http.routers.home.tls.certresolver=wilson\"\n    - \"traefik.http.services.home.loadbalancer.server.port=8123\"\n\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /srv/services.toml:/etc/traefik/services.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n\n    - \"traefik.http.routers.nas.entrypoints=https,http\"\n    - \"traefik.http.routers.nas.rule=Host(`nas.wilson.net`)\"\n    - \"traefik.http.routers.nas.service=nas@file\"\n    - \"traefik.http.routers.nas.tls=true\"\n    - \"traefik.http.routers.nas.tls.certresolver=wilson\"\n```\n\n`traefik.enable=true` active le reverse proxy pour le service et permet donc de le rendre accessible par intenet.\n\n`traefik.http.routers.home.entrypoints=https,http` active le endpoint https puis le http sinon.\n\n`traefik.http.routers.home.tls=true` indique que je souhaite un certificat SSL.\n\n`traefik.http.routers.home.tls.certresolver=wilson` indique que je souhaite utiliser certresolver *wilson* pour générer mon certificat.\n\n`traefik.http.services.home.loadbalancer.server.port=8123` indique que le port à exposer de mon service est le 8123.\n\nN'oublions pas de demander à docker-compose de prendre notre nouvelle configuration en compte :\n\n``` shell\ndocker-compose up -d\n```\n\nNous pouvons maintenant utiliser Home Assistant, et ce directement en https ;)\n\n![Home Assistant](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/10-home-assistant.jpg)\n\nJ'espère que vous avez apprécié cet article et que vous allez prendre beaucoup de plaisir à jouer avec traefik.\n\nÀ bientôt /o/\n\n"}