{"date":"2018-07-11T00:00:00.000Z","title":"Présentation de la librairie PHP Xpression","excerpt":"En tant que développeur nous avons tous déjà eu besoin de filtrer un jeu de donnés (array, collection, API etc...). Nous allons découvrir la librairie Xpression qui va nous permettre de filtrer différents contenus avec une syntaxe simplifiée.","readingTime":"14mn","authors":["amoutte"],"categories":["php"],"content":"\n## Présentation de Xpression\n\n[**Xpression**](https://github.com/Symftony/Xpression) est un parser qui convertit une expression textuelle ([DSL](https://fr.wikipedia.org/wiki/Langage_d%C3%A9di%C3%A9)) en une expression logicielle (**pattern spécification**).\nNous allons voir ce que permet de faire la librairie et comment l'utiliser.\n\n## La syntaxe\n\nVoici plusieurs exemples d'expressions que nous pouvons écrire :\n\nL'âge doit être égal à `26`.\n\n\n```\nage=26\n```\n\n\nL'âge doit être supérieur à `20` (inclus) et inférieur à `30` (exclus).\n\n\n```\nage≥20&age<30\n```\n\n\nVoici la liste des opérateurs supportés par les différents bridges :\n\nOpérateur | Syntaxes | Exemples | ORM | ODM | ArrayCollection | Closure |\n-------- | ------ | ------- | --- | --- | --------------- | ------- |\négal | `=` | `param=value` | X | X | X | X |\ndifférent de | `!=` `≠` | `param!=value` `param≠value` | X | X | X | X |\nplus grand que | `>` | `param>value` | X | X | X | X |\nplus grand ou égal | `>=` `≥` | `param>=value` `param≥value` | X | X | X | X |\nplus petit que | `<` | `param<value` | X | X | X | X |\nplus petit ou égal | `<=` `≤` | `param<=value` `param≤value` | X | X | X | X |\ndans | `[` `]` | `param[value1,value2]` | X | X | X | X |\ncontient | `{{` `}}` | `param{{value}}` | X | X |  | X |\nne contient pas | `!{{` `}}` | `param!{{value}}` | X | X |  | X |\net | `&` | `param>1&param<10` | X | X | X | X |\nnon et | `!&` | `param>1!&param<10` |  | X |  | X |\nou | <code>&#124;</code> | <code>param>1&#124;param<10</code> | X | X | X | X |\nnon ou | <code>!&#124;</code> | <code>param>1!&#124;param<10</code> |  |  |  | X |\nou exclusif | <code>^&#124;</code> `⊕` | <code>param>1^&#124;param<10</code> `param>1⊕param<10` |  |  |  | X |\n\n> Eh oui, la librairie fournit aussi des bridges vers doctrine `ORM`, `ODM` et `common` (pour filter les collections).\n\n#### Précédence des opérateurs de composition\n\nIl faut faire attention à la priorité des opérateurs de compositions (`&`, `!&`, `|`, `!|`, `⊕`).\nLes grandes priorités sont prises en compte en premier.\n\n- `et`: 15\n- `non et`: 14\n- `ou`: 10\n- `ou exclusif`: 9\n- `not or`: 8\n\nPour gérer correctement vos expressions vous pouvez utiliser les parenthèses `(` `)`.\n\nPar exemple, cette expression sélectionnera les `Raccoon` ou les `Schizo` qui ont plus de 100 points.\n\n`planet='Raccoon'|name='Schizo'&point>100` est identique à `planet='Raccoon'|(name='Schizo'&point>100)`\n\nAlors que l'expression suivante sélectionnera les astronautes `Raccoon` qui ont plus de 100 points ou les `Schizo` qui on plus de 100 points.\n\n`(planet='Raccoon'|name='Schizo')&point>100`\n\n## Utilisation\n\nNous allons maintenant voir dans quels cas nous pourrions utiliser cette librairie.\n\n### Spécification\n\nAfin d'avoir une spécification nous allons utiliser la classe `ClosureExpressionBuilder`.\nEn effet cette classe fabrique une callback qui peut être utilisée comme une spécification.\n\n\n```php\n<?php\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// classe avec des getter\nclass Astronaut {\n    private $name;\n    private $planet;\n    private $points;\n    private $rank;\n\n    public function __construct($name, $planet, $points, $rank)\n    {\n        $this->name = $name;\n        $this->planet = $planet;\n        $this->points = $points;\n        $this->rank = $rank;\n    }\n\n    public function getName()\n    {\n        return $this->name;\n    }\n\n    public function getPlanet()\n    {\n        return $this->planet;\n    }\n\n    public function getPoints()\n    {\n        return $this->points;\n    }\n\n    public function getRank()\n    {\n        return $this->rank;\n    }\n}\n\n// objet avec des propriétés publiques\n$astronaut1 = new \\stdClass();\n$astronaut1->name = 'Mehdy';\n$astronaut1->planet = 'Raccoons of Asgard';\n$astronaut1->points = 675;\n$astronaut1->rank = 'Captain';\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n$parser = new Parser(new ClosureExpressionBuilder());\n$specification = $parser->parse($query);\n\n$specification(['name' => 'Arnaud', 'planet' => 'Duck Invaders', 'points' => 785, 'rank' => 'Fleet Captain']); // false\n$specification($astronaut1);// true\n$specification(new Astronaut('Ilan', 'Donut Factory', 1325, 'Commodore')); // true\n```\n\n\nComme vous pouvez le voir, la spécification est appelable avec un array associatif, des objets avec des attributs publics mais aussi avec des objets qui ont des getters.\n\n### Filtrer un jeu de donnés\n\nNous allons dans un premier temps filtrer un tableau de données.\nPour ce faire nous allons encore utiliser `ClosureExpressionBuilder`\n\nNous allons utiliser ces données pour les exemples suivants :\n\n\n```php\n<?php\n$astronauts = [\n    ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n    ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n    ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n    ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n    ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n    ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n    ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n    ['name' => 'Noel', 'planet' => 'Duck Invaders', 'points' => 960, 'rank' => 'Fleet Captain'],\n    ['name' => 'Damien', 'planet' => 'Donut Factory', 'points' => 925, 'rank' => 'Fleet Captain'],\n    ['name' => 'Quentin', 'planet' => 'Donut Factory', 'points' => 910, 'rank' => 'Fleet Captain'],\n    ['name' => 'Martin', 'planet' => 'Schizo Cats', 'points' => 860, 'rank' => 'Fleet Captain'],\n    ['name' => 'Carl', 'planet' => 'Donut Factory', 'points' => 800, 'rank' => 'Fleet Captain'],\n    ['name' => 'Arnaud', 'planet' => 'Duck Invaders', 'points' => 785, 'rank' => 'Fleet Captain'],\n    ['name' => 'Alexandre', 'planet' => 'Donut Factory', 'points' => 785, 'rank' => 'Fleet Captain'],\n    ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n    ['name' => 'Romain', 'planet' => 'Donut Factory', 'points' => 735, 'rank' => 'Captain'],\n    ['name' => 'Julie', 'planet' => 'Donut Factory', 'points' => 735, 'rank' => 'Captain'],\n    ['name' => 'Cedric', 'planet' => 'Donut Factory', 'points' => 700, 'rank' => 'Captain'],\n    ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n    ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n];\n```\n\n\nJe veux récupérer les astronautes dont la planète contient 'Raccoons'.\n\n\n```php\n<?php\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// jeu de données\n$astronauts = [...];\n\n$query = 'planet{{Raccoons}}';\n\n$parser = new Parser(new ClosureExpressionBuilder());\n$expression = $parser->parse($query);\n\n$filteredAstronauts = array_filter($astronauts, $expression);\n// le tableau ne contient que les astronautes dont la planète contient 'Raccoons'\n// $filteredAstronauts = [\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n> La subtilité dans l'exemple précédent c'est que l'on utilise `$expression` dans un `array_filter`.\n\nMaintenant je veux sélectionner les astronautes qui ont plus de 1000 points mais aussi les `Raccoons`.\n\n\n```php\n<?php\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// jeu de données\n$astronauts = [...];\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n$parser = new Parser(new ClosureExpressionBuilder());\n$expression = $parser->parse($query);\n\n$filteredAstronauts = array_filter($astronauts, $expression);\n// le tableau contient tous les astronautes qui ont au moins 1000 points, mais aussi les 'Raccoons'\n// $filteredAstronauts = [\n//     ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n//     ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n//     ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n//     ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n//     ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n### Filtrer une ArrayCollection\n\nPour filtrer une ArrayCollection il suffit d'utiliser le bridge `Symftony\\Xpression\\Bridge\\Doctrine\\Common\\ExpressionBuilderAdapter`.\n\n\n```php\n<?php\nuse Doctrine\\Common\\Collections\\ArrayCollection;\nuse Doctrine\\Common\\Collections\\Criteria;\nuse Doctrine\\Common\\Collections\\ExpressionBuilder;\nuse Symftony\\Xpression\\Bridge\\Doctrine\\Common\\ExpressionBuilderAdapter;\nuse Symftony\\Xpression\\Parser;\n\n// jeu de données\n$astronauts = [...];\n\n// on wrap l'array dans une `ArrayCollection`\n$astronauts = new ArrayCollection($astronauts);\n\n$parser = new Parser(new ExpressionBuilderAdapter(new ExpressionBuilder()));\n$expression = $parser->parse($query);\n$filteredAstronauts = $astronauts->matching(new Criteria($expression));\n```\n\n\n> ℹ️ Les `ArrayCollection` sont les objets utilisés par doctrine pour les relations (oneToMany, manyToMany etc...).\n\n> Pour filtrer une `Collection` vous pouvez utiliser `ClosureExpressionBuilder` vu précédemment et l'injecter dans `Collection::filter(Closure $p)`.\n\n### Filtrer des données stockées en base\n\n#### Doctrine ODM\n\nBien, maintenant imaginons que ces données soient dans une base de données MongoDB.\n\n> Accrochez-vous, ça va être compliqué !\n\n\n```php\n<?php\nuse Doctrine\\Common\\EventManager;\nuse Doctrine\\MongoDB\\Connection;\nuse Doctrine\\MongoDB\\Database;\nuse Symftony\\Xpression\\Bridge\\Doctrine\\MongoDb\\ExprBuilder;\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// Initialisation de la connexion\n$connection = new Connection('mongodb://localhost');\n$database = $connection->selectDatabase('eleven-labs');\n$collection = $database->selectCollection('astronauts');\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n$parser = new Parser(new ExprBuilder());\n$queryBuilder = $parser->parse($query);\n$astronauts = $collection->createQueryBuilder()->setQueryArray($queryBuilder->getQuery())->getQuery()->execute();\n// $astronauts est un Doctrine\\MongoDB\\Cursor\n// iterator_to_array($astronauts) = [\n//     ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n//     ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n//     ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n//     ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n//     ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n> Ha bah non ! C'est super simple en fait\n\n#### Doctrine ORM\n\nEt pour doctrine/orm alors ?\n\n\n```php\n<?php\nuse Doctrine\\ORM\\Tools\\Setup;\nuse Symftony\\Xpression\\Bridge\\Doctrine\\ORM\\ExprAdapter;\nuse Symftony\\Xpression\\Expr\\MapperExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// dans cet exemple j'utilise l'annotation reader pour la configuration de mon schéma\n$config = Setup::createAnnotationMetadataConfiguration(array(__DIR__ . \"/Orm/Entity\"), true, null, null, false);\n$entityManager = EntityManager::create(array(\n    // votre configuration d'accès à votre base de donnés\n    'driver' => 'pdo_sqlite',\n    'path' => __DIR__ . '/ORM/astronauts.sqlite',\n), $config);\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n// utilisation de MapperExpressionBuilder pour ajouter dynamiquement l'alias `a` aux champs de la query\n$parser = new Parser(new MapperExpressionBuilder(new ExprAdapter(new Expr()), ['*' => 'a.%s']));\n$expression = $parser->parse($query);\n$qb = $entityManager->getRepository('Example\\Orm\\Entity\\Product')->createQueryBuilder('a');\n$astronauts = $qb->where($expression)->getQuery()->execute();\n// $astronauts = [\n//     ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n//     ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n//     ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n//     ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n//     ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n⚠️ Lorsque l'on crée un queryBuilder avec l'ORM il faut spécifier un alias `EntityRepository::createQueryBuilder($alias)`. C'est pourquoi il ne reconnait pas le champ `planet` dans la query.\n\nLa première solution serait d'écrire les champs avec l'alias dans la query initiale ce qui donnerait `a.planet{{Raccoons}}|a.points≥1000`. Le problème de cet approche c'est que des informations de structure de base de données leakent dans la query.\n\nLa seconde solution est d'utiliser la classe `MapperExpressionBuilder`. En effet cette classe va décorer l'`ExpressionBuilder` pour ajouter les alias directement au moment où le queryBuilder va être configuré.\n\nDans l'exemple suivant on indique que tous les champs (`*`) de la query sont préfixés avec `a.`.\n\n\n```php\n$parser = new Parser(\n    new MapperExpressionBuilder(\n        new ExprAdapter(new Expr()),\n        ['*' => 'a.%s']\n    )\n);\n```\n\n\n### Filtrer un endpoint d'API\n\nActuellement si vous voulez filtrer votre API vous pouvez :\n\n - utiliser GraphQL.\n\n> Ce n'est pas la solution la plus légère à implementer. N'est pas forcément adaptée pour faire uniquement du filtrage de données.\n\n - récupérer les paramètres de requête manuellement et fabriquer votre query avec tous un tas de condition\n\n> la syntaxe http des paramètres n'est pas lisible et peut devenir très lourde pour des requêtes complexes.\n\nBonne nouvelle ! Si votre API utilise une des sources de données vu précédemment, vous pouvez filtrer les données à l'aide d'`Xpression`.\n\n> Gardez à l'esprit que Xpression remplit un rôle différent de GraphQL\n\nNous allons voir un exemple d'utilisation du [Bundle Xpression](https://github.com/Symftony/Xpression-Bundle).\n\nInstallez le bundle via `composer require symftony/xpression-bundle` puis ajoutez-le dans symfony (AppKernel.php ou bundle.php).\n\nIl faut également activer la correction de querystring pour que les caractères réservés soient correctement utilisés.\n\n\n```php\n<?php\n// public/index.php ou web/app.php (web/app_dev.php)\n// ...\n\\Symftony\\Xpression\\QueryStringParser::correctServerQueryString(); // ajoutez cette ligne juste avant la création de la Requete\n$request = Request::createFromGlobals();\n// ...\n```\n\n\nPour l'utiliser il vous suffit uniquement d'ajouter l'annotation `@Xpression(expressionBuilder=\"odm\")` au-dessus du controller que vous souhaitez filtrer.\n\n\n```php\n<?php\nnamespace App\\Controller;\n\nuse App\\Document\\Astronaut;\nuse App\\Repository\\AstronautsRepository;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\JsonResponse;\nuse Symftony\\XpressionBundle\\Annotations\\Xpression;\n\nclass AstronautController extends AbstractController\n{\n    /**\n     * @Xpression(expressionBuilder=\"odm\")\n     *\n     * @return JsonResponse\n     */\n    public function list(AstronautsRepository $astronautsRepository, $query = null)\n    {\n        $qb = $astronautsRepository->createQueryBuilder();\n        if (null !== $query) {\n            $qb->setQueryArray($query->getQuery());\n        }\n\n        return $this->json($qb->getQuery()->execute());\n    }\n}\n```\n\n\nVous pouvez également configurer les options suivantes :\n\n - source (la source de la query (request, query, attributes, cookies, files, server, headers default: query))\n - sourceName (le nom du param, dans la source, qui contient l'expression default:query)\n - targetName (le nom de l'argument a injecter dans le controller default:query)\n - expressionBuilder (le nom de l'expressionBuilder à utiliser *requis*)\n\nMaintenant vous pouvez vous rendre sur votre URL et y ajouter votre Xpression dans `query`.\n\n\n\n```\nhttp://localhost/astronauts/list?query={planet{{Raccoons}}|points≥1000}\n```\n\n\n### Mots de la fin\n\nJe vais m'arrêter là pour la présentation de cette librairie PHP.\nJe vous invite à tester la librairie et à y contribuer (idée, bugs, features, documentation, etc).\n\nVoici une petite liste des futures ajouts dans la librairie :\n- fixer l'utilisation des paramètres de query (placeholder).\n- créer d'autre bridges.\n- refacto le coeur de la librairie afin d'être extensible (pouvoir ajouter des syntaxes).\n- implémenter un builder de query en PHP et JS afin de pouvoir créer directement le query textuel.\n\n### Liens utiles\n\n- [Demo Xpression](http://symftony-xpression.herokuapp.com/)\n- [Code source Xpression](https://github.com/Symftony/Xpression)\n- [Code source Xpression-bundle](https://github.com/Symftony/Xpression-Bundle)\n"}