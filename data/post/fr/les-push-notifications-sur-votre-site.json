{"date":"2016-10-27T00:00:00.000Z","title":"Les push notifications sur votre site","excerpt":"L'intérêt d'une PWA, c'est d'agir comme une application mobile, d'être installé sur le téléphone, de gérer le off-line et surtout d'envoyer des push notifications. Les notifications sont un élément essentiel de l'engagement de l'utilisateur, elles permettent de faire un rappel et de communiquer avec nos utilisateurs","readingTime":"9mn","authors":["captainjojo"],"categories":["javascript"],"content":"\nLors d'un article précédent nous avons créé [notre première PWA](https://blog.eleven-labs.com/fr/votre-premiere-pwa/), mais nous n'avons pas été jusqu'au bout du concept. L'intérêt du [PWA](https://blog.eleven-labs.com/fr/progressive-web-apps-au-googledevsummit/){:rel=\"nofollow noreferrer\"}, c'est d'agir comme une application mobile, d'être installé sur le téléphone, de gérer le off-line et surtout d'envoyer des push notifications. Les notifications sont un élément essentiel de l'engagement de l'utilisateur, elles permettent de faire un rappel et de communiquer avec nos utilisateurs. Nous allons donc finaliser le dernier tutoriel en mettant en place un système simple de push notification, en utilisant\n\n[Firebase](https://firebase.google.com/){:rel=\"nofollow noreferrer\"} pour stocker nos tokens utilisateurs.\n\nPour aller plus vite, nous vous invitons à récupérer le projet [https://github.com/CaptainJojo/pwa-parisjs](https://github.com/CaptainJojo/pwa-parisjs){:rel=\"nofollow noreferrer\"} qui contient une PWA prête à l'emploi.\n\n```sh\ngit clone https://github.com/CaptainJojo/pwa-parisjs\ncd pwa-parisjs\ngit checkout manifest\nnpm install\nnpm start\n```\n\nA partir de la vous devez avoir accès à votre PWA à l'adresse suivante [localhost:8080](localhost:8080). Si ce n'est pas fait, vous devez  installer [Lighthouse](https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk){:rel=\"nofollow noreferrer\"}, ce qui vous permettra de valider que vous avez bien une PWA.\nAvant de se lancer dans l'envoi d'une push notification, nous allons passer par la configuration. Et oui ! Ce n'est pas magique, nous allons demander à Google l'autorisation.\nNous allons sur [Firebase](https://console.firebase.google.com/){:rel=\"nofollow noreferrer\"} pour créer un projet.\n\n![Firebase - créer un projet](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-11.19.54.png)\n\nNous vous laissons choisir le nom du projet. Une fois sur le dashboard, vous devez cliquer sur la petite roue puis \"Paramètres du projet\".\n\n![Firebase - parametre du projet](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-11.22.12.png)\n\nDans l'onglet \"Cloud Messaging\" vous trouverez votre bonheur en récupérant l'ID de l'expéditeur.\n\n![Firebase - Cloud messaging](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-11.32.06.png)\n\nDans le manifest.json, disponible dans le dossier public de l'application, vous devez ajouter en fin de fichier le \"gsm_sender_id\" avec comme valeur l'ID de l'expéditeur.\n\n```json\n{\n  \"name\": \"Lemonde\",\n  \"short_name\": \"Lemonde\",\n  \"icons\": [{\n        \"src\": \"images/touch/icon-128x128.png\",\n        \"sizes\": \"128x128\",\n        \"type\": \"image/png\"\n      }, {\n        \"src\": \"images/touch/apple-touch-icon.png\",\n        \"sizes\": \"152x152\",\n        \"type\": \"image/png\"\n      }, {\n        \"src\": \"images/touch/ms-touch-icon-144x144-precomposed.png\",\n        \"sizes\": \"144x144\",\n        \"type\": \"image/png\"\n      }, {\n        \"src\": \"images/touch/chrome-touch-icon-192x192.png\",\n        \"sizes\": \"192x192\",\n        \"type\": \"image/png\"\n      }],\n  \"start_url\": \"/\",\n  \"display\": \"standalone\",\n  \"background_color\": \"#3E4EB8\",\n  \"theme_color\": \"#2F3BA2\",\n  \"gcm_sender_id\": \"262283691358\"\n}\n```\n\nNous allons maintenant demander à l'utilisateur d'accepter les notifications. C'est très simple, il vous faut ajouter dans le fichier public/register.js ce qui suit :\n\n```javascript\nif('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function() {\n      return navigator.serviceWorker.ready;\n    }).then(function(registration) {\n      registration.pushManager.subscribe({userVisibleOnly: true}).then(function(sub) {\n        var endpointSections = sub.endpoint.split('/');\n        var subscriptionId = endpointSections[endpointSections.length - 1];\n        console.log('endpoint:', subscriptionId);\n      });\n    });\n  navigator.serviceWorker.ready.then(function(registration) {\n     console.log('Service Worker Ready');\n  });\n}\n```\n\nNormalement, si vous relancez le serveur, vous devez avoir une demande pour accepter les notifications.\n\n![PWA - Autoriser les notifications](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-15.34.14.png)\n\nVous devez aussi voir dans votre console un message du type :\n\n```json\nendpoint: cV2kP3sOb24:APA91bHfZgFSPQ3CXyG9LejWdq9jOT-WqQpvK4peX9ZZtrfsHCf6OPEvDegjsTF3uXj-Qsf4jOJ5O8rwdEm9fjKZbqerzcZUjDmsiaRcqmxuOOkpuEqPca31Dlh-6g0YgkvnLccIPz_Z\n```\n\nIl s'agit du token du device, c'est à partir de celui-ci que nous pourrons envoyer une push notification.\nComme nous voulons faire quelque chose de propre (même s'il ne s'agit que d'un tutoriel), nous allons utiliser Firebase pour stocker les tokens utilisateurs. Pour cela rien de plus simple,  vous retournez sur la console Firebase et dans l'onglet \"Authentification\" vous cliquez sur \"configuration web\".\n\n![PWA - Autoriser les notifications](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-15.50.59.png)\n\nL'installation du script se fait dans le code html, donc public/home.html et public/article/alorscettearticle.html.\n\n```html\n<html>;\n  <head>;\n    <meta charset=utf-8/>;\n    <meta name=\"theme-color\" content=\"#2F3BA2\">;\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">;\n    <link rel=\"manifest\" href=\"/public/manifest.json\">;\n  </head>;\n  <body>;\n    <script src=\"https://www.gstatic.com/firebasejs/3.5.2/firebase.js\">;</script>;\n    <script src=\"/register.js\">;</script>;\n    <link rel=\"stylesheet\" href=\"/main.css\">;\n    <link rel=\"stylesheet\" href=\"/async.css\">;\n```\n\nL'initialization, nous la mettrons dans public/register.js.\n\n```javascript\n// Initialize Firebase\nvar config = {\n  apiKey: \"AIzaSyBQxLWhe7UNMnxWlO88Ybzf93Qv_3HLeQA\",\n  authDomain: \"pwa-parisjs.firebaseapp.com\",\n  databaseURL: \"https://pwa-parisjs.firebaseio.com\",\n  storageBucket: \"pwa-parisjs.appspot.com\",\n  messagingSenderId: \"262283691358\"\n};\n\nfirebase.initializeApp(config);\n\nif('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function() {\n      return navigator.serviceWorker.ready;\n    }).then(function(registration) {\n      registration.pushManager.subscribe({userVisibleOnly: true}).then(function(sub) {\n        var endpointSections = sub.endpoint.split('/');\n        var subscriptionId = endpointSections[endpointSections.length - 1];\n        console.log('endpoint:', subscriptionId);\n      });\n    });\n  navigator.serviceWorker.ready.then(function(registration) {\n     console.log('Service Worker Ready');\n  });\n}\n```\n\nMaintenant que Firebase est installé, nous n'avons plus qu'à mettre en \"database\" le token de l'utilisateur. Vous trouverez toute les aides dont vous avez besoin dans la documentation Firebase.\nNous allons donc ajouter le fichier public/register.js\n\n```javascript\n// Initialize Firebase\nvar config = {\n  apiKey: \"AIzaSyBQxLWhe7UNMnxWlO88Ybzf93Qv_3HLeQA\",\n  authDomain: \"pwa-parisjs.firebaseapp.com\",\n  databaseURL: \"https://pwa-parisjs.firebaseio.com\",\n  storageBucket: \"pwa-parisjs.appspot.com\",\n  messagingSenderId: \"262283691358\"\n};\n\nfirebase.initializeApp(config);\n\nif('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function() {\n      return navigator.serviceWorker.ready;\n    }).then(function(registration) {\n      registration.pushManager.subscribe({userVisibleOnly: true}).then(function(sub) {\n        var endpointSections = sub.endpoint.split('/');\n        var subscriptionId = endpointSections[endpointSections.length - 1];\n        var newKey = firebase.database().ref().child('token').push().key;\n        firebase.database().ref('token/' + newKey).set({subscriptionId: subscriptionId});\n        console.log('endpoint:', subscriptionId);\n      });\n    });\n  navigator.serviceWorker.ready.then(function(registration) {\n     console.log('Service Worker Ready');\n  });\n}\n```\n\nAvant de lancer le serveur, vous devez ouvrir les droits à Firebase afin qu'il puisse écrire dans le database. Dans l'onglet \"Database\" puis \"Règles\" il faut mettre :\n\n```json\n{\n  \"rules\": {\n    \".read\": true,\n    \".write\": true\n  }\n}\n```\n\n![Firebase - Règles database](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-16.13.27.png)\n\nSi vous relancez le serveur, vous devez voir dans l'onglet \"Database\" de Firebase un token dans la BDD.\n\n![Firebase - Database Token](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-16.24.58.png)\n\nBon, maintenant que nous mettons les tokens dans une base de données nous allons préparer le message qui s'affichera lors d'une push notification. Pour aller vite nous allons ajouter le code suivant en fin du fichier public/sw.js :\n\n```javascript\nconsole.log('Started', self);\n\nself.addEventListener('install', function(event) {\n  self.skipWaiting();\n  console.log('Installed', event);\n});\n\nself.addEventListener('activate', function(event) {\n  console.log('Activated', event);\n});\n\nself.addEventListener('push', function(event) {\n  console.log('Push message', event);\n\n  var title = 'Le push de test :)';\n\n  event.waitUntil(\n    self.registration.showNotification(title, {\n     body: 'Bravo tu l\\'as reçu',\n     icon: 'images/icon.png',\n     tag: 'my-tag'\n   }));\n});\n```\n\nC'est presque fini ! Nous allons créer une url \"/sender\" qui nous permettra d'envoyer les notifications à tous les tokens que nous avons en base. Pour cela nous allons utiliser les modules *request* et *firebase* (version npm). Voici le nouveau package.json :\n\n```json\n{\n  \"name\": \"pwa-parisjs\",\n  \"version\": \"0.0.1\",\n  \"description\": \"A Progressive Web App\",\n  \"main\": \"app.js\",\n  \"scripts\": {\n    \"start\": \"node app.js\",\n    \"sw\": \"gulp sw-precache\"\n  },\n  \"dependencies\": {\n    \"express\": \"^4.14.0\",\n    \"firebase\": \"^3.5.1\",\n    \"request\": \"^2.75.0\"\n  },\n  \"devDependencies\": {\n    \"gulp\": \"^3.9.1\",\n    \"sw-precache\": \"^3.2.0\"\n  }\n}\n```\n\nDans le fichier app.js, nous initialisons Firebase. Vous allez avoir besoin d'un fichier de clé serveur. Vous allez cliquer sur la roue dans Firebase puis \"Autorisation\". Vous êtes alors redirigé sur une autre console.\n\n![Firebase - Autorisation](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-16.59.31.png)\n\nPuis dans Comptes de service, vous créez un nouveau compte de service.\n\n![Création - Compte et services](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-17.02.45.png)\n\nUn fichier json sera alors téléchargé, il vous suffit de l'ajouter à la racine de votre projet.\n\n![JsonFile - Racine](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-17.22.04.png)\n\nDans le fichier app.js nous allons ajouter la route /sender qui envoie la requête de demande de push en prenant l'ensemble des tokens.\n\n```javascript\nvar path = require('path');\nvar express = require('express');\nvar app = express();\nvar firebase = require('firebase');\nvar request = require('request');\n\nfirebase.initializeApp({\n  databaseURL: 'https://pwa-parisjs.firebaseio.com/', // A trouver dans l'onglet Database\n  serviceAccount: 'pwa-parisjs-cf0bc079ee69.json' // Nom du fichier json a votre racine\n});\n\napp.use(express.static(path.join(__dirname, 'public'), {index: false}))\n\napp.get('/sender', function(req, res){\n  var allToken = firebase.database().ref('/token');\n  Promise.all([allToken.once('value')]).then(function(resp) {\n    var allToken = resp[0].val();\n    tokenRep = '';\n    Object.keys(allToken).forEach(function(uid) {\n      var token = allToken[uid];\n      request({\n        url: 'https://android.googleapis.com/gcm/send',\n        method: 'POST',\n        headers: {\n          'Content-Type' :' application/json',\n          'Authorization': 'key=AIzaSyDV-KhCa9dM-bSg_r23GUwpRJqBw6qrJIc', // Clé serveur disponible dans les paramètres du projet Firebase\n        },\n        body: JSON.stringify(\n          {\n            \"registration_ids\" : [token.subscriptionId]\n          }\n        )\n      }, function(error, response, body) {\n\n      });\n    });\n  }).catch(function(error) {\n    console.log('Failed to start weekly top posts emailer:', error);\n  });\n\n  res.send('ok');\n});\n\n\napp.use('/', function (req, res) {\n  res.sendFile(__dirname + '/public/home.html');\n});\n\napp.listen(8080, function () {\n  console.log('Example app listening on port 8080!');\n});\n```\n\nAttention ! La clé Authorization se trouve dans le premier onglet que l'on a ouvert.\n\n![Firebase - Autorisation](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-17.44.27.png)\n\nSi tout est bon, quand vous relancez le serveur et que vous allez sur / puis /sender vous avez la notification. Si ce n'est pas le cas supprimez le cache de votre application dans la console chrome onglet application.\n\n![Firebase - Autorisation](/imgs/posts/2016-10-27-les-push-notifications-sur-votre-site/capture-decran-2016-10-26-a-17.46.23.png)\n\n\nEncore une fois ce code est vraiment un tutoriel, je vous invite donc à faire des issues pour la moindre question. Le code final est [ici](https://github.com/CaptainJojo/pwa-parisjs/tree/push){:rel=\"nofollow noreferrer\"}.\n"}