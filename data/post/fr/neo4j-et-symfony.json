{"date":"2018-01-29T00:00:00.000Z","title":"Neo4j et Symfony, comment utiliser une BDD graph ?","excerpt":"L'architecture et les données que nous stockons sont de plus en plus complexes. Il faut savoir choisir la bonne technologie pour le bon use case. L'une des technologies qui peut vous être utile, c'est la base de données graphes Neo4j.","readingTime":"10mn","authors":["captainjojo"],"categories":["php"],"content":"\nL'architecture et les données que nous stockons sont de plus en plus complexes. Il faut savoir choisir la bonne technologie pour le bon use case. L'une des technologies qui peut vous être utile, c'est la base de données graphes Neo4j.\n\n## Neo4j c'est quoi ?\n\nNeo4j c'est une base de données graphes. Elle permet de stocker vos données dans un format de graphe.\n\n> Mais c'est quoi un graphe ?\n\nUn graphe est composé de deux choses :\n\n- des noeuds qui contiennent la donnée dans un format simple de propriété du noeud ;\n- des relations qui permettent de lier les noeuds entre eux. Les relations aussi peuvent avoir des propriétés, et donc contenir de la donnée.\n\n![Graph]({{site.baseurl}}/assets/2018-01-29-neo4j-et-symfony/graph.png)\n\n\n> Mais cela permet quoi ?\n\nLes bases de données type graphe permettent de gérer des données très liées. Le use case que vous trouverez sur le net est toujours le même : la gestion des relations dans les réseaux sociaux. Il est plus simple de représenter les amis d'une personne via ce genre de base de données, en prenant le noeud comme un utilisateur et la relation comme le lien d'amitié. Ce qu'apporte Neo4J c'est qu'il devient très simple de récupérer les amis de mes amis en une seule requête... ce qui serait très compliqué via une base de données relationnelle.\n\n> Hé ! Mais c'est comme graphQL ?\n\nAlors là non !!! GraphQL n'est pas une base de données graphe, GraphQL n'est même pas une base de données. Neo4J est réellement une base de données et permet de stocker vos données dans un format graphe, tandis que GraphQL est une convention de requêtage.\n\n## Installation d'un Neo4J\n\nL'installation d'un serveur Neo4j est assez simple, il suffit de suivre les indications sur le site [neo4j](https://neo4j.com/). Vous pouvez aussi utiliser la machine docker disponible [ici](https://store.docker.com/images/neo4j).\n\nSi vous êtes sur un environnement Ubuntu vous n'avez qu'à suivre les instructions suivantes [ubuntu](https://doc.ubuntu-fr.org/neo4j).\n\nUne fois l'installation terminée, vous aurez accès à l'interface web qui est très pratique, elle est disponible [ici](http://127.0.0.1:7474/browser/).\n\n![Interface]({{site.baseurl}}/assets/2018-01-29-neo4j-et-symfony/interface.png)\n\n## Cypher, le requêtage simple\n\nPour requêter votre base de données, il faut apprendre à faire du Cypher. Cypher c'est le langage de requêtage pour Neo4J. Il est assez simple car très visuel. Vous pouvez lancer directement vos requêtes dans l'interface de Neo4j.\n\nCommençons par créer un noeud :\n\n```\nCREATE (ee:Person { name: \"Emil\", from: \"Sweden\" })\n```\n\nIci, nous venons de créer un noeud de type `Person` qui a comme propriété `name` et `from` avec comme valeurs respectives `Emil` et `Sweden`\n\nValidons maintenant que notre noeud est bien créé en allant le récupérer :\n\n```\nMATCH (ee:Person) WHERE ee.name = \"Emil\" RETURN ee;\n```\n\nEn Cypher, la récupération se fait via le mot clé `MATCH` puis nous récupérons les noeuds de type `Person` qui ont pour valeur dans la propriété `name` `Emil`.\n\nMaintenant que nous savons créer des noeuds, nous allons en créer plusieurs pour ensuite les mettre en relation :\n\n```\nCREATE (js:Person { name: \"Johan\", from: \"Sweden\", learn: \"surfing\" }),\n(ir:Person { name: \"Ian\", from: \"England\", title: \"author\" }),\n(rvb:Person { name: \"Rik\", from: \"Belgium\", pet: \"Orval\" }),\n(ally:Person { name: \"Allison\", from: \"California\", hobby: \"surfing\" })\n```\n\nPuis nous allons créer les relations entre les noeuds :\n\n```\nMATCH (ee:Person) WHERE ee.name = \"Emil\"\nMATCH (js:Person) WHERE js.name = \"Johan\"\nMATCH (ir:Person) WHERE ir.name = \"Ian\"\nMATCH (rvb:Person) WHERE rvb.name = \"Rik\"\nMATCH (ally:Person) WHERE ally.name = \"Allison\"\nCREATE\n(ee)-[:KNOWS {since: 2001}]->(js),(ee)-[:KNOWS {rating: 5}]->(ir),\n(js)-[:KNOWS]->(ir),(js)-[:KNOWS]->(rvb),\n(ir)-[:KNOWS]->(js),(ir)-[:KNOWS]->(ally),\n(rvb)-[:KNOWS]->(ally)\n```\n\nNous récupérons donc l'ensemble des noeuds déjà créés, puis nous créons les relations. Dans cet exemple, il y a deux façons de créer des relations :\n\n```\nCREATE (ee)-[:KNOWS {since: 2001}]->(js)\n```\n\nIci nous créons une relation dans le sens `ee` et `js` la relation est de type `KNOWS` avec la propriété `since` qui a pour valeur `2011`.\n\n```\nCREATE (rvb)-[:KNOWS]->(ally)\n```\n\nIci nous créons une autre relation de type `KNOWS` entre `rvb` et `ally` mais ici sans propriété.\n\nSi vous récupérez l'ensemble des noeuds de type `Person`...\n\n```\nMATCH (n:Person) RETURN n\n```\n\n...vous devez voir cela :\n\n![person]({{site.baseurl}}/assets/2018-01-29-neo4j-et-symfony/person.png)\n\nPour finir, nous allons récupérer toutes les relations avec `Emil`.\n\n```\nMATCH (ee:Person)-[:KNOWS]-(friends)\nWHERE ee.name = \"Emil\" RETURN ee, friends\n```\n\nLa requête est assez simple. Vous faites un `MATCH` sur les relations qui ont comme noeud dans un des sens `ee`.\n\n## Utiliser Symfony et Neo4J\n\n\n### Use Case\n\nDans notre use case, nous allons créer un système d'arborescence pour un site web.\nUn noeud sera donc une rubrique avec comme propriété `title`, et les noeuds seront en relation afin de créer l'arborescence de votre site.\n\n\n### Installation\n\nL'architecture du projet est un Symfony 4 avec Twig et la gestion des annotations.\n\nVous pouvez maintenant ajouter le bundle suivant :\n\n```\n\"neo4j/neo4j-bundle\": \"^0.4.0\",\n```\n\nDisponible [ici](https://github.com/neo4j-contrib/neo4j-symfony)\n\nVous devez aussi ajouter la librairie suivante :\n\n```\n\"graphaware/neo4j-php-ogm\": \"@rc\",\n```\n\nDisponible [ici](https://github.com/graphaware/neo4j-php-ogm). Cette librairie permet de récupérer un entityManager pour Neo4j.\n\n\n### Controller\n\nNous allons créer un controller avec deux actions :\n\n- première action, permet de récupérer l'ensemble des rubriques ainsi que leurs relations ;\n- seconde action, permet de créer une nouvelle rubrique liée à la rubrique choisie.\n\nCommençons par ajouter le client Neo4j à votre controller :\n\n```php\n//src/Controller/ArboController.php\n\nprivate $neo4jClient;\n\npublic function __construct(Client $client)\n{\n    $this->neo4jClient = $client;\n}\n```\n\nPour que cela fonctionne, n'oubliez pas de `bind` le service Neo4j dans la configuration :\n\n```yaml\n## config/services.yaml\n\nservices:\n    # default configuration for services in *this* file\n    _defaults:\n        autowire: true      # Automatically injects dependencies in your services.\n        autoconfigure: true # Automatically registers your services as commands, event subscribers, etc.\n        public: false       # Allows optimizing the container by removing unused services; this also means\n                            # fetching services directly from the container via $container->get() won't work.\n                            # The best practice is to be explicit about your dependencies anyway.\n        bind:\n          GraphAware\\Neo4j\\Client\\Client: '@neo4j.client'\n\n```\n\nCodons maintenant l'action permettant de récupérer l'ensemble des rubriques et des relations :\n\n```php\n//src/Controller/ArboController.php\n/**\n * @Route(\"/getArbo\", name=\"arbo\")\n */\npublic function getArbo(Request $request)\n{\n    $query = 'MATCH (n:Rubrique)-[r]->(n1:Rubrique) RETURN n,n1,r';\n    $result = $this->neo4jClient->run($query);\n\n    $rubriques = [];\n    foreach ($result->records() as $record) {\n        $node = $record->get('n');\n        $rubrique = $node->values();\n        $identity = $node->identity();\n        $rel = $record->get('r');\n        $rel->startNodeIdentity();\n        $rel->endNodeIdentity();\n        $node2 = $record->get('n1');\n        $rubrique2 = $node2->values();\n        $identity2 = $node2->identity();\n\n        if (!isset($rubriques[$identity])) {\n            $rubriques[$identity] = [];\n        }\n\n        if (!isset($rubriques[$identity2])) {\n            $rubriques[$identity2] = [];\n        }\n\n\n        $rubriques[$identity2]['title']  = $rubrique2['title'];\n        $rubriques[$identity]['title'] = $rubrique['title'];\n        $rubriques[$identity]['children'][] = $identity2;\n    }\n\n    $form = $this->createForm(NodeType::class);\n    $form->handleRequest($request);\n\n    if ($form->isSubmitted() && $form->isValid()) {\n        $create = $form->getData();\n\n        return $this->redirectToRoute('createArbo', ['title' => $create['title'], 'startTitle' => $create['startTitle']]);\n    }\n\n    return $this->render('arbo.html.twig', ['result' => $rubriques, 'form' => $form->createView()]);\n}\n```\n\nComme vous pouvez le voir, nous récupérons l'ensemble des rubriques liées. Puis nous parcourons les noeuds et relations pour les mettre dans un format plus simple pour le `front`.\n\nMaintenant nous allons ajouter l'action permettant de sauvegarder un nouveau noeud et sa relation :\n\n```\n//src/Controller/ArboController.php\n\n/**\n * @Route(\"/createArbo/{title}/{startTitle}\", name=\"createArbo\")\n */\npublic function createNode($title, $startTitle)\n{\n    $createNodeQuery = \"CREATE (n:Rubrique { title: {title}})\";\n    $createRelationQuery = \"MATCH (a:Rubrique),(b:Rubrique) WHERE a.title = {startTitle} AND b.title = {endTitle} CREATE (a)-[r:RELTYPE]->(b) RETURN r\";\n\n\n    $this->neo4jClient->run($createNodeQuery, ['title' => $title]);\n    $this->neo4jClient->run($createRelationQuery, ['startTitle' => $startTitle,'endTitle' => $title]);\n\n    return $this->redirectToRoute('arbo');\n}\n```\n\nOn crée d'abord la nouvelle rubrique, puis on récupère chaque noeud et on crée la relation.\n\n### FormType\n\nRien de compliqué. Le formulaire prend deux paramètres, le `title` du nouveau noeud, et le `title` du noeud parent.\n\n```php\n//src/Form/NodeType.php\n\nclass NodeType extends AbstractType\n{\n    public function buildForm(FormBuilderInterface $builder, array $options)\n    {\n        $builder\n            ->add('title')\n            ->add('startTitle')\n            ->add('save', SubmitType::class, array('label' => 'Create node'))\n        ;\n    }\n}\n```\n\n### Twig\n\nEt pour terminer nous allons mettre en place une extension twig qui permet d'afficher l'arborescence.\n\nCommençons par le code php de l'extension :\n\n```php\n//src/service/ArboExtension.php\n\nclass ArboExtension extends AbstractExtension\n{\n    private $twig;\n\n    public function __construct( Environment $twig )\n    {\n        $this->twig = $twig;\n    }\n\n    public function getFilters()\n    {\n        return array(\n            new TwigFilter('arbo', [$this, 'arbo'], ['is_safe' => ['html']]),\n        );\n    }\n\n    public function arbo($arbo, $start = null)\n    {\n        return $this->twig->render('node.html.twig', ['arbo' => $arbo[$start], 'all' => $arbo]);\n    }\n}\n\n```\n\nPuis ajoutons l'affichage qui appelle récursivement l'extension twig :\n\n\n```twig\n<!-- /templates/node.html.twig ->\n<ul>\n    <li>\n        {{ arbo.title }}\n        {% if arbo.children is defined %}\n            {% for child in arbo.children %}\n               {{ all|arbo(child) }}\n            {% endfor %}\n        {% endif %}\n    </li>\n</ul>\n```\n\n\nIl ne vous reste plus qu'à afficher la page complète !\n\n\n```\n<!-- /templates/arbo.html.twig ->\n{% extends 'base.html.twig' %}\n\n{% block body %}\n    {{ result|arbo(22) }}\n\n\n    {{ form_start(form) }}\n    {{ form_end(form) }}\n{% endblock %}\n\n```\n\n\n![arbo]({{site.baseurl}}/assets/2018-01-29-neo4j-et-symfony/arbo.png)\n\n## Conclusion\n\nVoilà ! Vous avez un exemple assez simple de l'utilisation d'une base de données Neo4J.\nIl existe de nombreux uses cases qui donnent tout l'intérêt à Neo4j. L'idée n'est jamais de faire un site qui n'utilise que Neo4j, mais dans nos architectures micro-service, pourquoi ne pas faire un service avec Neo4j ?\nIl existe aussi des systèmes pour faire de l'affichage de graph Neo4j. C'est le cas par exemple de Linkurious, une petite start-up française. Si vous utilisez ou comptez utiliser Neo4j, laissez-moi un message pour connaître votre cas d'utilisation, je suis certain que beaucoup de personnes seraient intéressées.\n"}