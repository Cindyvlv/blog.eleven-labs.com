{"date":"2023-02-22T00:00:00.000Z","title":"Symfony et MongoDB, retour aux bases","excerpt":"Faire du MongoDB avec Symfony, c'est facile, mais avec ou sans Doctrine ?","readingTime":"9mn","authors":["marianne"],"categories":["php","symfony","mongodb","doctrine"],"content":"\n<div style=\"text-align: center;\">\n    <img src=\"/imgs/posts/2023-02-22-symfony-et-mongodb-retour-aux-sources/logo.png\" width=\"200px\" alt=\"Symfony et MongoDB\" style=\"display: block; margin: auto;\"/>\n</div>\n\n\nSur ce blog, nous avons déjà quelques articles autour de MongoDB, et même s’ils sont encore d’actualité, il n’y en avait pas sur MongoDB dans Symfony, d'où cet article !\n\n## Qu’est-ce que MongoDB ?\n\nMongoDB est une base de données en NoSQL orientée documents.\nOn a plus souvent l’habitude de bases de données relationnelles comme MySQL pour enregistrer les entités sous Symfony. Les Bases orientées Document elles, sont pensées pour un besoin différent : stocker directement un objet complet, sans relation ou répartition sur plusieurs tables (par exemple des contenus comme des articles de journaux/blogs ou des catalogues de produits).\nCela permet d’y accéder plus rapidement et il n’y a pas besoin de relationnelle : toutes les informations sont enregistrées dans un JSON ou XML dans une structure souple.\n\n## Installer une base MongoDB pour un projet Symfony dans Docker\n\nAvant de l’utiliser dans votre projet sous Symfony, il faut installer dans votre docker-compose l’image de MongoDB et le configurer.\n\nOn reste sur une configuration simple où les paramètres sont stockés dans le .env.\n\n```bash\n# .env\n###> mongodb ###\nDATABASE_NAME=documents\nDATABASE_HOST=database\nDATABASE_PORT=27017\nDATABASE_USER=user\nDATABASE_PASSWORD=password\nDATABASE_VERSION=x.x.xx\n###< mongodb ###\n```\n\n```bash\n# docker-compose.yml\n    database:\n        image: mongo:${DATABASE_VERSION}\n        restart: always\n        environment:\n            MONGO_INITDB_ROOT_USERNAME: ${DATABASE_USER}\n            MONGO_INITDB_ROOT_PASSWORD: ${DATABASE_PASSWORD}\n        ports:\n            - ${DATABASE_PORT}:27017\n        expose:\n            - ${DATABASE_PORT}\n        volumes:\n            - data-documents:/data/db\n```\n\n## MongoDB dans Symfony, deux solutions possibles\n\nPour l’implémentation dans Symfony, je vais proposer deux approches : avec Doctrine, et comme c’est dans l’air du temps, SANS Doctrine !\n\nPourquoi proposer sans Doctrine ? Il y a certes du Doctrine Bashing depuis quelques années, mais comme MongoDB n’est pas du relationnel, et si vous n’avez pas besoin de l’utiliser comme un objet lors de la récupération, alors pourquoi s’embêter avec un modèle ?\n\n## Avec [DoctrineMongoDBBundle](https://www.doctrine-project.org/projects/doctrine-mongodb-bundle/en/4.4/index.html)\n### Installation\n\nJe ne vais pas répéter la documentation du Bundle qui est bien fait sur [l’installation](https://www.doctrine-project.org/projects/doctrine-mongodb-bundle/en/4.4/installation.html#install-the-bundle-with-composer), mais je vais préciser la configuration pour être cohérent avec celle de docker-compose.\n\n```bash\n# config/packages/doctrine_mongodb.yaml\n\ndoctrine_mongodb:\n    connections:\n        default:\n            server: 'mongodb://%env(resolve:DOC_DATABASE_HOST)%:%env(resolve:DOC_DATABASE_PORT)%'\n            options:\n                username: '%env(resolve:DOC_DATABASE_USER)%'\n                password: '%env(resolve:DOC_DATABASE_PASSWORD)%'\n    default_database: '%env(resolve:DOC_DATABASE_NAME)%'\n```\n\n### Utilisation\n#### Insérer un document\n\nPour cela, il faut créer un objet correspondant au document que vous voulez insérer. On va prendre l’exemple d’un article de blog.\n\nLa suite est comme pour une autre base de données : il faut créer l’article, le persister via le DocumentManager et le flusher.\n\n```php\n// Article.php\nuse Doctrine\\ODM\\MongoDB\\Mapping\\Annotations as MongoDB;\n\n/**\n * @MongoDB\\Document(collection=\"article\")\n */\nclass Article\n{\n    /**\n     * @MongoDB\\Id()\n     */\n    private string $id;\n\n    /** @MongoDB\\Field(type=\"string\") */\n    private string $title;\n\n    /** @MongoDB\\Field(type=\"string\") */\n    private string $content;\n\n    /** @MongoDB\\Field(type=\"string\") */\n    private string $status;\n\n    /** @MongoDB\\Field(type=\"date\") */\n    private \\DateTime $createdDate;\n\n    public function getId(): string\n    {\n        return $this->id;\n    }\n\n    public function getTitle(): string\n    {\n        return $this->title;\n    }\n\n    public function setTitle(string $title): Article\n    {\n        $this->title = $title;\n\n        return $this;\n    }\n\n    public function getContent(): string\n    {\n        return $this->content;\n    }\n\n    public function setContent(string $content): Article\n    {\n        $this->content = $content;\n\n        return $this;\n    }\n\n    public function getStatus(): string\n    {\n        return $this->status;\n    }\n\n    public function setStatus(string $status): Article\n    {\n        $this->status = $status;\n\n        return $this;\n    }\n\n    public function getCreatedDate(): \\DateTime\n    {\n        return $this->createdDate;\n    }\n\n    public function setCreatedDate(\\DateTime $createdDate): Article\n    {\n        $this->createdDate = $createdDate;\n\n        return $this;\n    }\n}\n```\n\nAprès dans n'importe quelle classe, il faut déclarer `Doctrine\\ODM\\MongoDB\\DocumentManager` dans le `__construct()` et appeler persist/flush.\n```php\n[...]\n    public function __construct(\n        public readonly DocumentManager $documentManager\n    ) {\n    }\n\n    public function process(array $data): void\n    {\n        $article = new Article();\n        $article\n            ->setTitle($data['title'])\n            ->setContent($data['content'])\n            ->setStatus($data['status'])\n            ->setCreatedDate($data['createdDate'])\n        ;\n\n        $this->documentManager->persist($article);\n        $this->documentManager->flush();\n    }\n```\n\nVoici la [documentation de MongoDB](https://www.doctrine-project.org/projects/doctrine-mongodb-bundle/en/4.4/first_steps.html#persisting-objects-to-mongodb) si vous voulez aller plus loin.\n\n#### Récupérer un document\n\nPour récupérer un document, il y a plusieurs possibilités comme décrites dans la [documentation](https://www.doctrine-project.org/projects/doctrine-mongodb-odm/en/2.3/reference/document-repositories.html). Ici ça va être simplement par `id` et ça se fait en une ligne.\n\n```php\n[...]\n    public function process(int $id): Article\n    {\n        return $this->documentManager->find(Article::class, $id);\n    }\n```\n\nOn ne voit pas qu'il s'agit d'une base de données MongoDB, Doctrine masque l'information. Mais cela peut être inutile de créer des objets correspondants aux documents. Et pour cela, il faut s'affranchir de Doctrine.\n\n## Sans Doctrine mais avec [Facile.it MongoDB Bundle](https://github.com/facile-it/mongodb-bundle)\n### Installation\n\nAprès avoir installé le bundle `composer require facile-it/mongodb-bundle`, à vous de vérifier et de mettre à jour la configuration.\n\n```bash\n# config/packages/facile_it_mongodb.yaml\n\nmongo_db_bundle:\n    data_collection: '%kernel.debug%'\n    clients:\n        default:\n            hosts:\n                - { host: '%env(resolve:DATABASE_HOST)%', port: '%env(int:DATABASE_PORT)%' }\n            username:         '%env(resolve:DATABASE_USER)%'\n            password:         '%env(resolve:DATABASE_PASSWORD)%'\n            replicaSet:       '' # default null (no replica)\n            ssl:              false\n            connectTimeoutMS: 3000\n            readPreference:   primaryPreferred\n\n    connections:\n        default:\n            client_name:    default\n            database_name:  '%env(resolve:DATABASE_NAME)%'\n```\n\n### Utilisation\n#### Insérer un document\n\nContrairement à la précédente solution, ici, pas besoin d'objet à persister : on utilise un tableau avec les données. À vous de voir si vous voulez vérifier le format et les données dedans.\n\nEnsuite, pour insérer les données, il faut sélectionner la collection (ici `article` pour rester sur le thème) et tout simplement insérer le tableau.\n```php\n[...]\nuse MongoDB\\Database;\n[...]\n    public function __construct(private readonly Database $database)\n    {\n    }\n\n    public function process(array $data): void\n    {\n        $collection = $this->database->selectCollection('article');\n        $collection->insertOne($data);\n    }\n}\n```\n\n#### Récupérer un document\n\nPour récupérer un document, on procède aussi à la sélection de la collection et le `findOne()` permet de rechercher sur n'importe quel champ.\n\n```php\n[...]\n    public function process(int $id): array\n    {\n        $collection = $this->database->selectCollection('article');\n\n        return $collection->findOne(['id' => $id]);\n    }\n```\n\nVous pouvez créer un repository avec l'ensemble des fonctions. Cela vous permettra d'être plus indépendant dans vos services vis-à-vis du choix de la base de données.\n\n## Conclusion\n\nNous sommes restés sur les bases qui sont l'insertion et la récupération d'un document, mais MongoDB a aussi un système d'indexation qui permet de gagner en efficacité pour la recherche de documents.\n\nLa documentation pour les deux possibilités est assez claire pour aller plus loin dans son utilisation.\n"}