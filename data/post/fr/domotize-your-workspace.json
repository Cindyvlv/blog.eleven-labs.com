{"date":"2019-08-07T00:00:00.000Z","title":"Domotiser son espace de travail - Partie 1","excerpt":"L'objectif de cet article est de domotiser simplement et efficacement son espace de travail avec home-assistant.","readingTime":"7mn","authors":["pouzor"],"categories":[],"content":"\nLa domotique “grand public” s’installe de plus en plus dans les foyers, notamment grâce aux nouveaux assistants personnels (Google Home, Alexa) ou encore aux solutions de domotisation “clefs en main”. toutefois, elle reste plutôt absente dans les environnements pros et particulièrement dans notre cas, celui du développement. Pourtant les choses ont pas mal bougé ces dernières années dans le domaine.\n\nDans cet article, nous allons voir comment construire un dashboard d’équipe à l’aide de la solution domotique [home-assistant.io](https://www.home-assistant.io) et de quelques objets connectés (Philips Hue, Google Home).\n\n## home-assistant.io\n\nMais qu’est-ce donc que Home Assistant ? Home Assistant (hass) est une solution domotique/automatisation open source, privacy-first qui commence à se faire vraiment bien connaître dans le monde de la domotisation. Elle est développée en python, basée sur un système événementiel et “packagé” avec l’ensemble des plugins (pas d’installation de plugin à posteriori).\n\nNous allons tout d’abord installer hass, et pour se faire, plusieurs choix s'offrent à nous (Docker, hassbian ou hass.io). Dans le cadre de ce tuto, nous allons le faire tourner sous Docker mais je vous invite à tester Hassbian qui marche très bien sous raspberry.\n\nCela tient en deux commandes (sous linux) :\n\n```sh\n$ mkdir home-assistant\n$ docker run -d --name=\"home-assistant\" -v /PATH_TO_YOUR_FOLDER_HASS:/config -e \"TZ=Europe/Paris\" -p 8123:8123 homeassistant/home-assistant\n```\nToutes les infos sur l’installation sont disponibles [ici](https://www.home-assistant.io/docs/installation/docker/)\n\n\nEt voilà, votre home-assistant tourne maintenant en local, et vous pouvez y accéder ici :\n[http://localhost:8124/](http://localhost:8124/)\n\n![home-assistant]({{site.baseurl}}/assets/2019-05-28-domotize-your-workspace/connexion-home.png)\n\n\nIl vous suffit maintenant de créer votre login/pass pour accéder à hass.\nNous allons voir à présent comment activer un [component](https://www.home-assistant.io/components/), en commençant avec [sensor.gitlab_ci](https://www.home-assistant.io/components/sensor.gitlab_ci/).\n\n## Components et Sensor Gitlab CI\n\nTout d’abord, un petit laïus sur comment fonctionne home-assistant.\n\nSi vous regardez dans le répertoire home-assistant que vous avez créé dans la première étape, vous devriez voir ceci :\n\n```sh\n$ ls home-assistant\n\nautomations.yaml     customize.yaml       groups.yaml          home-assistant_v2.db secrets.yaml\nconfiguration.yaml   deps                 home-assistant.log   scripts.yaml         tts\n\n```\n\nGlobalement, toute la configuration se passe dans le fichier `configuration.yaml`, les autres .yaml étant inclus dans celui-ci.\n\nComme vous pouvez le voir, il est déjà rempli d'un certain nombre d’éléments, qui sont visibles sur votre home-assistant (map, plugin jour/nuit et météo).\n\nPour faire simple, il existe plusieurs types de components installables sur hass. Celui qui va nous intéresser c’est le type sensor, celui de gitlab-ci :\n\nDans la partie sensor du fichier configuration.yaml :\n\n```yaml\nsensor:\n  - platform: gitlab_ci #référence du plugin\n    gitlab_id: xxx #ID du projet à monitorer\n    token: xxx #token gitlab\n    name: Test gitlab projet X # va être l'id de votre sensor\n\n```\n\nPour récupérer votre token gitlab, c'est par [ici](https://gitlab.com/profile/personal_access_tokens)\n\nOn va maintenant vérifier que le fichier yaml est correct, puis relancer home-assistant pour prendre la configuration en compte.\n\n![home-assistant]({{site.baseurl}}/assets/2019-05-28-domotize-your-workspace/restart.png)\n\n\nVous devriez maintenant voir apparaître le dernier statut du build du projet.\n\n\n![home-assistant]({{site.baseurl}}/assets/2019-05-28-domotize-your-workspace/hass-gitlabci.png)\n\n\nEt si vous cliquez sur le sensor, vous aurez plus d’infos :\n\n![home-assistant]({{site.baseurl}}/assets/2019-05-28-domotize-your-workspace/details-gitlabci.png)\n\n\n## Design\n\nBon c’est bien sympa, mais on ne voit pas grand chose et c’est assez minimaliste tout ca. Allons ajouter un coup de template là-dessus.\nHass utilise maintenant [lovelace](https://www.home-assistant.io/lovelace/) par défaut. Nous allons activer le mode yaml de lovelace pour simplifier l'édition.\n\n```yaml\n#configuration.yaml\nlovelace:\n  mode: yaml\n```\n\nEt créer le fichier de configuration qui va bien dans le répertoire racine.\n\n```sh\n$ touch ui-lovelace.yaml\n```\nComme à chaque modification du fichier `configuration.yaml`, pensez à redémarrer Hass.\n\n\n\nNext, nous avons besoin de faire apparaître les valeurs secondaires du plugin Gitlab comme un sensor à part entière, nous allons donc les créer \"à la mano\".\n\n\n```yaml\n#configuration.yaml\nsensor:\n  #... ajoutez uniquement ces deux platforms sous le noeud sensor\n  - platform: template\n    sensors:\n      test_gitlab_projet_x_build_branch: #nom que l’on donne à notre sensor custom\n        value_template: \"{{ state_attr('sensor.test_gitlab_projet_x', 'build branch') }}\" # On récupère et affiche l’attribute ‘build branche’\n        friendly_name: \"Branch\"\n        entity_id: test_gitlab_projet_x #Le sensor va écouter cette entity pour changer ses valeurs\n      test_gitlab_projet_x_commit_date:\n        value_template: \"{{ state_attr('sensor.test_gitlab_projet_x', 'commit date') }}\"\n        friendly_name: \"Date\"\n        entity_id: sensor.test_gitlab_projet_x\n\n```\n\nAttention à bien insérer les deux nouveaux sensors sous le noeud `sensor` existant déjà dans le fichier configuration.\n\n\nIci `state_attr` nous permet de récupérer l’attribut 'commit date' du sensor gitlab.\n\nEnfin, il nous reste plus qu’à configurer notre template pour afficher notre card.\n\n```yaml\n#ui-lovelace.yaml\n\ntitle: Dashboard\nviews:\n    # View tab title.\n  - title: Gitlab\n    icon: mdi:gitlab\n    id: gitlab\n    cards:\n      - type: entities\n        title: Gitlab X Project\n        entities:\n          - entity: sensor.test_gitlab_projet_x\n          - entity: sensor.test_gitlab_projet_x_build_branch\n          - entity: sensor.test_gitlab_projet_x_commit_date\n            icon: mdi:calendar-range\n  - title: Other\n    id: other\n\n```\n\nTadaaa :\n\n![home-assistant gitlab-ci]({{site.baseurl}}/assets/2019-05-28-domotize-your-workspace/lovelace-gitlabci.png)\n\n\nDernière étape, nous allons créer une card spécifique pour la branche master afin de suivre spécifiquement cette branche. Pour cela, nous allons utiliser un custom component : [variable](https://github.com/rogro82/hass-variables).\nIl suffit simplement de copier le dossier variable de ce projet dans un repertoire `custom_components` à la racine du projet.\n\nEnsuite, nous allons créer notre variable de status de CI pour master :\n\n```yaml\n#configuration.yaml\n\nvariable:\n  master_status:\n    value: \"Waiting next commit on master\"\n```\n\n\nPuis, il va falloir créer une automation pour mettre à jour le status de la CI sur cette variable uniquement lorsque le pipeline est sur master.\n\n\n```yaml\n#automation.yaml\n\n- trigger:\n    platform: state\n    entity_id: sensor.test_gitlab_projet_x\n  condition:\n    - condition: template\n      value_template: \"{{ is_state('sensor.test_gitlab_projet_x_build_branch', 'master') }}\"\n  action:\n      - service: variable.set_variable\n        data:\n          variable: master_status\n          value_template: \"{{ states('sensor.test_gitlab_projet_x') }}\"\n```\n\nIci nous avons :\n- `trigger`: chaque changement lance cette automation\n- `condition`: il faut que notre entity branch ait la valeur master\n- `action`: si la condition est remplie, nous changeons la valeur de notre variable avec le status de la pipeline\n\n\nEnfin, il nous reste plus qu'à ajouter la card dans lovelace.\n\n```yaml\n#ui-lovelace.yaml\n      #...\n      - type: entities\n        title: Gitlab X Project Master\n        entities:\n          - entity: variable.master_status\n```\n\n\nLe résultat :\n\n![home-assistant gitlab-ci]({{site.baseurl}}/assets/2019-05-28-domotize-your-workspace/master-branch-result.png)\n\n\nVoilà pour la partie design, il y à des dizaines d’améliorations à apporter que nous ne verrons pas dans cet article.\n\nPar exemple :\n- Changer la couleur de la card en fonction du test / résultat de la pipeline\n- Raccourci vers le résultat de la CI\n- Stats sur les CI/CD\n- …\n\nPour information, vous pouvez faire la même chose avec [Github](https://www.home-assistant.io/components/github/).\n\n\nVoila pour la première partie de l'article, vous pouvez retrouver le code de cet article sur [Github](https://github.com/eleven-labs/home-assistant)\n\n\nDans le prochain [article]({{site.baseurl}}/fr/domotize-your-workspace-part-2/), nous verrons comment nous pouvons agir physiquement en fonction des résultats des pipelines dans notre espace de travail, grâce aux Philips Hue ou encore avec GoogleHome.\n"}