{"date":"2016-09-21T00:00:00.000Z","title":"mTools - Le must have pour MongoDB","excerpt":"Maintenir une application MongoDB, notamment sur des sujets Datas avec beaucoup de volumétrie et/ou d’opérations peut vite devenir un supplice, surtout si, comme la plupart des Devs, vous n'avez pas accès aux machines de productions qui sont généralement réservées aux exploitants.","readingTime":"7mn","authors":["pouzor"],"categories":["architecture"],"content":"\nMaintenir une application MongoDB, notamment sur des sujets Datas avec beaucoup de volumétrie et/ou d’opérations peut vite devenir un supplice, surtout si, comme la plupart des Devs, vous n'avez pas accès aux machines de productions qui sont généralement réservées aux exploitants.\n\nProblème : comment trouver dans vos dizaines de millions de données ou requêtes quotidiennes, celles qui ont un impact négatif sur vos performances ou encore les goulots d’étranglement de votre architecture ?\n\nSuite à l’accompagnement de MongoDB inc sur nos sujets Datas au sein de FranceTV Edition Numérique, nous avons automatisé l'utilisation d'outils afin de pouvoir étudier les comportements des productions sans impacts sur les applications.\n\nL'outil, ou plutôt la boite à outils que nous utilisons le plus à ce jour est [MTools](https://github.com/rueckstiess/mtools). Ce projet a été initié et est toujours maintenu par [Thomas Rückstieß](https://github.com/rueckstiess), ayant travaillé chez... MongoDB :){:rel=\"nofollow noreferrer\"}\n\n\n## MTools est composé de 6 outils :\n\n### Mloginfo :\n\nMloginfo lit les log générés par mongoDB et retourne des informations d'utilisation de la base de données. Dans notre cas, ce qui nous intéresse (entre autres) c'est le profiling des requêtes afin de voir celles qui s’exécutent le plus ou encore celles qui consomment le plus de temps.\n\nExemple d'utilisation :\n\n```\nmloginfo --queries logs.mongo/mongod.log\n\nnamespace              operation        pattern                              count     min (ms)    max (ms)    mean (ms)    95%-ile (ms)    sum (ms)\n\nmyCol.$cmd               findandmodify    {\"ID\": 1}                          916493         101       10486          277           453.0    254423325\nmyCol.User               count            {\"activeSeg\": 1, \"updatedAt\": 1}   68           30135     1413998       419353       1350776.4    28516024\nmyCol.InactiveUser       count            {\"inactiveSeg\": 1}                 32          625038     1019698       813384        984999.6    26028315\n```\n\nAu niveau des colonnes :\n\n- namespace : DB et collection utilisée\n- operation : opération mongo (find, update, remove ...)\n- pattern : champs de filtre de la requête. Pour la première ligne par exemple, ID est le champ utilisé pour la requête \"findAndModify\" et peut avoir n'importe quelle valeur (3, 42, etc...).\n- count : nombre total de requêtes similaires dans le fichier de log\n- min, max, mean, 95%-ile : temps d’exécution de la requête\n- sum : temps cumulé de cette requête\n\nDans notre cas, on peut se rendre compte que la commande \"findandmodify\" est très souvent utilisée, dans un temps moyen correct. En revanche les fonctions de \"count\" sont très longues, probablement synonyme d'un index manquant.\nPlus d'infos [ici](https://github.com/rueckstiess/mtools/wiki/mloginfo){:rel=\"nofollow noreferrer\"}.\n\n### Mlogfilter :\n\nMlogfilter permet comme son nom l'indique de réduire la quantité d'information d'un fichier de log. Nous pouvons appliquer plusieurs filtres et combiner le résultat avec mloginfo par exemple.\n\n```\ncat logs.mongo/mongod.log | mlogfilter --human --slow --from start +1day\n\nFri Sep 16 08:01:58.883 I COMMAND [conn195591] command mydb.Client command:\naggregate { aggregate: \"Client\", pipeline: [ { $match: { somedate:\n{ $lte: new Date(1474005604000), $gte: new Date(1469951542000) } } }, { $sort:\n{ somedate: -1 } },{ $unwind: \"$someArray\" }, { $skip: 165000 },\n{ $limit: 5000 } ], allowDiskUse: true }\nntoskip:0 keyUpdates:0 writeConflicts:0 numYields:549 reslen:862557\nlocks:{ Global: { acquireCount: { r: 1120 } },\nDatabase: { acquireCount: { r: 560 } }, Collection: { acquireCount: { r: 560 } } }\nprotocol:op_query (0hr 0min 3secs 99ms) 3,099ms\n```\n\nAvec cette commande, mlogfilter nous permet de filtrer les logs des commandes les plus longues (--slow) dans un intervalle d'un jour à partir du début du fichier. On peut voir que cela nous donne une commande d'agrégation qui a pris plus de 3 secondes pour s’exécuter.\n\nPlus d'infos sur [mlogfilter](https://github.com/rueckstiess/mtools/wiki/mlogfilter){:rel=\"nofollow noreferrer\"}.\n\n### Mplotqueries & Mlogvis :\n\nCes deux exécutables permettent de générer des graphiques afin de visualiser plus d'informations (répartition des appels, type de commandes etc...) de manière graphique.\n\n\n![Mlogvis](/imgs/posts/2016-09-21-mtools/mlogvis.png)\n\nPlus d'infos sur [Mlogvis](https://github.com/rueckstiess/mtools/wiki/mlogvis) & [Mplotqueries](https://github.com/rueckstiess/mtools/wiki/mplotqueries){:rel=\"nofollow noreferrer\"}.\n\n### Mgenerate :\n\nMgenerate permet, à partir d'un modèle JSON, de remplir une base de données mongoDB avec de la donnée aléatoire. C'est l'outil parfait pour tester le comportement de fonction ou de requête avec un grand set de données.\n\nExemple de modèle JSON pour la génération d'une collection User :\n\n```json\n{\n    \"user\": {\n        \"name\": {\n            \"first\": {\"$choose\": [\"Liam\", \"Noah\", \"Ethan\", \"Mason\", \"Logan\", \"Jacob\", \"Lucas\", \"Jackson\", \"Aiden\", \"Jack\", \"James\", \"Elijah\", \"Luke\", \"William\", \"Michael\", \"Alexander\", \"Oliver\", \"Owen\", \"Daniel\", \"Gabriel\", \"Henry\", \"Matthew\", \"Carter\", \"Ryan\", \"Wyatt\", \"Andrew\", \"Connor\", \"Caleb\", \"Jayden\", \"Nathan\", \"Dylan\", \"Isaac\", \"Hunter\", \"Joshua\", \"Landon\", \"Samuel\", \"David\", \"Sebastian\", \"Olivia\", \"Emma\", \"Sophia\", \"Ava\", \"Isabella\", \"Mia\", \"Charlotte\", \"Emily\", \"Abigail\", \"Avery\", \"Harper\", \"Ella\", \"Madison\", \"Amelie\", \"Lily\", \"Chloe\", \"Sofia\", \"Evelyn\", \"Hannah\", \"Addison\", \"Grace\", \"Aubrey\", \"Zoey\", \"Aria\", \"Ellie\", \"Natalie\", \"Zoe\", \"Audrey\", \"Elizabeth\", \"Scarlett\", \"Layla\", \"Victoria\", \"Brooklyn\", \"Lucy\", \"Lillian\", \"Claire\", \"Nora\", \"Riley\", \"Leah\"] },\n            \"last\": {\"$choose\": [\"Smith\", \"Jones\", \"Williams\", \"Brown\", \"Taylor\", \"Davies\", \"Wilson\", \"Evans\", \"Thomas\", \"Johnson\", \"Roberts\", \"Walker\", \"Wright\", \"Robinson\", \"Thompson\", \"White\", \"Hughes\", \"Edwards\", \"Green\", \"Hall\", \"Wood\", \"Harris\", \"Lewis\", \"Martin\", \"Jackson\", \"Clarke\", \"Clark\", \"Turner\", \"Hill\", \"Scott\", \"Cooper\", \"Morris\", \"Ward\", \"Moore\", \"King\", \"Watson\", \"Baker\" , \"Harrison\", \"Morgan\", \"Patel\", \"Young\", \"Allen\", \"Mitchell\", \"James\", \"Anderson\", \"Phillips\", \"Lee\", \"Bell\", \"Parker\", \"Davis\"] }\n        },\n        \"gender\": {\"$choose\": [\"female\", \"male\"]},\n        \"age\": \"$number\",\n        \"address\": {\n            \"street\": {\"$string\": {\"length\": 10}},\n            \"house_no\": \"$number\",\n            \"zip_code\": {\"$number\": [10000, 99999]},\n            \"city\": {\"$choose\": [\"Manhattan\", \"Brooklyn\", \"New Jersey\", \"Queens\", \"Bronx\"]}\n        },\n        \"phone_no\": { \"$missing\" : { \"percent\" : 30, \"ifnot\" : {\"$number\": [1000000000, 9999999999]} } },\n        \"created_at\": {\"$date\": [\"2010-01-01\", \"2014-07-24\"] },\n        \"is_active\": {\"$choose\": [true, false]}\n    },\n    \"tags\": {\"$array\": {\"of\": {\"label\": \"$string\", \"id\": \"$oid\", \"subtags\":\n        {\"$missing\": {\"percent\": 80, \"ifnot\": {\"$array\": [\"$string\", {\"$number\": [2, 5]}]}}}}, \"number\": {\"$number\": [0, 10] }}}\n}\n```\n\nPlus d'infos sur [Mgenerate](https://github.com/rueckstiess/mtools/wiki/mgenerate){:rel=\"nofollow noreferrer\"}.\n\n### Mlaunch :\n\nMlaunch permet de créer rapidement un environnement local de travail avec mongo. Il peut fournir un configuration MongoDB en stand-alone mais aussi en replica et/ou avec shard. Combiné avec mgenerate, cela peut permettre de mettre en place des environnements de tests très rapidement afin de tester diverses applications tournants sous mongoDB.\n\nExemple : ```mlaunch --replicaset --nodes 5```\n\nCette commande permet de demander la création d'une instance mongo avec 5 replicats\n\n### Point bonus, MongoDB Compass :\n\n\n est un client lourd permettant d’analyser et de parcourir les données d'une base MongoDB. Globalement l'outils permet de manipuler la data sans réellement demander des compétences en query mongo. Petit bémol, il n'est encore disponible que sous Windows ou MacOs :'(\n\n\n ![Compass](/imgs/posts/2016-09-21-mtools/date-sample.png)\n\n ![Compass](/imgs/posts/2016-09-21-mtools/query-builder.png)\n"}