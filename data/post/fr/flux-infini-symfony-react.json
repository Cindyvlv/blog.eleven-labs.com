{"date":"2017-09-10T00:00:00.000Z","title":"Mise en place d'un flux infini Symfony-React","excerpt":"Pour rendre l'expérience utilisateur de nos applications web toujours plus agréable, nous sommes de plus en plus obligés d'utiliser plusieurs technologies en même temps. C'est par exemple le cas si l'on souhaite mettre en place un flux infini. Pour le rendre simple et performant, nous allons utiliser un backend Symfony et un front en ReactJs. La question se pose alors : comment interfacer les deux technos ?","readingTime":"44mn","authors":["captainjojo"],"categories":["php","javascript"],"content":"Pour rendre l'expérience utilisateur de nos applications web toujours plus agréable, nous sommes de plus en plus obligés d'utiliser plusieurs technologies en même temps. C'est par exemple le cas si l'on souhaite mettre en place un flux infini. Pour le rendre simple et performant, nous allons utiliser un backend Symfony et un front en ReactJs. La question se pose alors : comment interfacer les deux technos ?\n\n### Mise en place du backend\n\nNotre site est tout d'abord un site en Symfony 3.3. La mise en place est assez basique, il vous suffit d'installer Symfony en suivant le tutoriel suivant sur le [site officiel](https://symfony.com/doc/current/setup.html).  Pour la suite de notre projet, nous allons avoir besoin de stocker les données du flux, pour cela nous allons mettre en place une base de données [Postgresql](https://www.postgresql.org/){:rel=\"nofollow noreferrer\"}. Il vous suffit de changer dans votre fichier de configuration les paramètres par défaut de la database doctrine.\n\n```yaml\n# config.yml\n# Doctrine Configuration\ndoctrine:\n    dbal:\n        driver: pdo_pgsql\n        host: '%database_host%'\n        port: '%database_port%'\n        dbname: '%database_name%'\n        user: '%database_user%'\n        password: '%database_password%'\n        charset: UTF8\n    orm:\n        auto_generate_proxy_classes: '%kernel.debug%'\n        naming_strategy: doctrine.orm.naming_strategy.underscore\n        auto_mapping: true\n```\n\nComme nous aimons le code propre, nous allons utiliser les variables d'environnement pour notre configuration de base de donnée. Il vous faut alors changer dans votre fichier parameters.yml les valeurs des variables pour aller chercher les valeurs dans votre environnement.\n\n```yaml\n# parameters.yml\nparameters:\n    database_host: '%env(POSTGRES_HOST)%'\n    database_port: '%env(POSTGRES_PORT)%'\n    database_name: '%env(POSTGRES_DB)%'\n    database_user: '%env(POSTGRES_USER)%'\n    database_password: '%env(POSTGRES_PASSWORD)%'\n    secret: '%env(SECRET)%'\n```\n\nVous pouvez maintenant créer votre fichier .env avec les valeurs de vos variables.\n\n```yaml\n// .env\n# PATH DIR\nSYMFONY_APP_PATH=./\nLOGS_DIR=./docker/logs\n\n# DATABASE\nPOSTGRES_HOST=postgres\nPOSTGRES_DB=infinite\nPOSTGRES_USER=infinite\nPOSTGRES_PASSWORD=infinitepass\nPOSTGRES_PORT=5432\n\n# PORT WEB\nWEB_PORT=80\n\n# SYMFONY\nSECRET=d3e2fa9715287ba25b2d0fd41685ac031970f555\n```\n\nSi vous avez fait un peu attention, vous avez vu que dans le fichier `.env` il y a d'autres variables, c'est parce que l'application utilise [docker](https://www.docker.com/){:rel=\"nofollow noreferrer\"}.\n\n### Mettez en place votre docker (optionnel)\n\nPour aller plus vite dans la suite de notre projet, nous avons mis en place une architecture docker permettant d'utiliser l'application. La mise en place est optionnelle mais vous aidera pour avancer dans votre développement.\n\nÀ la racine de votre projet,  ajoutez un dossier `docker` qui contiendra la configuration de votre stack technique. Pour le projet nous allons utiliser :\n\n 1. Php7 pour la partie symfony\n 2. Nodejs pour builder l'application React\n 3. Nginx comme serveur web pour servir le site\n\nVous devez créer les trois dossiers suivants à l'intérieur du dossier `docker`.\n\n - `nginx`\n - `php7-fpm`\n - `node`\n\nRespectivement dans chaque dossier vous devez ajouter les fichiers `Dockerfile` suivants.\n\nDans le fichier `nginx/Dockerfile`\n\n```sh\n/nginx/Dockerfile\nFROM debian:jessie\n\nMAINTAINER Maxence POUTORD <maxence.poutord@gmail.com>\n\nRUN apt-get update && apt-get install -y \\\n    nginx\n\nADD nginx.conf /etc/nginx/\nADD symfony.conf /etc/nginx/sites-available/\n\nRUN ln -s /etc/nginx/sites-available/symfony.conf /etc/nginx/sites-enabled/symfony\nRUN rm /etc/nginx/sites-enabled/default\n\nRUN echo \"upstream php-upstream { server php:9000; }\" > /etc/nginx/conf.d/upstream.conf\n\nRUN usermod -u 1000 www-data\n\nCMD [\"nginx\"]\n\nEXPOSE 80\nEXPOSE 443\n````\n\nDans le fichier `php/Dockerfile`\n\n```sh\n/php/Dockerfile\n# See https://github.com/docker-library/php/blob/4677ca134fe48d20c820a19becb99198824d78e3/7.0/fpm/Dockerfile\nFROM php:7.1-fpm\n\nMAINTAINER Maxence POUTORD <maxence.poutord@gmail.com>\n\nRUN apt-get update && apt-get install -y \\\n    git \\\n    unzip \\\n    zlib1g-dev \\\n    libpq-dev\n\n# Install Composer\nRUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer\nRUN composer --version\nRUN mkdir /var/www/.composer && chown -R www-data /var/www/.composer\n\n# Set timezone\nRUN rm /etc/localtime\nRUN ln -s /usr/share/zoneinfo/Europe/Paris /etc/localtime\nRUN \"date\"\n\n# Type docker-php-ext-install to see available extensions\nRUN docker-php-ext-install pdo pdo_pgsql zip\n\n# install xdebug\nRUN pecl install xdebug\nRUN docker-php-ext-enable xdebug\nRUN echo \"error_reporting = E_ALL\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\nRUN echo \"display_startup_errors = On\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\nRUN echo \"display_errors = On\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\nRUN echo \"xdebug.remote_enable=1\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\nRUN echo \"xdebug.remote_connect_back=1\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\nRUN echo \"xdebug.idekey=\\\"PHPSTORM\\\"\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\nRUN echo \"xdebug.remote_port=9001\" >> /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini\n\nRUN echo 'alias sf3=\"php bin/console\"' >> ~/.bashrc\n\nRUN usermod -u 1000 www-data\n\nWORKDIR /var/www/symfony\n```\n\nDans le fichier `node/Dockerfile`\n\n```sh\n/node/Dockerfile\nFROM node:8\n\nRUN apt-get update && apt-get install -y \\\n    curl \\\n    apt-transport-https\n\nRUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add - && \\\n    echo \"deb https://dl.yarnpkg.com/debian/ stable main\" | tee /etc/apt/sources.list.d/yarn.list\n\nRUN apt-get update && apt-get install yarn\n\nWORKDIR /var/www/symfony\n```\n\nIl vous faut aussi ajouter la configuration de nginx. Dans le dossier `nginx`vous devez ajouter la configuration par défaut suivante.\n\n```json\n/nginx/ngin.conf\nuser www-data;\nworker_processes 4;\npid /run/nginx.pid;\n\nevents {\n  worker_connections  2048;\n  multi_accept on;\n  use epoll;\n}\n\nhttp {\n  server_tokens off;\n  sendfile on;\n  tcp_nopush on;\n  tcp_nodelay on;\n  keepalive_timeout 15;\n  types_hash_max_size 2048;\n  include /etc/nginx/mime.types;\n  default_type application/octet-stream;\n  access_log off;\n  error_log off;\n  gzip on;\n  gzip_disable \"msie6\";\n  include /etc/nginx/conf.d/*.conf;\n  include /etc/nginx/sites-enabled/*;\n  open_file_cache max=100;\n}\n\ndaemon off;\n```\n\nPuis ajouter la configuration de votre application symfony.\n\n```json\n/nginx/symfony.conf\nserver {\n    server_name infinite.dev;\n    root /var/www/symfony/web;\n\n    location / {\n        try_files $uri @rewriteapp;\n    }\n\n    location @rewriteapp {\n        rewrite ^(.*)$ /app.php/$1 last;\n    }\n\n    location ~ ^/(app|app_dev|config)\\.php(/|$) {\n        fastcgi_pass php-upstream;\n        fastcgi_split_path_info ^(.+\\.php)(/.*)$;\n        include fastcgi_params;\n        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;\n        fastcgi_param HTTPS off;\n    }\n\n    error_log /var/log/nginx/symfony_error.log;\n    access_log /var/log/nginx/symfony_access.log;\n}\n```\n\nIl ne vous reste plus qu'à ajouter le fichier `docker-compose.yml`à la racine de votre projet avec la configuration suivante.\n\n```yml\nversion: '2'\n\nservices:\n    postgres:\n        image: postgres:9.6\n        ports:\n            - ${POSTGRES_PORT}:5432\n        volumes:\n            - ./.data/pgdata:/var/lib/postgresql/data\n        environment:\n            POSTGRES_DB: ${POSTGRES_DB}\n            POSTGRES_USER: ${POSTGRES_USER}\n            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}\n    php:\n        build: docker/php7-fpm\n        env_file: ./.env\n        volumes:\n            - ${SYMFONY_APP_PATH}:/var/www/symfony\n        links:\n            - postgres\n    nginx:\n        build: docker/nginx\n        ports:\n            - ${WEB_PORT}:80\n        volumes_from:\n            - php\n        volumes:\n            - ${LOGS_DIR}/nginx/:/var/log/nginx\n    node:\n        build: docker/node\n        volumes:\n            - ${SYMFONY_APP_PATH}:/var/www/symfony\n        command: bash -c \"yarn install && yarn watch\"\n```\n\nAjoutez la ligne suivante dans votre `/etc/hosts`\n\n```sh\n120.0.0.1 infinite.dev\n```\n\nSi vous lancez un `docker-compose up` puis allez sur la page suivante [infinite.dev](infinite.dev), vous devriez voir la page suivante vous indiquant que votre site est bien configuré.\n\n![Configuration](/imgs/posts/2017-09-10-flux-infini-react-symfony/image1.png)\n\nUne partie de la configuration est tirée de l'article de Maxence Poutord disponible [ici](http://www.maxpou.fr/docker-pour-symfony/){:rel=\"nofollow noreferrer\"}.\n\nVous pouvez aussi retrouver le code directement dans le projet [Infinite github](https://github.com/CaptainJojo/infinite) dans la branche [configuration](https://github.com/CaptainJojo/infinite/tree/configuration){:rel=\"nofollow noreferrer\"}.\n\n### Mettre en place React\n\nNous allons utiliser React/Redux pour mettre en place notre flux infini. Comme tous les projets node la première chose à faire est d'ajouter à la racine de votre projet le fichier `package.json`. Comme nous utiliserons [Babel](https://babeljs.io/) pour la compilation de [l'ES2105](https://babeljs.io/learn-es2015/) il faut le mettre dans la configuration du projet, ainsi que l'utilisation [EsLint](https://eslint.org/) parce que même dans un tutoriel nous faisons les choses proprement. Bien sur il nous faut aussi [React](https://facebook.github.io/react/) et [Redux](http://redux.js.org/){:rel=\"nofollow noreferrer\"}  pour avoir notre configuration au complet. Vous pouvez alors ajouter l'ensemble dans votre fichier `package.json`\n\n```json\n{\n  \"name\": \"infinite\",\n  \"version\": \"0.0.1\",\n  \"engines\": {\n    \"node\": \"6.x\"\n  },\n  \"private\": true,\n  \"description\": \"Infinite flux\",\n  \"main\": \"index.js\",\n  \"scripts\": {\n    \"build\": \"webpack --config app/config/webpack.config.js -p\",\n    \"lint\": \"eslint src app/config --ext .js --ext .jsx\",\n    \"lint:fix\": \"npm run lint -- --fix\",\n    \"test\": \"jest\",\n    \"test:coverage\": \"jest --coverage\",\n    \"watch\": \"webpack --config app/config/webpack.config.js --devtool source-map --debug --watch --display-error-details\",\n  },\n  \"repository\": {\n    \"type\": \"git\",\n    \"url\": \"git+https://github.com/captainjojo/infinite.git\"\n  },\n  \"bugs\": {\n    \"url\": \"https://github.com/captainjojo/infinite/issues\"\n  },\n  \"homepage\": \"https://github.com/captainjojo/infinite#readme\",\n  \"devDependencies\": {\n    \"babel-core\": \"^6.14.0\",\n    \"babel-jest\": \"^15.0.0\",\n    \"babel-loader\": \"^6.2.5\",\n    \"babel-preset-react\": \"^6.11.1\",\n    \"eslint\": \"^3.2.0\",\n    \"eslint-config-airbnb\": \"^10.0.1\",\n    \"eslint-import-resolver-webpack\": \"^0.8.0\",\n    \"eslint-plugin-import\": \"^1.14.0\",\n    \"eslint-plugin-jsx-a11y\": \"^2.2.1\",\n    \"eslint-plugin-react\": \"^6.2.0\",\n    \"jest\": \"^18.0.0\",\n    \"react-test-renderer\": \"^15.3.1\"\n  },\n  \"dependencies\": {\n    \"babel-polyfill\": \"^6.16.0\",\n    \"babel-preset-es2015\": \"^6.18.0\",\n    \"clean-webpack-plugin\": \"^0.1.14\",\n    \"lodash\": \"^4.15.0\",\n    \"react\": \"^15.3.1\",\n    \"react-dom\": \"^15.3.1\",\n    \"react-redux\": \"^4.4.5\",\n    \"redux\": \"^3.6.0\",\n    \"redux-thunk\": \"^2.1.0\",\n    \"release-it\": \"^2.5.1\",\n    \"webpack\": \"^v2.2.0-rc.3\",\n    \"whatwg-fetch\": \"^2.0.0\"\n  },\n  \"jest\": {\n    \"cacheDirectory\": \"var/jest\",\n    \"coverageDirectory\": \"build/coverage/jest\",\n    \"moduleFileExtensions\": [\n      \"js\",\n      \"jsx\"\n    ],\n    \"transformIgnorePatterns\": [\n      \"/node_modules/(?!o-.*)/\"\n    ],\n    \"moduleNameMapper\": {\n      \"^actions(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/react/actions$1\",\n      \"^components(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/react/components$1\",\n      \"^containers(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/react/containers$1\",\n      \"^helpers(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/helpers$1\",\n      \"^lib(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/lib$1\",\n      \"^reducers(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/react/reducers$1\",\n      \"^store(.*)\": \"<rootDir>/src/AppBundle/Resources/scripts/js/react/store$1\"\n    },\n    \"testRegex\": \".*.(test|spec).js[x]?$\"\n  }\n}\n```\n\nComme vous pouvez le constater nous allons utiliser [Webpack](https://webpack.github.io/docs/)  pour compiler et préparer nos fichiers javascript. Vous avez aussi en fin du fichier la configuration de [Jest](https://facebook.github.io/jest/){:rel=\"nofollow noreferrer\"} qui sera l'outil qui va nous permettre de mettre en place les tests unitaires et les tests visuels de notre application javascript. La configuration Jest permet ici de *mapper* les noms des modules lors d'un import javascript avec l'emplacement des fichiers.\n\nIl faut donc ajouter les fichiers pour la configuration de Babel et d'Eslint. Pour Babel il vous faut ajouter le fichier `.babelrc` à la racine de votre projet.\n\n```json\n{\n    \"presets\": [\"es2015\", \"react\"]\n}\n```\n\nPour la configuration d'Eslint il vous faut ajouter le fichier `.eslintrc.yml` à la racine de votre projet.\n\n```yml\n---\n    extends: \"airbnb\"\n    env:\n        node: true\n        browser: true\n        jest: true\n    settings:\n        import/resolver:\n            webpack:\n                config: 'app/config/webpack.config.js'\n```\n\nMaintenant la grande question qu'il faut se poser c'est où mettre en place l'architecture javascript pour qu'elle communique et interagisse facilement avec Symfony ? *La décision n'a pas été facile et n'est pas forcément la meilleure*.\n\nCommençons par la mise en place de la configuration `webpack`, nous la placerons dans le dossier `app/config` de Symfony.  Vous devez ajouter le fichier `webpack.config.js`suivant :\n\n```js\nconst _ = require('lodash');\nconst fs = require('fs');\nconst resolve = require('path').resolve;\nconst webpack = require('webpack');\n\nconst CleanWebpackPlugin = require('clean-webpack-plugin');\n\nconst env = process.env.NODE_ENV === 'prd' ? 'production' : 'development';\nconst root = `${__dirname}/../../`;\nconst paths = {\n  assets: resolve(root, 'src/AppBundle/Resources/views/Assets/'),\n  scripts: resolve(root, 'web/scripts/js'),\n  context: resolve(root, 'src/AppBundle/Resources/scripts/js/'),\n};\n\nconst manifestPlugin = (file, path) => ({\n  apply: (compiler) => {\n    compiler.plugin('done', (stats) => {\n      fs.writeFileSync(\n        resolve(path, file),\n        JSON.stringify(\n          _.mapValues(\n            stats.toJson().assetsByChunkName,\n            (chunk) => (env === 'development' ? chunk[0] : chunk)),\n          null,\n          '\\t'\n        )\n      );\n    });\n  },\n});\n\nconst config = {\n  context: paths.context,\n  entry: {\n    /**\n     * Contain all the vendors entries\n     *\n     * Vendors library (React, Lodash, ...)\n     * Polyfills\n     */\n    vendor: [\n      // Polyfills\n      'core-js/es6/object',\n      'core-js/es6/promise',\n      'whatwg-fetch',\n\n      // Vendors\n      'lodash/isEqual',\n      'react',\n      'react-dom',\n      'react-redux',\n      'redux',\n      'redux-thunk',\n    ],\n    /**\n     * Each of the following entries represent the single entrypoints\n     * for a given page type\n     */\n    home: [\n      'entrypoints/latest_news_home.jsx',\n    ],\n  },\n  module: {\n    loaders: [\n      {\n        test: /\\.jsx?$/,\n        exclude: /node_modules\\/(?!o-.*)/,\n        loader: 'babel-loader',\n        query: {\n          presets: ['react', ['es2015', { modules: false }]],\n        },\n      },\n    ],\n  },\n  output: {\n    filename: '[name].[chunkhash].js',\n    path: paths.scripts,\n  },\n  performance: {\n    hints: env === 'production' ? 'warning' : false,\n  },\n  plugins: [\n    new webpack.optimize.CommonsChunkPlugin({\n      names: ['vendor', 'inlined'],\n      minChunks: Infinity,\n    }),\n    new CleanWebpackPlugin(['**'], {\n      root: paths.scripts,\n    }),\n    new webpack.DefinePlugin({\n      'process.env': {\n        NODE_ENV: JSON.stringify(env),\n      },\n    }),\n    manifestPlugin('manifest.json', resolve(root, 'var/webpack/')),\n  ],\n  resolve: {\n    alias: {\n      actions: 'react/actions',\n      components: 'react/components',\n      containers: 'react/containers',\n      helpers: 'helpers',\n      lib: 'lib',\n      reducers: 'react/reducers',\n      store: 'react/store',\n    },\n    extensions: ['.js', '.jsx'],\n    modules: [\n      'node_modules',\n      './src/AppBundle/Resources/scripts/js',\n    ],\n  },\n  target: 'web',\n};\n\nif (env === 'production') {\n  config.plugins.push(\n    new webpack.LoaderOptionsPlugin({\n      minimize: true,\n    })\n  );\n  config.plugins.push(\n    new webpack.optimize.UglifyJsPlugin({\n      minimize: true,\n      compress: {\n        negate_iife: true,\n        unused: true,\n        dead_code: true,\n        drop_console: true,\n        warnings: false,\n      },\n      output: { comments: false },\n    })\n  );\n}\n\nmodule.exports = config;\n```\n\nPuis comme pour l'ensemble des fichiers javascript d'un projet javascript, nous allons les mettre dans les `ressources` du `bundle` Symfony.\n\nNous allons créer la coquille d'une architecture Rect/Redux à l'intérieur du dossier `src/AppBundle/Resources/scripts/js/react` pour cela, créez les dossiers suivants :\n\n - `actions`\n - `containers`\n - `reducers`\n - `store`\n\nDans chaque dossier nous allons commencer à créer notre architecture. Le but du tutoriel n'étant pas la compréhension d'une architecture React/Redux, si vous le souhaitez je vous invite à lire [ceci](http://redux.js.org/docs/introduction/){:rel=\"nofollow noreferrer\"}.\n\nAjoutez le fichier `index.js` dans le dossier `store` avec le code suivant.\n\n```js\nimport { createStore, applyMiddleware } from 'redux';\nimport thunk from 'redux-thunk';\n\nimport reducers from 'reducers';\n\nexport default function configureStore(initial) {\n  return createStore(reducers, initial, applyMiddleware(thunk));\n}\n```\nLe fichier est assez simple et permet seulement de gérer votre store.\n\nAjoutez le fichier `index.js` dans le dossier `reducers` avec le code suivant :\n\n```js\nimport { combineReducers } from 'redux';\n\nimport latestNews from './latest_news';\n\nexport default combineReducers({\n  latestNews,\n});\n```\n\nNous allons créer le premier `reducers` du projet qui ensuite contiendra les changements d'état de notre application. Ajoutez le fichier `latest_news.js` avec le code suivant :\n\n```js\nimport actions from 'actions';\n\nexport default function latestNews(state = {}, action) {\n  switch (action.type) {\n    default:\n      return state;\n  }\n}\n```\n\nVous pouvez maintenant créer les fichiers d' `actions` en commençant par le fichier `index.js`\n\n```js\nimport * as latestNews from './latest_news';\n\nconst actions = {\n  latestNews,\n};\n\nexport default actions;\n```\n\nPuis le fichier `latest_news.js` qui sera vide.\n\n Terminons par l'affichage en créant un fichier `jsx` très simple dans le dossier `containers` , ajoutez le fichier `LatestNewsHome.jsx` qui contiendra l'affichage.\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport { connect } from 'react-redux';\n\nimport actions from 'actions';\n\nclass LatestNewsHome extends Component {\n  constructor() {\n    super();\n  }\n\n  componentDidMount() {\n  }\n\n  render() {\n    return (\n      <div>Coucou</div>\n    );\n  }\n}\n\nLatestNewsHome.propTypes = {\n};\n\nconst mapStateToProps = (state) => ({\n});\n\nexport default connect(mapStateToProps)(LatestNewsHome);\n```\n\nVoilà notre architecture React/Redux terminée, il nous faut maintenant la faire communiquer avec Symfony.\n\n### Faire communiquer React et Symfony\n\nIl vous faut un point d'entrée entre React et Symfony pour vous permettre de lancer votre application React. Dans le dossier `src/AppBundle/Resources/scripts/js/entrypoints` ajoutez un fichier `latest_news_home.jsx` contenant l'initialisation de votre React.\n\n```js\nimport React from 'react';\nimport { render } from 'react-dom';\nimport { Provider } from 'react-redux';\n\nimport LatestNewsHome from 'containers/LatestNewsHome.jsx';\nimport configureStore from 'store';\n\nconst elements = {\n  latest_news: document.getElementById('react-latest-news-home'),\n};\n\n// eslint-disable-next-line no-underscore-dangle\nconst store = configureStore(window.__INITIAL_STATE__);\n\nconst component = (\n  <Provider store={store}>\n    <LatestNewsHome />\n  </Provider>\n);\n\nrender(component, elements.latest_news);\n```\n\nComme vous pouvez le voir, nous allons insérer notre composant React dans notre page HTML via la balise avec l'id `react-latest-news-home`.\n\nIl faut donc dans votre fichier template Twig ajouter cet `id`.\n\n*Pour le tutoriel j'utilise les pages par défaut du projet Symfony, à vous de choisir votre page*\n\nDans la page `app/Resources/views/default/index.html.twig` changez le `block` body avec le code suivant.\n\n\n```twig\n{% extends 'base.html.twig' %}\n\n{% block body %}\n    <div id=\"react-latest-news-home\" >\n    <div>\n{% endblock %}\n\n{% block javascripts %}\n{% endblock  %}\n\n{% block stylesheets %}\n{% endblock %}\n```\n\n\nSi vous lancez votre site il ne se passe rien... Et oui, il manque les appels javascript.\n\nSi vous lancez un `yarn watch` vous verrez que les fichiers sont générés dans votre dossier `web/scripts/js` sous trois formes :\n\n 1. `vendor.*.js` contenant les librairies React etc...\n 2. `home.*.js` contenant le code de votre composant\n 3. `inlined.*.js` contenant la configuration de webpack\n\nLe [cache busting](https://www.keycdn.com/support/what-is-cache-busting/){:rel=\"nofollow noreferrer\"} est déjà intégré dans la configuration Webpack.\n\nIl nous faut maintenant ajouter les balises `scripts` dans votre page `twig`. La facilité serait de poser la balise suivante :\n\n```html\n<script src=\"http://infinite.dev/scripts/js/inlined.2d4b19e4578c3af04a03.js\" defer></script>\n<script src=\"http://infinite.dev/scripts/js/vendor.2d4b19e4578c3af04a03.js\" defer></script>\n<script src=\"http://infinite.dev/scripts/js/home.e428223280fc3028d63f.js\" defer></script>\n```\n\nCela n'est pas très pratique car vous devez changer vos balises à chaque changement de javascript. Nous voulons donc utiliser la fonction `asset` de twig comme pour tout autre javascript.  Vous pouvez mettre dans votre `block javascript` les deux balises suivantes :\n\n\n```twig\n{% block javascripts %}\n<script src=\"{{ asset('inlined.js', 'js') }}\" defer></script>\n<script src=\"{{ asset('vendor.js', 'js') }}\" defer></script>\n<script src=\"{{ asset('home.js', 'js') }}\" defer></script>\n{% endblock  %}\n```\n\n\nSi vous testez maintenant vous avez deux 404. Effectivement `asset`ne prend pas en compte le cache busting mais nous allons l'aider.\n\nNous allons créer un service permettant de gérer l'utilisation du cache busting. Dans votre fichier `config.yml` vous pouvez surcharger la function `asset`.  Si vous voulez mieux comprendre vous pouvez allez lire l'article de Symfony [ici](https://symfony.com/doc/current/frontend/custom_version_strategy.html){:rel=\"nofollow noreferrer\"}.\n\n```yml\nframework:\n    #esi: ~\n    #translator: { fallbacks: ['%locale%'] }\n    secret: '%secret%'\n    router:\n        resource: '%kernel.project_dir%/app/config/routing.yml'\n        strict_requirements: ~\n    form: ~\n    csrf_protection: ~\n    validation: { enable_annotations: true }\n    #serializer: { enable_annotations: true }\n    templating:\n        engines: ['twig']\n    default_locale: '%locale%'\n    trusted_hosts: ~\n    session:\n        # https://symfony.com/doc/current/reference/configuration/framework.html#handler-id\n        handler_id: session.handler.native_file\n        save_path: '%kernel.project_dir%/var/sessions/%kernel.environment%'\n    fragments: ~\n    http_method_override: true\n    assets: ~\n    php_errors:\n        log: true\n    assets:\n        packages:\n            js:\n                base_urls: 'http://infinite.dev/scripts/js'\n                version_strategy: 'app.assets.js.version_strategy'\n```\n\nPuis nous allons ajouter le service dans notre bundle. Commençons par créer le `service.yml`\n\n```yml\nservices:\n    app.assets.js.version_strategy:\n        class: AppBundle\\Service\\VersionStrategy\\JavascriptBusterVersionStrategy\n        arguments:\n            - '%kernel.root_dir%/../var/webpack/manifest.json'\n```\n\nNous utiliserons la `manifest.json` de webpack qui nous permettra de connaître la version actuelle du cache busting.\n\nIl ne vous reste plus qu'à ajouter le fichier `src/AppBundle/Service/VersionStrategy/JavascriptBusterVersionStrategy.php` avec le code suivant :\n\n```php\n<?php\n\nnamespace AppBundle\\Service\\VersionStrategy;\n\nuse Symfony\\Component\\Asset\\VersionStrategy\\VersionStrategyInterface;\n\nclass JavascriptBusterVersionStrategy implements VersionStrategyInterface\n{\n    /**\n     * The manifest object containing for each entry\n     * the filename containing the version.\n     *\n     * @var array\n     */\n    private $hashes = [];\n\n    /**\n     * The manifest file path.\n     *\n     * @var string\n     */\n    private $path;\n\n    /**\n     * @param string $path The manifest file path\n     */\n    public function __construct(string $path)\n    {\n        $this->path = $path;\n    }\n\n    /**\n     * {@inheritdoc}\n     */\n    public function getVersion($asset): string\n    {\n        $this->ensureHashesLoaded();\n\n        preg_match(\n            // Matches pattern like 'vendor.67e29947398bcbf9b383.js'\n            '/(?:.*)\\.([[:alnum:]]*)\\.js/',\n            $this->hashes[$this->getEntryName($asset)] ?? '',\n            $matches\n        );\n\n        return $matches[1] ?? '';\n    }\n\n    /**\n     * {@inheritdoc}\n     */\n    public function applyVersion($asset): string\n    {\n        $this->ensureHashesLoaded();\n\n        return $this->hashes[$this->getEntryName($asset)] ?? '';\n    }\n\n    /**\n     * Return the manifest entry name for the given asset.\n     *\n     * @return string\n     */\n    private function getEntryName($path): string\n    {\n        // Replace pattern like 'vendor.js' into 'vendor'\n        return preg_replace(\n            '/(.*)\\.js/',\n            '$1',\n            $path\n        );\n    }\n\n    /**\n     * Load hashes from manifest if needed.\n     */\n    private function ensureHashesLoaded()\n    {\n        if (empty($this->hashes)) {\n            $this->hashes = json_decode(file_get_contents($this->path), true);\n        }\n    }\n}\n```\n\nVous n'avez normalement plus de 404, mais une erreur javascript signalant que vous n'avez pas d'`__INITIAL_STATE__` pour votre composant React.\n\nNous allons donc le configurer dans votre fichier Twig, en ajoutant une valeur par défaut.\n\n\n```twig\n{% block javascripts %}\n{% set initial_state = {latestNews: {}} %}\n<script>window.__INITIAL_STATE__ = {{ initial_state|json_encode|raw }};</script>\n<script src=\"{{ asset('inlined.js', 'js') }}\" defer></script>\n<script src=\"{{ asset('vendor.js', 'js') }}\" defer></script>\n<script src=\"{{ asset('home.js', 'js') }}\" defer></script>\n{% endblock  %}\n```\n\n\nVous pouvez aussi retrouver le code directement dans le projet [Infinite github](https://github.com/CaptainJojo/infinite) dans la branche [communication](https://github.com/CaptainJojo/infinite/tree/communication){:rel=\"nofollow noreferrer\"}.\n\n### On code le flux infini\n\n#### Partie Symfony\n\nDans ce flux nous allons mettre des articles contenant seulement une date et un titre. Nous aurons besoin d'initialiser le composant React avec les X premiers articles, puis pour chaque passage sur le `voir plus` d'un appel vers un webservice qui nous renverra les articles suivants.\n\n*Pour ce tutoriel, nous allons seulement utiliser des `fixtures` à vous de jouer pour le reste.*\n\nNous allons créer l'`Entity`article en ajoutant le fichier `src/AppBundle/Entity/Article.php` avec le code suivant :\n\n```php\n<?php\n\nnamespace AppBundle\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * Class Article\n * @package AppBundle\\Entity\n *\n * @ORM\\Table(name=\"article\")\n * @ORM\\Entity(repositoryClass=\"AppBundle\\Repository\\ArticleRepository\")\n */\nclass Article\n{\n    /**\n     * @var int $id\n     *\n     * @ORM\\Column(name=\"id\", type=\"integer\")\n     * @ORM\\Id\n     * @ORM\\GeneratedValue(strategy=\"AUTO\")\n     */\n    private $id;\n\n    /**\n     * @var string $title\n     *\n     * @ORM\\Column(name=\"title\", type=\"string\", nullable=false)\n     */\n    private $title;\n\n    /**\n     * @var datetime $created\n     *\n     * @ORM\\Column(name=\"created_at\", type=\"datetime\", nullable=false)\n     */\n    protected $createdAt;\n\n\n    /**\n     * @return int\n     */\n    public function getId(): int\n    {\n        return $this->id;\n    }\n\n    /**\n     * @param string $title\n     *\n     * @return Article\n     */\n    public function setTitle(string $title): Article\n    {\n        $this->title = $title;\n\n        return $this;\n    }\n\n    /**\n     * @return string\n     */\n    public function getTitle(): string\n    {\n        return $this->title;\n    }\n\n    /**\n     * @return \\DateTime\n     */\n    public function getCreatedAt()\n    {\n        return $this->createdAt;\n    }\n\n    /**\n     * @param \\DateTime $createdAt\n     * @return Article\n     */\n    public function setCreatedAt(\\DateTime $createdAt): Article\n    {\n        $this->createdAt = $createdAt;\n\n        return $this;\n    }\n}\n```\n\nEnsuite en suivant l'article [ici](http://symfony.com/doc/master/bundles/DoctrineFixturesBundle/index.html){:rel=\"nofollow noreferrer\"}, permettant de mettre en place des fixtures doctrine, vous pouvez ajouter dans votre `composer.json`\n\n```json\n    \"require-dev\": {\n        \"doctrine/doctrine-fixtures-bundle\": \"^2.3\"\n    }\n```\n\nPuis dans votre `AppKernel.php`\n\n```php\n<?php\n\nuse Symfony\\Component\\HttpKernel\\Kernel;\nuse Symfony\\Component\\Config\\Loader\\LoaderInterface;\n\nclass AppKernel extends Kernel\n{\n    public function registerBundles()\n    {\n        $bundles = [\n            new Symfony\\Bundle\\FrameworkBundle\\FrameworkBundle(),\n            new Symfony\\Bundle\\SecurityBundle\\SecurityBundle(),\n            new Symfony\\Bundle\\TwigBundle\\TwigBundle(),\n            new Symfony\\Bundle\\MonologBundle\\MonologBundle(),\n            new Symfony\\Bundle\\SwiftmailerBundle\\SwiftmailerBundle(),\n            new Doctrine\\Bundle\\DoctrineBundle\\DoctrineBundle(),\n            new Sensio\\Bundle\\FrameworkExtraBundle\\SensioFrameworkExtraBundle(),\n            new AppBundle\\AppBundle(),\n        ];\n\n        if (in_array($this->getEnvironment(), ['dev', 'test'], true)) {\n            $bundles[] = new Symfony\\Bundle\\DebugBundle\\DebugBundle();\n            $bundles[] = new Symfony\\Bundle\\WebProfilerBundle\\WebProfilerBundle();\n            $bundles[] = new Sensio\\Bundle\\DistributionBundle\\SensioDistributionBundle();\n            $bundles[] = new Doctrine\\Bundle\\FixturesBundle\\DoctrineFixturesBundle();\n\n            if ('dev' === $this->getEnvironment()) {\n                $bundles[] = new Sensio\\Bundle\\GeneratorBundle\\SensioGeneratorBundle();\n                $bundles[] = new Symfony\\Bundle\\WebServerBundle\\WebServerBundle();\n            }\n        }\n\n        return $bundles;\n    }\n\n    public function getRootDir()\n    {\n        return __DIR__;\n    }\n\n    public function getCacheDir()\n    {\n        return dirname(__DIR__).'/var/cache/'.$this->getEnvironment();\n    }\n\n    public function getLogDir()\n    {\n        return dirname(__DIR__).'/var/logs';\n    }\n\n    public function registerContainerConfiguration(LoaderInterface $loader)\n    {\n        $loader->load($this->getRootDir().'/config/config_'.$this->getEnvironment().'.yml');\n    }\n}\n```\n\nPour terminer, ajoutez le fichier `src/AppBundle/DataFixtures/ORM/LoadArticleData.php` contenant les données que l'on utilisera pour la suite.\n\n```php\n<?php\n\nnamespace AppBundle\\DataFixtures\\ORM;\n\nuse AppBundle\\Entity\\Article;\nuse Doctrine\\Common\\DataFixtures\\AbstractFixture;\nuse Doctrine\\Common\\DataFixtures\\OrderedFixtureInterface;\nuse Doctrine\\Common\\Persistence\\ObjectManager;\n\n/**\n * Class LoadArticleData\n * @package AppBundle\\DataFixtures\\ORM\n *\n *\n * @codeCoverageIgnore\n */\nclass LoadArticleData  extends AbstractFixture implements OrderedFixtureInterface\n{\n    /**\n     * @param ObjectManager $manager\n     *\n     * @return void\n     */\n    public function load(ObjectManager $manager): void\n    {\n        foreach ($this->getData() as $data) {\n            $article = new Article();\n            $article->setTitle($data['title']);\n            $article->setCreatedAt($data['created_at']);\n\n            $manager->persist($article);\n        }\n\n        $manager->flush();\n        $manager->clear();\n    }\n\n    /**\n     * @return int\n     */\n    public function getOrder(): int\n    {\n        return 1;\n    }\n\n    /**\n     * @return array\n     */\n    private function getData(): array\n    {\n        return [\n            ['title' => 'MIGRER UNE APPLICATION REACT CLIENT-SIDE EN SERVER-SIDE AVEC NEXT.JS', 'created_at' => new \\DateTime('03-09-2017')],\n            ['title' => 'VOTRE CI DE QUALITÉ', 'created_at' => new \\DateTime('30-08-2017')],\n            ['title' => 'JSON SERVER', 'created_at' => new \\DateTime('25-08-2017')],\n            ['title' => 'BUILD AN API WITH API PLATFORM', 'created_at' => new \\DateTime('24-08-2017')],\n            ['title' => 'RETOUR SUR UN LIVE-CODING DE DÉCOUVERTE DU LANGAGE GO', 'created_at' => new \\DateTime('23-08-2017')],\n            ['title' => 'FEEDBACK ON A LIVE-CODING TO DISCOVER GO LANGUAGE', 'created_at' => new \\DateTime('23-08-2017')],\n            ['title' => 'HOW TO CHECK THE SPELLING OF YOUR DOCS FROM TRAVIS CI?', 'created_at' => new \\DateTime('18-08-2017')],\n            ['title' => 'COMMENT VÉRIFIER L\\'ORTHOGRAPHE DE VOS DOCS DEPUIS TRAVIS CI ?', 'created_at' => new \\DateTime('18-08-2017')],\n            ['title' => 'JSON SERVER', 'created_at' => new \\DateTime('16-08-2017')],\n            ['title' => 'ANDROID ET LES DESIGN PATTERNS', 'created_at' => new \\DateTime('09-08-2017')],\n            ['title' => 'CONTINUOUS IMPROVEMENT: HOW TO RUN YOUR AGILE RETROSPECTIVE?', 'created_at' => new \\DateTime('03-08-2017')],\n            ['title' => 'CONSTRUIRE UNE API EN GO', 'created_at' => new \\DateTime('26-07-2017')],\n            ['title' => 'CRÉER UNE API AVEC API PLATFORM', 'created_at' => new \\DateTime('25-07-2017')],\n            ['title' => 'LES PRINCIPAUX FORMATS DE FLUX VIDEO LIVE DASH ET HLS', 'created_at' => new \\DateTime('19-07-2017')],\n            ['title' => 'MIGRATION DU BLOG', 'created_at' => new \\DateTime('11-07-2017')],\n            ['title' => 'TAKE CARE OF YOUR EMAILS', 'created_at' => new \\DateTime('05-07-2017')],\n            ['title' => 'ENVOYER DES PUSH NOTIFICATIONS VIA AMAZON SNS EN SWIFT 3', 'created_at' => new \\DateTime('28-06-2017')],\n            ['title' => 'CONSTRUCT AND STRUCTURE A GO GRAPHQL API', 'created_at' => new \\DateTime('15-06-2017')],\n            ['title' => 'IS AMP THE WEB 3.0', 'created_at' => new \\DateTime('14-06-2017')],\n            ['title' => 'CONSTRUIRE ET STRUCTURER UNE API GRAPHQL EN GO', 'created_at' => new \\DateTime('07-06-2017')],\n        ];\n    }\n}\n```\n\nVous pouvez lancer la commande suivante `php bin/console doctrine:fixtures:load` pour insérer les données dans votre base de données.\n\nFonctionnellement nous voulons afficher les articles par ordre de dernière création, l'idée est donc qu'un clic sur le bouton `voir plus` permette de voir les articles antérieurs.\n\n    Mais comment être sur d'avoir les articles les plus anciens ?\n\nEn effet, si on utilise seulement l'offset et le limit il se peut qu'un article s'insère dans notre flux. Nous allons donc prendre les articles qui sont plus anciens que le dernier article qui s'est affiché.\n\nDans le dossier `src/AppBundle/Repository/ArticleRepository.php` nous allons mettre la `query`qu'il faudra utiliser pour récupérer les contenus.\n\n```php\n<?php\n\nnamespace AppBundle\\Repository;\n\nuse Doctrine\\ORM\\EntityRepository;\n\n/**\n * Class ArticleRepository\n * @package AppBundle\\Repository\n */\nclass ArticleRepository extends EntityRepository\n{\n    public function getArticles(int $lastNewsDate, int $limit)\n    {\n        $lastNewsDateTime = new \\Datetime();\n        $lastNewsDateTime->setTimestamp($lastNewsDate);\n\n        $qb = $this->createQueryBuilder('b')\n            ->where('b.createdAt < :lastNewsDate')\n            ->setParameter('lastNewsDate', $lastNewsDateTime)\n            ->orderBy('b.createdAt', 'DESC')\n            ->getQuery()\n            ->setMaxResults($limit);\n\n        return $qb;\n    }\n}\n```\n\nMaintenant nous allons initialiser le composant React avec les premiers articles. Nous le faisons dans la partie PHP car nous voulons que l'utilisateur n'ayant pas javascript voie tout de même les articles.\n\nDans votre fichier `src/AppBundle/Controller/DefaultController.php` vous pouvez changer votre `indexAction` avec le code suivant\n\n```php\n<?php\n\nnamespace AppBundle\\Controller;\n\nuse Sensio\\Bundle\\FrameworkExtraBundle\\Configuration\\Route;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\Controller;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\JsonResponse;\nuse AppBundle\\Entity\\Article;\n\nclass DefaultController extends Controller\n{\n    /**\n     * @Route(\"/\", name=\"homepage\")\n     */\n    public function indexAction(Request $request)\n    {\n        $articles = $this->getDoctrine()\n            ->getRepository(Article::class)\n            ->getArticles(time(), 3)\n            ->getResult();\n\n        $jsonArticles = [];\n        foreach ($articles as $article) {\n            $jsonArticles[] = [\n                'id' => $article->getId(),\n                'title' => $article->getTitle(),\n                'createdAt' => $article->getCreatedAt()->getTimestamp()\n            ];\n        }\n\n        return $this->render('default/index.html.twig', [\n            'latestNews' => $jsonArticles,\n            'lastItemDate' => $jsonArticles[count($jsonArticles) - 1]['createdAt']\n        ]);\n    }\n```\n\nPuis nous allons ajouter le webservice dans ce même fichier.\n\n```php\n<?php\n\nnamespace AppBundle\\Controller;\n\nuse Sensio\\Bundle\\FrameworkExtraBundle\\Configuration\\Route;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\Controller;\nuse Symfony\\Component\\HttpFoundation\\Request;\nuse Symfony\\Component\\HttpFoundation\\JsonResponse;\nuse AppBundle\\Entity\\Article;\n\nclass DefaultController extends Controller\n{\n\t/****\n\tIndex Action\n\t****/\n\n    /**\n     * @Route(\"/ws\", name=\"ws\")\n     */\n    public function wsAction(Request $request)\n    {\n        $lastItemDate = (int) ($request->get('last_item_date') ?? time());\n        $articles = $this->getDoctrine()\n            ->getRepository(Article::class)\n            ->getArticles($lastItemDate, 3)\n            ->getResult();\n\n        $jsonArticles = [];\n        foreach ($articles as $article) {\n            $jsonArticles[] = [\n                'id' => $article->getId(),\n                'title' => $article->getTitle(),\n                'createdAt' => $article->getCreatedAt()->getTimestamp()\n            ];\n        }\n\n        return new JsonResponse($jsonArticles);\n    }\n}\n```\n\nDernières choses : faire afficher les articles et initialiser votre React. Il vous faut changer votre fichier `app/Resources/views/default/index.html.twig`\n\n\n```twig\n{% extends 'base.html.twig' %}\n\n{% block body %}\n    <div id=\"react-latest-news-home\" >\n      <ul>\n        {% for article in latestNews %}\n        <li>\n          {{ article.title }}\n        </li>\n        {% endfor %}\n      <ul>\n    <div>\n{% endblock %}\n\n{% block javascripts %}\n{% set initial_state = {\n      latestNews: {\n          data: latestNews,\n          lastItemDate: lastItemDate,\n          limit: 3,\n      },\n  } %}\n<script>window.__INITIAL_STATE__ = {{ initial_state|json_encode|raw }};</script>\n<script src=\"{{ asset('inlined.js', 'js') }}\" defer></script>\n<script src=\"{{ asset('vendor.js', 'js') }}\" defer></script>\n<script src=\"{{ asset('home.js', 'js') }}\" defer></script>\n{% endblock  %}\n\n{% block stylesheets %}\n{% endblock %}\n```\n\n\nSi vous affichez votre site, vous devez voir les trois premiers contenus mais le `voir plus` ne marchera pas, normal nous n'avons pas fini notre React.\n\n\n#### Partie React\n\nPeu de chose à changer, d'abord commençons par changer `src/AppBundle/Resources/scripts/js/react/actions/latest_news.js`\n\n```js\nexport const ERROR = 'latest_news/ERROR';\nexport const FETCH = 'latest_news/FETCH';\nexport const RECEIVE = 'latest_news/RECEIVE';\nexport const SHOW = 'latest_news/SHOW';\n\nconst error = () => ({\n  type: ERROR,\n});\n\nconst fetching = (lastItemDate, limit) => ({\n  lastItemDate,\n  limit,\n  type: FETCH,\n});\n\nconst receive = (news) => ({\n  type: RECEIVE,\n  data: news,\n});\n\nconst show = () => ({\n  type: SHOW,\n});\n\n/**\n * Fetch the data latest_news data\n *\n * @dispatch latest_news/FETCH\n * @dispatch latest_news/RECEIVE\n * @dispatch latest_news/ERROR\n */\nexport const fetch = () => (dispatch, getState) => {\n  const { isFetching, lastItemDate, limit } = getState().latestNews;\n\n  if (isFetching) {\n    return Promise.resolve();\n  }\n\n  let url = `/app_dev.php/ws?last_item_date=${lastItemDate}&limit=${limit}`;\n\n  dispatch(fetching(lastItemDate, limit));\n\n  return window.fetch(url, { credentials: 'same-origin' })\n    .then(response => {\n      if (!response.ok) {\n        return Promise.reject();\n      }\n\n      return response.json();\n    })\n    .then(json => dispatch(receive(json)))\n    .catch(() => dispatch(error()));\n};\n\n/**\n * Prefetch the data latest_news data\n * And display the previously prefetched data\n *\n * @dispatch latest_news/ERROR\n * @dispatch latest_news/FETCH\n * @dispatch latest_news/RECEIVE\n * @dispatch latest_news/SHOW\n */\nexport const prefetch = () => (dispatch, getState) => {\n  dispatch(show());\n\n  return fetch()(dispatch, getState);\n};\n\n/**\n * Refresh the latest views to update their diff time\n */\nexport const refresh = () => ({\n  type: REFRESH,\n});\n```\n\nOn y trouve l'appel au webservice lors de l'action `Fetch`. Pour améliorer les performances nous allons chercher les données lors de l'affichage des données précédentes qui permet d'avoir un coup d'avance sur l'utilisateur.\n\nVous pouvez maintenant changer le `reducers` suivant `src/AppBundle/Resources/scripts/js/react/reducers/latest_news.js`\n\n```js\nimport actions from 'actions';\n\nexport default function latestNews(state = {}, action) {\n  switch (action.type) {\n    case actions.latestNews.FETCH:\n      return Object.assign({}, state, {\n        lastItemDate: action.lastItemDate,\n        limit: action.limit,\n        isFetching: true,\n      });\n    case actions.latestNews.RECEIVE:\n      return Object.assign({}, state, {\n        data: state.data.concat(\n          action.data.map(\n            (article) => Object.assign({}, article, { visible: false })\n          )\n        ),\n        isFetching: false,\n      });\n    case actions.latestNews.SHOW:\n      return Object.assign({}, state, {\n        data: state.data.map(\n          (article) => {\n            if (article.visible === false) {\n              return Object.assign({}, article, { visible: true });\n            }\n\n            return article;\n          }\n        ),\n\n        // Items on the next page must be published prior to the last article on the current page.\n        lastItemDate: (state.data.length === 0 ? 0 : state.data[state.data.length - 1].createdAt),\n      });\n    default:\n      return state;\n  }\n}\n```\n\nPuis terminons les composants. D'abord `src/AppBundle/Resources/scripts/js/react/containers/LatestNewsHome.jsx` qui est le point d'entrée.\n\n```js\nimport React, { Component, PropTypes } from 'react';\nimport { connect } from 'react-redux';\n\nimport actions from 'actions';\nimport ThreadSection from 'components/Organisms/ThreadSection.jsx';\n\nconst REFRESH_INTERVAL = 60; // One minute\n\nclass LatestNewsHome extends Component {\n  constructor() {\n    super();\n\n    this.onButtonClick = this.onButtonClick.bind(this);\n  }\n\n  componentDidMount() {\n    this.props.dispatch(actions.latestNews.fetch());\n  }\n\n  onButtonClick(event) {\n    this.props.dispatch(actions.latestNews.prefetch());\n  }\n\n  render() {\n    const filtered = this.props.latestNews\n      .filter((article) => article.visible === undefined || article.visible);\n\n    return (\n      <ThreadSection\n      articles={filtered}\n      more={!this.props.isFetching}\n      onButtonClick={this.onButtonClick}\n      />\n    );\n  }\n}\n\nLatestNewsHome.propTypes = {\n  dispatch: PropTypes.func.isRequired,\n  isFetching: PropTypes.bool,\n  latestNews: PropTypes.arrayOf(PropTypes.object).isRequired,\n};\n\nconst mapStateToProps = (state) => ({\n  isFetching: state.latestNews.isFetching,\n  latestNews: state.latestNews.data,\n});\n\nexport default connect(mapStateToProps)(LatestNewsHome);\n```\n\nPuis vous pouvez ajouter dans le dossier `src/AppBundle/Resources/scripts/js/react/components` les composants suivants :\n\n - `src/AppBundle/Resources/scripts/js/react/components/Organisms/ThreadSection.jsx`\n\n```js\nimport React, { PropTypes } from 'react';\n\nimport Button from 'components/Atoms/Button.jsx';\n\nconst renderThreadItems = (article, index) => {\n  if (!article.id) {\n    return null;\n  }\n\n  return (\n    <li key={index}>\n     {article.title}\n    </li>\n  );\n};\n\nconst ThreadSection = ({\n  articles = [],\n  more = false,\n  onButtonClick,\n}) => (\n  <div>\n    <ul>\n      {articles.map((article, index) => renderThreadItems(article, index))}\n    </ul>\n    {more && (\n    <div>\n      <Button\n        text=\"Voir Plus\"\n        onClick={onButtonClick}\n        ariaLabel=\"Afficher les contenus plus anciens\"\n      />\n    </div>\n    )}\n  </div>\n  );\n\nThreadSection.propTypes = {\n  articles: PropTypes.arrayOf(PropTypes.object),\n  more: PropTypes.bool,\n  onButtonClick: PropTypes.func,\n};\n\nexport default ThreadSection;\n````\n\n - `src/AppBundle/Resources/scripts/js/react/components/Atoms/Button.jsx`\n\n```js\nimport React, { PropTypes } from 'react';\n\nconst Button = ({onClick = () => {}, text = '', ariaLabel = '' }) => {\n  const attributes = {\n    onClick,\n  };\n\n  if (ariaLabel !== '') {\n    attributes['aria-label'] = ariaLabel;\n  }\n\n  return (<a\n    {...attributes}\n  >\n    {text}\n  </a>\n  );\n};\n\nButton.propTypes = {\n  onClick: PropTypes.func,\n  text: PropTypes.string,\n  ariaLabel: PropTypes.string,\n};\n\nexport default Button;\n````\n\nBravo vous avez terminé votre flux infini.\n\nVous pouvez aussi retrouver le code directement dans le projet [Infinite github](https://github.com/CaptainJojo/infinite){:rel=\"nofollow noreferrer\"} dans la branche `master`.\n\nMerci d'avoir suivi ce tutoriel, si vous avez des questions surtout n'hésitez pas.\n"}