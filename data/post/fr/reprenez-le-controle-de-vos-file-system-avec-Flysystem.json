{"date":"2019-11-20T00:00:00.000Z","title":"Reprenez le contrôle de vos filesystem avec Flysystem","excerpt":"Cet article vous présente comment interagir simplement avec vos systèmes de gestion de fichiers grâce à Flysystem.","readingTime":"16mn","authors":["nicolas"],"categories":["php"],"content":"\n\nLa gestion d’un ou plusieurs systèmes de fichiers dans une application PHP peut s’avérer compliqué, même si de prime abord il semble simple de manipuler des fichiers en local grâce aux fonctions natives. Si l'on regarde [la documentation officielle](https://www.php.net/manual/en/ref.filesystem.php) on peut faire un sytème rapidement comme ceci :\n\n```php\npublic function write(string $content, string $path): void\n{\n    if (file_exists($path)) {\n      // throw exception\n    }\n\n    file_put_contents($path, $content);\n}\n```\n\nC'est donc faisable, mais le jour où vous allez migrer sur un système de fichiers distant comme AWS, vous allez devoir tout recommencer. Il vous faudra installer le SDK AWS, le configurer puis re-développer votre fonction comme ceci :\n\n```php\nuse AWS\\S3\\S3Client\n\nprivate s3Client;\n\npublic function __construct()\n{\n    $options = [\n        'region' => 'us-west-2',\n        'version' => '2006-03-01',\n        'signature_version' => 'v4',\n    ];\n\n    $this->s3Client = new Aws\\S3\\S3Client([\n        'region' => '-- your region --',\n        'version' => 'latest',\n        'credentials' => [\n            'key' => \"-- access key id --\",\n            'secret' => \"-- secret access key --\",\n        ],\n    ]);\n}\n\n\npublic function write(string $content, string $path)\n{\n    $this->s3Client->putObject([\n        'Bucket' => '-- bucket name --',\n        'Key' => $path,\n        'Body' => $content,\n    ]);\n}\n```\n\nEt si demain on vous demande de passer sur Google Cloud Storage ou bien de gérer une multitude de systèmes de fichiers ? Cela va être lourd à écrire et à maintenir, sans parler des tests d'intégration...\n\nPour supporter plusieurs systèmes de fichiers on peut éventuellement mettre en œuvre le patron de conception [Adaptateur](https://fr.wikipedia.org/wiki/Adaptateur_(patron_de_conception)) ce qui nous permettrait d'abstraire les opérations sur les fichiers et de supporter plusieurs implémentations.\n\nLe patron de conception `Adaptateur` permet de convertir l’interface d’une classe en une autre interface attendue par notre système. Cela permet d'adapter des classes dont nous ne maîtrisons pas la signature.\n\nSi l’on prend le cas de notre système de gestion de système de fichiers qui doit utiliser plusieurs clients ou librairies différentes (AWS, SFTP, fonction native, etc...) alors nous pouvons faire comme ceci :\n\n- On crée une classe que l’on va instancier pour manipuler nos fichiers\n\n```php\nclass FileSystem\n{\n    /** @var AdapterInterface */\n    private $adapter;\n\n    public function __construct(AdapterInterface $adapter)\n    {\n        $this->adapter = $adapter;\n    }\n\n    public function write(string $path, string $content, array $config): bool\n    {\n        return $this->adapter->write($path, $content, $config);\n    }\n}\n```\n\n- Puis, on crée une interface qui va définir les méthodes qui devront être implémentées dans notre adaptateur :\n\n```php\ninterface AdapterInterface\n{\n    public function write(string $path, string $content, array $config): bool;\n}\n```\n\n- Enfin, on crée nos _**n**_ adaptateurs :\n\n```php\nclass LocalAdapter implements AdapterInterface\n{\n    public function write(string $path, string $content, array $config): bool\n    {\n        print_r(\"write with local adapter\\n\");\n\n        return true;\n    }\n}\n\n\nclass AWSAdapter implements AdapterInterface\n{\n    private s3Client;\n\n    public function __construct()\n    {\n        $options = [\n            'region' => 'us-west-2',\n            'version' => '2006-03-01',\n            'signature_version' => 'v4',\n        ];\n\n        $this->s3Client = new Aws\\S3\\S3Client([\n            'region' => '-- your region --',\n            'version' => 'latest',\n            'credentials' => [\n                'key' => \"-- access key id --\",\n                'secret' => \"-- secret access key --\",\n            ],\n        ]);\n    }\n\n    public function write(string $path, string $content, array $config): bool\n    {\n        print_r(\"write with aws adapter\\n\");\n\n        return true;\n    }\n}\n```\n\nEt voilà !\n\nSi on teste notre code ça donne ceci :\n\n```php\n$localAdapter = new LocalAdapter();\n$localFileSystem = new FileSystem($localAdapter);\n$localFileSystem->write('', '', []);\n\n$awsAdapter = new AWSAdapter();\n$awsFileSystem = new FileSystem($awsAdapter);\n$awsFileSystem->write('', '', []);\n```\n\n```bash\n$ php index.php\nwrite with local adapter\nwrite with aws adapter\n```\n\nNous avons créé une abstraction pour manipuler un système de fichiers puis nous avons adapté les interfaces de chacune des librairies que l'on souhaitait utiliser.\n\nMais bon, on doit encore maintenir du code. Heureusement pour nous, il existe déjà une librairie qui s'en charge.\n\nJe vous présente la librairie [Flysystem](https://flysystem.thephpleague.com/docs/), développée par [thephpleague](https://thephpleague.com/fr/), un groupe de développeurs de bibliothèques PHP. *Flysystem* est une bibliothèque d'abstraction du système de fichiers.\nCela permet donc de changer de solution de système de fichiers rapidement et facilement grâce au patron de conception `Adaptateur`.\nVous pouvez l’utiliser dans une application PHP avec ou sans framework.\n\nFlysystem fournit une API permettant de gérer vos ressources sur un grand nombre de systèmes de fichiers. D’office, la librairie fournit trois adaptateurs de système de fichiers : FTP, Local, et NullAdapter. Mais rien ne vous empêche d’ajouter d’autres adaptateurs de système de fichiers, d'ailleurs, il en existe un grand nombre.\n\nVous pouvez retrouver la liste complète sur [le README du dépôt officiel](https://github.com/thephpleague/flysystem). Si par malheur vous ne trouvez pas votre bonheur parmi la liste proposée vous pouvez développer le vôtre. Voici le lien pour [créer un adaptateur](https://flysystem.thephpleague.com/docs/advanced/creating-an-adapter/) car je n’en parlerai pas ici.\n\n## Permuter de système de fichiers avec Flysystem\n\nJe vais vous montrer un exemple de permutation de système de fichiers avec Flysystem dans une application Symfony 4.\n\nDans un premier temps, il faut configurer un système de fichiers avec Flysystem. Pour ce faire, nous allons installer le bundle avec composer comme ceci : `composer require league/flysystem-bundle`, puis on édite la configuration de Flysystem dans le fichier `config/packages/flysystem.yaml` avec ces quelques lignes :\n\n```yaml\nflysystem:\n  storages:\n    default.storage:\n      adapter: 'local'\n      options:\n        directory: '%kernel.project_dir%/var/storage'\n```\n\nIci on peut voir que l’on configure un système de fichiers qui se nomme `default.storage`, utilisant l’adaptateur `local`, et qu’il y a une option qui cible le répertoire où seront stockés les ressources : `directory: '%kernel.project_dir%/var/storage'`.\n\nJusqu'ici rien de bien compliqué. Mais maintenant, on change de système de fichiers pour passer sur une solution de stockage sur AWS S3. Pour ce faire, nous allons dans un premier temps [créer un Bucket avec la console AWS](https://docs.aws.amazon.com/fr_fr/AmazonS3/latest/user-guide/create-bucket.html). Puis, nous installons l'adaptateur Flysystem AWS S3 via composer comme ceci `composer require league/flysystem-aws-s3-v3`.\nEnsuite nous configurons notre client AWS :\n\n```yaml\nservices:\n# ...\n  Aws\\S3\\S3Client:\n    arguments:\n        - version: 'latest'\n          region: '%env(string:AWS_REGION)%'\n          credentials:\n            key: '%env(string:AWS_CREDENTIALS_KEY)%'\n            secret: '%env(string:AWS_CREDENTIALS_SECRET)%'\n          S3:\n            version: \"2006-03-01\"\n```\n\nIl faudra récupérer des `credentials` sur la console AWS, pour ce faire, je vous laisse consulter la [documentation officielle sur AWS](https://docs.aws.amazon.com/fr_fr/cli/latest/userguide/cli-chap-configure.html).\n\nUne fois le client configuré, il nous reste à permuter de système de fichiers. On retourne dans `config/packages/flysystem.yaml` et on modifie quelques lignes comme ceci :\n\n```yaml\nflysystem:\n  storages:\n    default.storage:\n      adapter: 'aws'\n      options:\n        client: Aws\\S3\\S3Client\n        bucket: '%env(string:AWS_BUCKET)%'\n```\n\nEt voilà, on vient de changer de système de fichiers juste en changeant la valeur de l’adaptateur de `local` à `aws` et en modifiant les options pour spécifier le client et le bucket à utiliser.\n\n\n##  Utiliser plusieurs systèmes de fichiers avec Flysystem\n\nOn a vu comment permuter facilement de système de fichiers, maintenant nous allons voir comment configurer plusieurs systèmes de fichiers. Je vais vous faire un exemple de configuration avec trois solutions de stockage. Un système de fichiers local et deux solutions cloud (AWS et GCP).\n\nLa première étape va consister à installer le bundle et l'adaptateur pour AWS S3, ainsi que l'adaptateur pour Google Storage. `composer require league/flysystem-bundle league/flysystem-aws-s3-v3 superbalist/flysystem-google-storage`.\n\nMaintenant, nous allons configurer les clients AWS et GCP. Pour AWS pas de changement.\nPour GCP, il faut [créer un storage](https://cloud.google.com/storage/docs/creating-buckets?hl=fr) et récupérer un [fichier json d’authentification](https://cloud.google.com/video-intelligence/docs/common/auth?hl=fr#set_up_a_service_account).\n\nUne fois que l’on a configuré le Bucket AWS S3 ainsi que le Storage Google et que l’on a récupéré les informations de connexion, il ne nous reste plus qu'à configurer les clients comme ceci :\n\n```yaml\n# config/services.yaml\nservices :\n# …\n\n  Google\\Cloud\\Storage\\StorageClient:\n    arguments:\n      - keyFilePath: '%env(string:GCP_AUTH_FILE)%' #fichier json contenant les information de connection\n\n  Aws\\S3\\S3Client:\n    arguments:\n        - version: 'latest'\n          region: '%env(string:AWS_REGION)%'\n          credentials:\n            key: '%env(string:AWS_CREDENTIALS_KEY)%'\n            secret: '%env(AWS_CREDENTIALS_SECRET)%'\n          S3:\n            version: \"2006-03-01\"\n```\n\nMaintenant on va configurer nos systèmes de fichiers :\n\n```yaml\nflysystem:\n    local.storage:\n      adapter: 'local'\n      options:\n        directory: '%kernel.project_dir%/var/storage'\n\n    gcp.storage:\n      adapter: 'gcloud'\n      options:\n        client: Google\\Cloud\\Storage\\StorageClient\n        bucket: '%env(string:GCP_BUCKET)%'\n        api_url: 'https://storage.googleapis.com'\n\n    aws.storage:\n      adapter: 'aws'\n      options:\n        client: Aws\\S3\\S3Client\n        bucket: '%env(string:AWS_BUCKET)%'\n```\n\nAlors, dans ces exemples, je nomme mes systèmes de fichiers en fonction du nom de l'adaptateur, mais vous pouvez les nommer en fonction de leur utilité, exemple :\n\n```yaml\nflysystem:\n    assets.storage:\n      adapter: 'local'\n      # ...\n\n    invoice.storage:\n      adapter: 'gcloud'\n      # ...\n\n    media.storage:\n      adapter: 'aws'\n      # ...\n```\n\nEt voilà pour la configuration de plusieurs systèmes de fichiers.\n\n## La configuration ça va deux minutes\n\nNous avons vu comment permuter de système de fichiers juste avec quelque lignes de configuration, mais aussi comment configurer plusieurs systèmes de fichiers.\nMaintenant nous allons voir comment utiliser nos système de fichier. [l’API Flysystem](https://flysystem.thephpleague.com/docs/usage/filesystem-api/) nous offre plusieurs méthodes pour manipuler des ressources. Voici la liste des méthodes :\n\n- write\n- writeStream\n- update\n- updateStream\n- put\n- putStream\n- read\n- readStream\n- has\n- delete\n- readAndDelete\n- rename\n- copy\n- getMimetype\n- getTimestamp\n- getSize\n- createDir\n- deleteDir\n- listContents\n- setVisibility\n- addPlugin\n\nVous pouvez remarquer que certaine méthodes sont suffixées par `Stream`. Cela signifie manipuler un fichier en tant que [ressource](https://www.php.net/manual/en/language.types.resource.php). Dans le cas contraire vous manipulez un fichier sous forme de chaîne de caractères.\n\nFlysystem met un peu de magie dans l’utilisation des systèmes de fichiers. Quand vous déclarez un système de fichiers vous créez une clé comme ceci `local.storage`. Cette clé va nous permettre d’injecter le système de fichiers dans nos services, controllers ou autres, comme ceci `FilesystemInterface $localStorage`.\n\nVoici un petit exemple dans un controller qui utilise le système de fichiers ayant pour clé `local.storage`  :\n\n```php\n<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\Controller;\n\nuse League\\Flysystem\\FilesystemInterface;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\Response;\n\nclass DefaultController extends AbstractController\n{\n    public function index(FilesystemInterface $localStorage): Response\n    {\n        return $this->render('Default/index.html.twig', ['files' => $localStorage->listContents()]);\n    }\n}\n```\n\nDans cet exemple on liste les fichiers du système de fichiers local.\n\nUn autre exemple d’utilisation, l’écriture d’une ressource dans un système de fichiers.\n\n```php\n// Écriture sur le système de fichiers local avec un fichier sous forme de chaîne de caractères\n$localStorage->wirte($path, $content);\n\n// Écriture sur le Storage Google avec un fichier sous forme de ressource. En plus on gère la visibilité du fichier.\n$gcpStorage->wirteStream($path, $resource, ['visibility' => AdapterInterface::VISIBILITY_PRIVATE]);\n```\n\nUn autre exemple d’utilisation. Le déplacement d’un fichier d’un système de fichiers à un autre système de fichiers. Pour ce faire nous aurons besoin d’utiliser le `MountManager` de Flysystem.\n\nLe `MountManager` permet de faire des manipulations dans plusieurs systèmes de fichiers préalablement renseignés. Il suffira uniquement de préfixer le paramètre `path` avec le nom du système de fichiers à utiliser.\n\nVoici l’exemple pour déplacer un fichier d’un système de fichiers local vers un Storage Google :\n\n```php\n// …\npublic function copToGcp(FilesystemInterface $localStorage, FilesystemInterface $gcpStorage)\n    {\n         $mountManager = new MountManager();\n         $mountManager->mountFilesystems([\n             'local' => $localStorage,\n             'gcp' => $gcpStorage,\n         ]);\n\n         $mountManager->move('local://my_file.txt', 'gcp://mysdirectory/my_file_to_gcp.txt');\n    }\n\n// ...\n```\n\nVous pouvez voir que l’on assigne une clé au système de fichiers renseigné au `MountManager` comme ceci `'local' => $localStorage`. Ensuite, pour spécifier le système de fichiers on préfixe le `path` par la clé précédemment définie `local://my_file.txt`.\n\n## Un plugin pour personnaliser vos actions\n\nDernier exemple d’utilisation pour cet article. Dans la liste des méthodes vous avez peut être vu cette méthode `addPlugin`. Flysystem nous permet de créer nos plugins pour avoir nos propres méthodes.\n\nNous allons prendre la problématique suivante :\n> Dans un système de gestion de factures nous voulons que lors de la sauvegarde d'une facture, cette dernière soit placée dans un répertoire à la date du jour dans ce format `Y-m-d`.\n> Et que la facture soit renommée avec son `id` et l’heure de l’enregistrement dans ce format `H-m-s`.\n\nVoilà comment procéder :\n\n1/ Configuration du système de fichiers\n\n```yaml\n# config/packages/flysystem.yaml\nflysystem:\n  storages:\n    invoice.storage:\n      adapter: 'local'\n      options:\n        directory: '%kernel.project_dir%/var/storage/invoice'\n```\n\n2/ Création du plugin\n\n```php\n<?php\n\ndeclare(strict_types=1);\n\nnamespace App\\FlysystemPlugins;\n\nuse League\\Flysystem\\FilesystemInterface;\nuse League\\Flysystem\\PluginInterface;\n\nclass invoicePlugin implements PluginInterface\n{\n    /** @var FilesystemInterface */\n    protected $filesystem;\n\n    public function setFilesystem(FilesystemInterface $filesystem): void\n    {\n        $this->filesystem = $filesystem;\n    }\n\n    public function getMethod(): string\n    {\n        return 'saveInvoice';\n    }\n\n    public function handle(int $id, string $content)\n    {\n        $now = new \\DateTimeImmutable();\n        $this->filesystem->write(\n            sprintf('%s/%d-%s', $now->format('Y-m-d'), $id, $now->format('H-i-s')),\n            $content\n        );\n    }\n}\n```\n\n3/ Exemple d'utilisation (Attention ici il y a du fake il faut réadapter pour une vraie utilisation)\n\n```php\n    public function saveInvoice(FilesystemInterface $defaultStorage, FilesystemInterface $invoiceStorage)\n    {\n        $invoice = $defaultStorage->read('invoice.txt');\n\n        $invoiceStorage->addPlugin(new invoicePlugin());\n        $invoiceStorage->saveInvoice($id, $invoice);\n    }\n```\n\n4/ Voir le résultat :\n\n\n![result plugin Flysystem](/imgs/posts/2019-11-20-reprenez-le-controle-de-vos-file-system-avec-flysystem/screenshot-result-plugin.png){: style=\"margin: 0 auto; display: block;\" }\n\nEt voilà pour ce dernier exemple.\n\n## Le mot de la fin\n\nFlysystem est une librairie complète qui va vous permettre de simplifier votre code et de diminuer le temps de développement.\nEn plus, vous n’aurez plus de problèmes en cas de changement de solution du système de fichiers, au cas où votre nouveau CTO n’aime pas AWS, ou dans l'éventualité d'une réduction budgétaire vous obligeant à repasser en local sur vos bon vieux serveurs.\n\nEt comme on l’a vu en fin d’article vous pouvez avoir des méthodes qui sont propres à votre métier sans avoir à surcharger des classes. Bon après si vous avez des modifications ou ajouts qui pourrait être utile n'hésitez pas à soumettre une PR sur le [dépôt du projet](https://github.com/thephpleague/flysystem).\n\nSi vous le souhaitez vous pouvez aller consulter [les autres projet de The PHP league](https://thephpleague.com/fr/#nos-biblioth%C3%A8ques).\n\nJ'espère que cet article vous a plu, à la prochaine !\n\n## Resources\n\n- [php.net - filesystem](https://www.php.net/manual/en/ref.filesystem.php)\n- [flysystem.thephpleague.com - docs](https://flysystem.thephpleague.com/docs/)\n- [github.com - thephpleafue/flysystem](https://github.com/thephpleague/flysystem)\n- [fr.wikipedia.org - patron de conception Adaptateur](https://fr.wikipedia.org/wiki/Adaptateur_(patron_de_conception))\n- [developpez - Florian Casabianca - Comprendre le design Pattern Adaptateur](https://badger.developpez.com/tutoriels/dotnet/patterns/adaptateur/)\n"}