{"date":"2018-10-23T00:00:00.000Z","title":"Cucumber for Angular","excerpt":"Comment intégrer Cucumber dans Angular","readingTime":"8mn","authors":["la3roug"],"categories":["javascript"],"content":"\n## Introduction\n\n__AngularCLI__ est une interface en ligne de commandes pour __Angular__ (trouvé sur https://cli.angular.io/).\n\nCet outil comporte plusieurs fonctionnalités utiles qui nous font gagner beaucoup de temps.\nIl nous permet, par exemple, de générer un nouveau projet (Angular bien sûr) en une seule ligne de commande.\n\nDans cet article, nous n'allons pas aborder toutes les fonctionalités de __AngularCLI__, nous allons plutôt nous concentrer sur la partie _test_, plus précisément les tests `e2e`.\n\nEn effet, __AngularCLI__ possède une commande `ng e2e`, qui nous permet de lancer les tests `e2e`. Cela est possible car au moment de la génération d'un nouveau projet __Angular__, __AngularCLI__ va installer des paquets tiers qui nous permettent d'implémenter et exécuter les tests `e2e`. Il va installer (et configurer) pour nous __Protractor__ (qui à son tour va installer _webdriver_ et _selenium_) et __Jasmine__ (utilisé aussi pour les tests unitaires). Ce n'est peut-être pas la bonne sélection d'outils si nous voulons faire du __BDD__ ou si nous avons juste besoin d'exécuter nos tests sur _Chrome Headless_ et que les autres navigateurs ne nous intéressent pas.\n\nÀ travers cet article, nous allons voir comment supprimer __Protractor__ et le remplacer par __Cucumber__ (pour le __BDD__) et __Puppeteer__ (pour communiquer avec _Chrome Headless_).\n\n## Supprimer Protractor\n\nAvant de mettre en place __Cucumber/Puppeteer__, nous allons d'abord supprimer __Protractor__ et les répertoires/fichiers associés qui ont été générés par AngularCLI.\n\n### Désinstaller Protractor\n\nLa désinstallation de __Protractor__ se fait comme suit :\n\n```bash\n$ npm uninstall protractor --save-dev\n```\n\n### Supprimer la partie e2e des fichiers de configuration\n\nAngularCLI nous permet de lancer les tests `e2e` via la commande `ng e2e`, nous allons donc retirer l'appel à cette commande des scripts `npm` qui se trouvent dans le fichier `package.json` :\n\n```json\n {\n   \"scripts\": {\n-    \"e2e\": \"ng e2e\",\n+    \"e2e\": \"echo \\\"no e2e test yet!\\\"\",\n     ...\n   }\n }\n```\n\nVu que nous ne passons plus par AngularCLI pour nos tests `e2e`, nous allons supprimer du fichier `angular.json` le projet `<project-name>-e2e` (où `<project-name>` est le nom de votre projet) qui se trouve dans la partie `projects` :\n\n```json\n {\n   \"projects\": {\n     \"my-project\": {...},\n-    \"my-project-e2e\": {...}\n   }\n }\n```\n\nLe dernier fichier de configuration à modifier est `src/tsconfig.e2e.json`. Nous allons retirer `jasmine` et `jasminewd2` de la propriété `types` des options du compilateur TypeScript (nous verrons un peu plus bas par quoi nous allons le remplacer) :\n\n```json\n {\n   \"extends\": \"../tsconfig.json\",\n   \"compilerOptions\": {\n     \"outDir\": \"../out-tsc/app\",\n     \"module\": \"\",\n     \"target\": \"es5\",\n     \"types\": [\n-      \"jasmine\",\n-      \"jasminewd2\",\n       \"node\"\n     ]\n   }\n }\n```\n\n### Supprimer les fichiers créés par AngularCLI\n\nEnsuite, nous allons supprimer le contenu du répertoire `e2e/src` et le fichier `e2e/protractor.conf.js` :\n\n```bash\n$ rm e2e/src/* e2e/protractor.conf.js\n```\n\n## Mettre en place Cucumber/Puppeteer\n\nMaintenant que nous avons désinstallé __Protractor__ et supprimé les fichiers de configuration correspondants, passons à l'étape suivante qui est la mise en place de __Cucumber/Puppeteer__ et __Chai__ pour pouvoir faire nos assertions.\n\n### Installation\n\nNous allons installer les paquets suivants :\n\n* __Cucumber__ : c'est l'outil qui va nous permettre d'exécuter nos tests.\n* __Puppeteer__ : pour communiquer avec l'API de Chrome/Chromium\n* __Chai__ : une librairie d'assertion.\n\n```bash\n$ npm install cucumber puppeteer chai --save-dev\n```\n\nAfin que __TypeScript__ puisse reconnaître les paquets que nous venons d'installer, nous allons aussi installer les __Type Definition__ de ces derniers :\n\n```bash\n$ npm install @types/{cucumber,puppeteer,chai}\n```\n\n### Structure des fichiers\n\nLa structure par défaut proposée par __Cucumber__ est la suivante :\n\n```\nfeatures/\n  step_definitions/\n    feautre1.steps.ts\n    feautre2.steps.ts\n    ...\n  feature1.feature\n  feature2.feature\n  ...\n```\n\nPersonnellement je préfère séparer les _steps_ des _features_, nous allons donc les mettre au même niveau (si vous voulez opter pour la structure proposée par __Cucumber__, il faudra dans ce cas adapter les chemins dans les étapes qui viennent). Nous allons aussi utiliser le modèle __Page Object Pattern__ afin de séparer l'appel à l'API de _Chrome/Chromium_ de nos tests :\n\n```\ne2e/\n  src/\n    features/\n      feature1.feature\n      feature2.feature\n      ...\n    steps/\n      feature1.steps.ts\n      feature2.steps.ts\n      ...\n    po/\n      app.po.ts\n      ...\n  tsconfig.e2e.json\n```\n\n* _features_ : contient nos _user stories_ rédigées en _Gherkin_.\n* _steps_ : contient l'implémentation des tests.\n* _po_ : contient nos _class_ __PageObject__\n\n### Configuration\n\nNous allons maintenant configurer notre application pour qu'elle puisse lancer les tests.\n\nCommençons par le fichier `src/tsconfig.e2e.json` en ajoutant `cucumber` au tableau `types` que nous avons édité un peu plus haut :\n\n```json\n {\n   \"extends\": \"../tsconfig.json\",\n   \"compilerOptions\": {\n     \"outDir\": \"../out-tsc/app\",\n     \"module\": \"commonjs\",\n     \"target\": \"es5\",\n     \"types\": [\n+      \"cucumber\",\n       \"node\"\n     ]\n   }\n }\n```\n\nLa dernière configuration à faire, est le _script npm_ `e2e`. C'est à cet endroit que nous ferons appel à __Cucumber__ pour exécuter nos tests.\n\nLa commande `cucumber-js` permet d'écrire les _steps_ en _TypeScript_ grâce à `ts-node` (d'autres transpilateurs sont supportés aussi, comme _CoffeeScript_), nous allons donc utiliser l'option `--require-module` afin d'utiliser `ts-node`.\n\nPar défaut `ts-node` va charger le fichier `tsconfig.json` qui se trouve à la racine du projet. Mais comme `cucumber-js` ne permet pas le passage de paramètres au module `ts-node`, nous allons utiliser la variable d'environnement `TS_NODE_PROJECT` et lui assigner le chemin `e2e/tsoncif.e2e.json` que nous avons vu un peu plus haut.\n\n```json\n {\n   \"scripts\": {\n-    \"e2e\": \"echo \\\"no e2e test yet\\\"\",\n+    \"e2e\": \"TS_NODE_PROJECT=e2e/tsconfig.e2e.json cucumber-js --require-module ts-node/register -r e2e/steps/**/*.steps.ts e2e/features/**/*.feature\",\n     ...\n   }\n }\n\n```\n\n## Exemple de scénario\n\nNous allons à présent rédiger notre première _feature_ que nous allons mettre dans le fichier `e2e/src/features/welcome.feature` :\n\n```gherkin\nFeature: Say hello to visitor\n  Scenario: Display a welcome message\n    Given a visitor visits our website\n    When the home page is loaded\n    Then he should see a message saying \"Welcome Visitor !\"\n```\n\nPassons maintenent au fichier `e2e/src/steps/welcome.steps.ts` :\n```typescript\nimport { AfterAll, BeforeAll, Given, Then, When }  from 'cucumber';\nimport { expect } from 'chai';\n\nimport { AppPage } from '../po/app.po';\n\nlet appPage: AppPage;\n\nBeforeAll(async () => {\n  appPage = new AppPage();\n  await appPage.init();\n});\n\nGiven('a visitor visits our website', async () => {\n  await appPage.gotoPage('/');\n});\n\nWhen('the home page is loaded', async () => {\n  await appPage.waitFor('h1');\n});\n\nThen('he should see a message saying {string}', async message => {\n  expect(await appPage.getContent('h1')).to.equal(message);\n});\n\nAfterAll(() => {\n  appPage.close();\n});\n\n```\n\nEt dans le fichier `e2e/src/po/app.po` :\n\n```typescript\nimport * as puppeteer from 'puppeteer';\n\nexport class AppPage {\n  browser: puppeteer.Browser;\n  page: puppeteer.Page;\n  baseUrl = 'http://localhost:4200';\n\n  async init() {\n    this.browser = await puppeteer.launch();\n    this.page = await this.browser.newPage();\n  }\n\n  async gotoPage(url) {\n    await this.page.goto(this.baseUrl + url);\n  }\n\n  async getContent(selector) {\n    return await this.page\n      .evaluate(select => document.querySelector(select).textContent, selector);\n  }\n\n  async waitFor(selector) {\n    return this.page.waitFor(selector);\n  }\n\n  close() {\n    this.browser.close();\n  }\n}\n```\n\n## Exécution des tests\n\nAvant de lancer __Cucumber__, nous devons exécuter `npm start` pour que __Puppeteer__ puisse naviguer vers `http://localhost:4200`.\n\nUne fois que notre serveur _http_ en local est en marche, nous pouvons exécuter nos tests via la commande :\n\n```bash\n$ npm run e2e\n```\n\n> Pour rappel, lors de la configuration de __Cucumber__ nous avons remplacé le script _npm_ `e2e` par la commande qui permet de lancer __Cucumber__.\n\n## Conclusion\n\n__AngularCLI__ nous fournit plein d'outils par défaut, afin d'accélerer et faciliter le développement de nos applications. Mais cela ne veut pas dire que nous ne pouvons pas remplacer ces outils par d'autres.\n\nDans notre cas, nous avons décidé de ne pas utiliser __Protractor__ et d'utiliser à la place __Cucumber/Puppeteer__.\n\nNous avons donc commencé par voir comment supprimer __Protractor__. Ensuite, nous avons vu comment mettre en place __Cucumber__. Une fois tout en place, nous avons rédigé un exemple de scénario et implémenté les _steps definitions_ de ce scénario. En dernier, nous avons vu comment exécuter nos tests.\n"}