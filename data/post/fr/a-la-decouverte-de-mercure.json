{"date":"2020-08-26T00:00:00.000Z","title":"À la découverte de Mercure","excerpt":"Exploration du protocole Mercure. Vous n'aurez plus peur des communications client-server en temps réel à la fin de ce voyage.","readingTime":"7mn","authors":["ajacquemin"],"categories":["architecture","php","javascript"],"content":"\nAujourd'hui, je vous fais découvrir ce qu'est [Mercure](https://mercure.rocks/), ses principes, puis on apprendra comment le mettre en place simplement avec Docker.\nMercure est un sérieux concurrent aux classiques WebSockets et autres solutions similaires, car il tire parti de nombreuses nouveautés du Web (HTTP/2, SSE, ...) et est supporté nativement par la plupart des navigateurs.\n\n![Logo de Mercure](/imgs/posts/2020-08-26-a-la-decouverte-de-mercure/mercure_logo.png)\n\nEn clair, c'est un **protocole** qui permet d'envoyer des push updates vers tout client HTTP.\n\nPar exemple, une ressource de votre API est mise à jour, et vous souhaitez que les navigateurs ou smartphones connectés à votre application reçoivent le changement sans avoir à requêter l'API. Le tout est possible en temps réel grâce à Mercure !\n\nCe protocole est publié en tant qu'[Internet Draft](https://datatracker.ietf.org/doc/draft-dunglas-mercure/) par Kévin Dunglas, il est donc encore jeune (le protocole, pas Kévin.. Enfin Kévin est encore jeune aussi mais... Hum, bref).\n\nCependant, j'ai décidé de vous le présenter car il est déjà stable et parfaitement utilisable pour vos applications (et déjà utilisé en production sur de nombreux projets).\n\nVous êtes des adeptes de la nouveauté ? Férus de conquête spatiale ? Fans de Freddy Mercury ? Alors entrez dans la fusée, attachez vos ceintures et gardez vos rations lyophilisées à portée de main, on part à la découverte de Mercure.\n\n## 1. A kind of magic\n> Waw c'est magique !\n\nC'est ce qui m'a traversé l'esprit la première fois que j'ai testé Mercure, tant c'est facile d'utilisation. Un magicien ne révèle habituellement pas ses secrets, mais vous m'avez l'air sympa, on va faire une exception.\n\nAlors pour débuter la visite de Mercure, commençons par apprendre ensemble son langage...\n\nJe vous présente tout d'abord le **Hub**, le serveur et le cœur de Mercure.\nC'est vers lui que sont publiés les **Updates**, et c'est lui qui s'occupe ensuite de les dispatcher à tous les clients abonnés aux ressources souhaitées.\n\nCes ressources sont définies par des **Topics**. Un topic représente une ressource, à laquelle on peut s'abonner, pour en recevoir les **Updates**.\nC'est une bonne pratique d'identifier un **topic** par une URI complète, par exemple : *http://example.com/product/1* qui représente le produit d'ID 1.\nUne **Update** est donc la version mise à jour d'un **topic**.\n\nEnfin, on a les **Subscribers** (clients HTTP) et les **Publishers** (par exemple votre API), dont les termes parlent d'eux mêmes : les premiers s'abonnent au **Hub** Mercure, afin de récupérer les **Updates** de certains **topics**, publiés par... Je vous le donne en mille... Les **Publishers**, exactement !\n\n<div class=\"admonition note\" markdown=\"1\"><p class=\"admonition-title\">Note</p>\n\nMercure utilise les SSE (Server Sent Events) pour pousser ses Updates\n\n</div>\n\n![Schéma du fonctionnement de Mercure](/imgs/posts/2020-08-26-a-la-decouverte-de-mercure/mercure.png)\n\n\nC'est bon, vous avez tout compris... Plus qu'à mettre en pratique !\n\n\n## 2. Mercure en pratique\nLa théorie ça va 5 minutes, mais je sens bien que vous trépignez d'impatience de tester par vous-même. Ça tombe bien, c'est maintenant !\n\nRien de tel qu'un petit exemple pour dompter la bête. Pour des besoins de reproductibilité et de facilité, nous allons utiliser [l'image Docker de Mercure](https://hub.docker.com/r/dunglas/mercure).\n\n```shell\ndocker run \\\n-e JWT_KEY='astronautsKey' -e ALLOW_ANONYMOUS=1 -e CORS_ALLOWED_ORIGINS='*' -e PUBLISH_ALLOWED_ORIGINS='http://localhost' \\\n-p 3000:80 -d \\\ndunglas/mercure\n```\n\nPlusieurs choses à décortiquer. Mercure peut prendre plusieurs variables d'environnement en entrée pour fonctionner, mais voici ici parmi les plus importantes :\n-   **JWT_KEY** : Ce paramètre est obligatoire. Les Publishers et Subscribers l'utilisent pour s'abonner et publier sur le Hub.\n-   **ALLOW_ANONYMOUS** : Définit si les clients non authentifiés (sans JWT) peuvent s'abonner au Hub. On l'autorise pour l'exemple.\n-   **CORS_ALLOWED_ORIGINS** : Définit les règles CORS du serveur Mercure. Pour l'exemple, nous autorisons les clients de tous domaines.\n-   **PUBLISH_ALLOWED_ORIGINS** : Les domaines autorisés à publier des updates sur le Hub.\n\nEt... C'est tout ! Vous avez un serveur Mercure qui tourne sur votre machine. Rendez-vous sur votre [http://localhost:3000](http://localhost:3000) pour vérifier.\n\n\nConnectez-vous sur [http://localhost:3000/.well-known/mercure](http://localhost:3000/.well-known/mercure). Bienvenue sur votre Hub ! Normalement, ce dernier vous affiche un petit message...\n\n> Missing \"topic\" parameter\n\nEn effet, il s'attend à ce que vous lui précisiez sur quel topic vous souhaitez écouter les updates. Il suffit de rajouter ce paramètre dans l'URL du hub : [http://localhost:3000/.well-known/mercure?topic=http://example.com/message/1](http://localhost:3000/.well-known/mercure?topic=http://example.com/message/1).\n\nParfait, vous écoutez donc le topic *http://example.com/message/1*.\n\n<div class=\"admonition important\" markdown=\"1\"><p class=\"admonition-title\">Important</p>\n\nAttention à ne pas confondre. Il ne s'agit pas à proprement parler d'une **URL** mais plutôt d'une **URI** (*Uniform Resource Identifier*), qui identifie une ressource. En soi vous pourriez mettre n'importe quel identifiant ici (e.g. juste `messages`, ou `message/1`, mais il est fortement conseillé de préférer indiquer une **URI** complète.)\n\n</div>\n\nIl est temps de publier une Update sur votre Hub Mercure pour voir ce qu'il se passe. Pour cela, nous simulerons notre Publisher avec [Postman](https://www.postman.com/downloads/).\n\nPour autoriser notre Publisher à pousser des Updates sur le Hub, nous devons générer un **JWT** (*Json Web Token*) .\nRendez-vous sur [jwt.io](https://jwt.io/).\nDans la partie Payload, insérez ce tableau :\n```json\n{\n    \"mercure\": {\n        \"publish\": [\"*\"]\n    }\n}\n```\nCette configuration autorise à publier des updates **publiques**.\nEnfin, dans la signature, remplacez le secret par la **JWT_KEY** que vous avez renseignée plus tôt dans la commande Docker (e.g. `astronautsKey`). Collez le JWT généré dans la partie autorisation de Postman.\n\nLa requête que nous allons faire est de type **POST**, sur l'adresse du hub : *http://localhost:3000/.well-known/mercure*.\n\nUtilisez un body de type *x-www-form-urlencoded* pour les paramètres, qui sont les suivants :\n-   `topic` : Ce paramètre est obligatoire, il identifie la ressource à publier. Indiquez le même que celui sur lequel vous écoutez (e.g. *http://example.com/message/1*)\n-   `data` : Le but, c'est d'envoyer une update. C'est dans le paramètre `data` que vous allez populer votre update avec les données souhaitées. Vous pouvez y mettre ce que vous voulez.\n\n<div class=\"admonition note\" markdown=\"1\"><p class=\"admonition-title\">Note</p>\n\nIl existe d'autres paramètres optionnels possibles, que vous pourrez retrouver sur la [documentation officielle de Mercure](https://mercure.rocks/docs).\n\n</div>\n\nGardez un oeil sur l'onglet de votre navigateur connecté au Hub, et lancez la requête.\n\nTadam ! Vous devriez voir un message apparaître. Bravo, vous avez envoyé votre premier update avec Mercure.\n\n<div class=\"admonition attention\" markdown=\"1\"><p class=\"admonition-title\">Attention</p>\n\nSi rien ne s'affiche, rafraichissez la page, et relancez votre requête. Si toujours rien ne s'affiche et que Postman ne vous renvoie pas l'identifiant de l'Update, vérifiez votre JWT.\n\n</div>\n\n\nEt voilà ! Amusez-vous à changer les topics, et savourez l'envoi d'updates en temps réel.\n\n## 3. Abonnez-vous à vos évènements\nAvant de finir, je vais vous présenter comment on s'abonne très simplement au Hub de Mercure. Car nous venons de tricher en nous connectant directement au Hub, mais ce que nous souhaitons, c'est bel et bien s'y abonner depuis un vrai client HTTP !\n\nCréez-vous un simple fichier HTML, et insérez-y ce code dans une balise **script** :\n```javascript\nconst url = new URL('http://localhost:3000/.well-known/mercure'); // URL de notre Hub Mercure\nurl.searchParams.append('topic', 'http://example.com/message/1'); // On ajoute les topics auxquels on souhaite s'abonner\nurl.searchParams.append('topic', 'http://example.com/message/{id}'); // Il est possible d'utiliser un topicSelector afin de sélectionner plusieurs topics en même temps\nconst eventSource = new EventSource(url);\n\neventSource.onmessage = ({data}) => {\n    console.log(data);\n}\n```\n\nComme vous pouvez le voir, on peut s'abonner à plusieurs topics, ce qui facilite bien des choses.\n\nMercure repose sur les SSE, on utilise donc l'API JavaScript **EventSource** pour écouter les updates qui nous sont envoyés. Ainsi, si vous postez encore un Update avec Postman, vous verrez dans votre console les `data` de cette Update qui s'affichent. À vous à présent d'imaginer une multitude de use cases !\n\n## Conclusion\n\nVoilà qui conclut un très rapide tour d'horizon de Mercure.\nVous savez à présent comment il fonctionne, et vous êtes capables de le configurer et l'utiliser simplement dans n'importe laquelle de vos applications.\nBien évidemment, ce protocole est beaucoup plus complet qu'il n'y parait, et il y aurait beaucoup d'autres choses à dire, mais je n'en dévoilerai pas plus dans cet article d'introduction.\n\n![GIF Keep your secrets](/imgs/posts/2020-08-26-a-la-decouverte-de-mercure/keep_your_secrets.gif)\n\nCependant, un codelabs est prévu très bientôt pour approfondir tout cela, et découvrir plein d'autres choses, notamment comment sécuriser les connexions, utiliser Mercure dans une application Symfony... Le tout sur la plateforme [Eleven's Codelabs](https://codelabs.eleven-labs.com/).\n\nJe vous invite bien entendu à consulter la [documentation officielle de Mercure](https://mercure.rocks/docs) qui est extrêmement bien faite, afin de pousser votre exploration encore un peu plus loin.\n\nJe vous souhaite de nombreuses et très belles aventures avec Mercure.\n"}