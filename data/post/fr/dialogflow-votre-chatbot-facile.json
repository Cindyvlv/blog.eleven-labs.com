{"date":"2021-10-20T00:00:00.000Z","title":"DialogFlow, votre chatbot facile","excerpt":"Il existe aujourd'hui de nombreuses aides à la mise en place des ChatBots conversationnels dits intelligents. On parlera aujourd'hui spécifiquement de DialogFlow, anciennement Api.ai de Google.","readingTime":"8mn","authors":["captainjojo"],"categories":[],"content":"\nLa communication avec l'utilisateur est cruciale pour le fidéliser. Il est alors naturel que les ChatBots conversationnels fassent leur apparition et deviennent un point important dans nos applications.\n\nIl existe aujourd'hui de nombreuses aides à la mise en place des ChatBots conversationnels dits intelligents. On parlera aujourd'hui spécifiquement de DialogFlow, anciennement Api.ai de Google.\n\n## J'écris un chatbot sans code\n\nDialogFlow c'est avant tout une interface qui va vous permettre d'utiliser l'intelligence de Google. Ce que DialogFlow contient est assez simple, il s'agit de [l'API Cloud Natural Language](https://cloud.google.com/natural-language/?hl=fr){:rel=\"nofollow noreferrer\"} qui permet de reconnaître des phrases envoyées par l'utilisateur. Avec les phrases récupérées et un peu de machine learning, Google reconnaît la phrase, et lance en adéquation une action proposée par votre configuration.\n\nEn bref, l'utilisateur propose une phrase, Google cherche parmi les \"intents\" que vous avez configurés et effectue l'action que vous avez proposée.\n\nMaintenant que l'on connaît le fonctionnement basique, nous allons créer notre premier chatbot.\n\nJe vous invite à aller sur la console de DialogFlow disponible [ici](https://console.dialogflow.com). Nous allons créer notre premier \"Agent\" [ici](https://console.dialogflow.com/api-client/#/newAgent){:rel=\"nofollow noreferrer\"}.\n\n![dialogflow-agent](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-agent.png)\n\nIl faut remplir le formulaire de création de votre agent. Je vous invite à mettre le *DEFAULT LANGUAGE* en Français.\n\nVoilà, vous avez votre premier chatbot ! Par défaut vous avez 2 \"intents\" que Google vous propose.\n\n![dialogflow-intent](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-intent.png)\n\nAllons voir ce que contient l'intent *Default Welcome Intent*, un intent est toujours séparé de la même façon.\n\n **- Contexts**\n\nVous pouvez y mettre un \"context\" d'entrée et de sortie. Cela permet de garder -comme son nom l'indique- le contexte de la conversation.\n\nExemple : Votre utilisateur demande une recette de cuisine, vous répondez avec un context *recette*, vous mettez alors *recette* dans l'output context. Puis dans un autre intent vous prenez le context *recette* dans input context. L'ensemble des paramètres contenus dans l'intent précédent seront en entrée de l'intent. Votre utilisateur pourra alors demander le temps de cuisson et vous saurez à quelle recette il fait référence.\n\nPour plus d'explications vous pouvez allez sur la documentation [ici](https://dialogflow.com/docs/contexts){:rel=\"nofollow noreferrer\"}.\n\n**- User says**\n\nVous y renseignez les phrases possibles en entrée de votre intent. C'est aussi ici que Google va vous aider, si vous mettez par exemple \"salut\", il prendra tout seul en compte les synonymes de \"salut\" comme le \"hello\", 'hey\" etc...\n\nC'est aussi dans user says que Google vous propose des *entities* que nous verrons plus tard.\n\nLa documentation est [ici](https://dialogflow.com/docs/intents){:rel=\"nofollow noreferrer\"}.\n\n**- Events**\n\nPermet d'invoquer l'intent via un trigger, nous ne l'utiliserons pas dans ce tutoriel mais pour plus d'informations vous pouvez lire la documentation [ici](https://dialogflow.com/docs/events){:rel=\"nofollow noreferrer\"}.\n\n**- Actions**\n\nC'est le point central d'un intent, une action permet de prendre en paramètre les données de l'utilisateur, les fameuses *entities*. Par défaut, DiaologFlow reconnaît des *entities* du type data, url, géolocalisation etc... On pourra aussi ajouter nos propres *entities* dans un second temps.\n\nQuand vous sélectionnez des *entities* dans les phrases utilisateurs, elles sont transformées en paramètres de l'action que vous pourrez utiliser ensuite dans vos scripts et dans vos réponses.\n\nLorsqu'un paramètre est obligatoire, DialogFlow vous propose d'ajouter une réponse si votre utilisateur est entré dans l'intent sans avoir renseigné le paramètre.\n\nVous pouvez trouver d'autres précisions dans la documentation [ici](https://dialogflow.com/docs/actions-and-parameters){:rel=\"nofollow noreferrer\"}.\n\n**- Responses**\n\nC'est ici que vous mettez les réponses que vous voulez envoyer à l'utilisateur s'il est rentré dans cette intent.\n\nVous pouvez mettre plusieurs réponses, DialogFlow choisira aléatoirement une des réponses, ce qui donne un meilleur effet auprès de vos utilisateurs.\n\nAllons voir ce que contient l'intent *Default Fallback Intent*, qui permet de récupérer tout les messages non reconnus par d'autres intents.\n\nIl ne contient pas une section *User says*, il vous permet seulement de répondre à votre utilisateur si aucun intent n'est trouvé. Cela vous permet d'expliquer le fonctionnement de votre application à vos utilisateurs, c'est un peu votre **help**.\n\nNous allons maintenant tester notre chatbot. Vous avez dû voir sur la droite de la console que DialogFlow vous permet d'utiliser en live votre chatbot.  Si vous rentrez n'importe quel phrase vous devez arriver dans le *Default Fallback Intent* puisque pour l'instant nous n'avons aucun *user says* dans votre autre intent.\n\n![dialogflow-fallback](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-fallback.png)\n\nVous pouvez aussi voir le json que cela génère. Il vous servira lors de la phase *Mettons une petite intelligence*.\n\n![dialogflow-json](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-json.png)\n\nSi dans le *User says* de votre *Default Welcome Intent* vous ajoutez un \"salut\" et que vous sauvegardez, vous pouvez re-tester et voir que le bot vous répond une des phrases présentes dans l'intent *Default Welcome Intent*\n\n![dialogflow-test2](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-test2.png)\n\nMaintenant créons une vraie conversation.\n\nDans l'intent *Default Welcome Intent* que vous pouvez renommer *Salut* je vous invite à changer les réponses en ajoutant la question *tu vis où ?*\n\nPuis créer l'intent *tu habites ?*,  qui aura un context de sortie *city*. Puis vous pouvez ajouter  comme *User says*  les phrases suivantes\n\n![dialogflow-response](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-response.png)\n\nSi tout se passe bien, DialogFlow va directement reconnaître les *entities* de géolocalisation. Si ce n'est pas le cas, en sélectionnant le mot vous pouvez choisir l'entity *@sys.geo-city*.\n\n![dialogflow-entity](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-entity.png)\n\nIl ne vous reste plus qu'a répondre à votre utilisateur avec les phrases suivantes.\n\n![dialogflow-response2](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-response2.png)\n\nVous pouvez utiliser *$geo-city* pour récupérer la ville de l'utilisateur.\n\nVous pouvez sauvegarder l'intent. Maintenant ajoutez l'intent *Tu as quel âge ?*. Comme pour l'intent précédent vous mettez en input le context *city*, permettant de récupérer la ville précédemment envoyée par l'utilisateur.\n\nComme pour l'autre intent vous pouvez prendre le chiffre des *user says* et le mettre en tant que paramètre. Il ne vous reste plus qu'à répondre à l'utilisateur par :\n\n    Cool $number et tu vis à #city.geo-city\n\n $number c'est le paramètre que l'utilisateur viens de fournir et #city.geo-city c'est la ville contenue dans le context.\n\n![dialogflow-entity2](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-entity2.png)\n\nVous pouvez sauvegarder et tester. Si tout est ok vous devez avoir ce genre de conversation :\n\n![dialogflow-test4](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-test4.png)\n\nVous pouvez le tester ici :\n\n<iframe width=\"350\" height=\"430\" src=\"https://console.dialogflow.com/api-client/demo/embedded/6025f565-6593-4d27-9fe1-45e65c7b571b\"></iframe>\n\nIl ne vous reste plus qu'à trouver une conversation.\n\n## Mettons une petite intelligence\n\nC'est bien, nous avons un chatBot qui permet de faire une conversation avec vos utilisateurs, mais il ne contient aucune intelligence métier.\n\n> Alors comment faire ?\n\nC'est simple, il faut fournir à Dialog un *Fulfillment* qui est en fait un webhook vers un webservice.\n\n![dialogflow-webhook](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-webhook.png)\n\nIl existe deux formats *Fulfillment*:\n\n**- Webhook**\n\n![dialogflow-webhook2](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-webhook2.png)\n\nIl s'agit d'une simple url que DialogFlow appellera lors d'un intent. Vous pouvez y mettre des options comme l'authentification, des headers spécifiques ou encore autoriser le webhook seulement sur vos domains web.\n\n**- Inline Editor**\n\n![dialogflow-inlineeditor](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-inlineeditor.png)\n\nIl s'agit d'un éditeur de code qui met cela directement dans une *function* Firebase.  Ce qui est pratique, c'est que vous n'avez pas à réfléchir sur le déploiement de votre code ! Google le fait pour vous, et vous n'avez pas non plus à faire la structure de base du code, elle est déjà prête.\n\nVous trouverez toutes les informations sur les *Fulfillment* sur la documentation [ici](https://dialogflow.com/docs/fulfillment){:rel=\"nofollow noreferrer\"}.\n\nIl ne vous reste plus qu'à activer le *Fulfillment* sur votre intent.\nCommençons par activer le *Fulfillment* Inline Editor.\n\n![dialogflow-inlineeditor2](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-inlineeditor2.png)\n\nPuis dans l'intent *Salut* en bas de la configuration vous avez la partie *Fulfillment* qui apparaît. Vous pouvez donc activer l'utilisation du webhook pour cet intent.\n\n![dialogflow-webhook3](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-webhook3.png)\n\nSi vous avez fait attention au code par défaut vous verrez cela :\n\n```javascript\nconst actionHandlers = {\n\t// The default welcome intent has been matched, welcome the user (https://dialogflow.com/docs/events#default_welcome_intent)\n\t'input.welcome': () => {\n\t\t  // Use the Actions on Google lib to respond to Google requests; for other requests use JSON\n\t  if (requestSource === googleAssistantRequest) {\n\t    sendGoogleResponse('Hello, Welcome to my Dialogflow agent!'); // Send simple response to user\n\t  } else {\n\t    sendResponse('Hello, Welcome to my Dialogflow agent!'); // Send simple response to user\n  }\n},\n```\n\nC'est simple, si l'intent est l'action *input.welcome* alors on répond *Hello, Welcome to my Dialogflow agent!*\n\nVous pouvez donc essayer.\n\n![dialogflow-test5](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-test5.png)\n\nVous pouvez faire beaucoup de choses avec vos webhooks, l'entrée du webhook c'est le json que vous trouvez dans les tests.\n\n![dialogflow-json2](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-json2.png)\n\nLa sortie c'est un objet json que vous pouvez retrouver [ici](https://dialogflow.com/docs/fulfillment#response){:rel=\"nofollow noreferrer\"}.\n\n## Déployons sur un outil de chat\n\nMaintenant que nous avons terminé notre chatbot, nous allons le déployer et c'est aussi là que DialogFlow est bien utile car il contient déjà pas mal d'intégrations avec des systèmes de Chat existants.\n\nSur le côté, cliquez sur *intégration*. Vous y trouverez les différentes intégrations possibles.\n\n![dialogflow-integration](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-integration.png)\n\nJ'ai d'ailleurs utilisé l'intégration *Web Demo* pour cet article.\n\nSi vous n'avez pas l'intégration que vous souhaitez, vous pouvez aussi utiliser les SQK disponibles par DialogFlow.\n\n![dialogflow-sdk](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-sdk.png)\n\n> Bravo vous avez déployé\n\nMaintenant il nous reste deux dernières choses que DialogFlow nous propose.\nLa première, c'est de l'*Analytics* que vous trouverez dans le menu à gauche.\n\nIl vous permet de voir combien vous avez eu d'appels en général et sur chaque *intents*.\n\n![dialogflow-analytics](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-analytics.png)\n\nLa documentation est assez riche [ici](https://dialogflow.com/docs/analytics){:rel=\"nofollow noreferrer\"}.\n\nEt pour terminer, comme DialogFlow c'est aussi du machine learning, vous pouvez suivre ce dernier dans la section *Training* dans votre menu de gauche.\n\nVous y trouverez l'ensemble des conversations qu'il y a eu avec votre chatbot, et donc pouvoir comprendre l'utilisation qu'en ont vos utilisateurs.\n\n![dialogflow-learning](/imgs/posts/2017-11-06-chatbot-dialogflow/dialogflow-learning.png)\n\nCe qui est pratique c'est de voir les phrases qu'y n'ont matché aucun intent et donc pouvoir ensuite les ajouter dans un intent ou faire des réponses différentes à vos utilisateurs.\n\nDans l'interface vous pouvez même directement ajouter une phrase dans un intent.\n\nVoilà, vous avez un chatbot performant, gratuit de surcroit... Alors n'hésitez plus !\n"}