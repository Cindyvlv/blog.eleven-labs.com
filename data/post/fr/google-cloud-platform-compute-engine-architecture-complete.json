{"date":"2016-12-12T00:00:00.000Z","title":"Google Cloud Platform (3/3) - Compute Engine, une architecture complete","excerpt":"Si vous avez suivi les deux premiers articles sur Google Cloud Platform, vous êtes capable de mettre en production un site rapidement et êtes capable de scaler automatiquement selon le trafic. Mais tout cela n'est possible qu'avec les éléments pré-installés de Google Cloud Platform. Comment créer sa propre configuration ? Réinstaller un serveur facilement ? Scaler automatiquement ?","readingTime":"5mn","authors":["captainjojo"],"categories":[],"content":"\nSi vous avez suivi les deux premiers articles sur Google Cloud Platform, vous êtes capable de mettre en production un site rapidement et êtes capable de scaler automatiquement selon le trafic. Mais tout cela n'est possible qu'avec les éléments pré-installés de Google Cloud Platform. Comment créer sa propre configuration ? Réinstaller un serveur facilement ? Scaler automatiquement ?\nDans ce tutoriel nous allons seulement installer un apache, mais vous pouvez appliquer tout ceci avec n'importe quelle installation.\n\n### Etape 1, créer votre configuration :\n\nAllez dans le menu \"Compute Engine\", disponible [ici](https://console.cloud.google.com/compute/instances){:rel=\"nofollow noreferrer\"}.\n\n![Compute Engine - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.09.20.png)\n\nPuis cliquez sur \"Créer une instance\", vous allez arriver sur un formulaire qu'il va falloir remplir.\n\n![Créer une instance - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.11.17.png)\n\n- Choisissez un nom\n- Puis la zone (il s'agit du lieu du serveur)\n- Choisissez le type de machine (c'est ceci qui fait varier le prix)\n- Laissez le disque de démarrage par défaut\n- Cochez la case \"Autoriser le trafic HTTP\"\n\nOuvrez le lien \"Gestion, disque, réseau et clés SSH\", et dans l'onglet Disque décochez la case \"Supprimer le disque de démarrage lorsque l'instance est supprimée\".\n\n![Suppression du disque - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.14.42.png)\n\nCliquez alors sur \"Créer\".\n\n### Etape 2, installer apache :\n\nAllez dans \"Instance de VM\" et attendre que la machine soit prête.\n\n![Instance de VM - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.18.22.png)\n\nCliquez sur SSH pour ouvrir la connexion à la machine.\n\n![Connexion SSH - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.20.12.png)\n\nUne fois connecté, nous allons installer apache. Pour cela il vous suffit de lancer les commandes suivantes :\n\n```sh\nsudo apt-get update;\nsudo apt-get install apache2;\nsudo /etc/init.d/apache2 restart;\n```\n\nUne fois terminé, si vous cliquez sur l'IP externe fournie dans l'interface \"Instance de VM\", vous devriez voir la page apache par défaut.\n\n![Apache - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.25.36.png)\n\nComme vous pouvez le voir l'installation prend un certain temps, et nous ne voulons pas le refaire pour chaque machine dont nous avons besoin. Nous allons donc nous servir de cette machine comme template pour d'autres machines.\n\n### Etape 3, création d'un template de machine :\n\nRetour dans l'interface \"Instance de VM\", vous allez supprimer la machine en sélectionnant la VM puis cliquer sur supprimer.\n\n![Supprimer une instance - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.29.17.png)\n\nAllez dans le menu \"Images\" et cliquez sur \"Créer une image\".\n\n![Créer une image - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.32.54.png)\n\nVous devez alors remplir le formulaire de création d'image.\n\n![Formulaire Image - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.33.58.png)\n\nLa seule chose qu'il faut surveiller, c'est le choix du disque source qui doit être celui de la machine que l'on vient de détruire.\nUne fois l'image créée, allez dans le menu \"Modèles d'instances\" et cliquez sur \"Créer un modèle d'instance\".\n\n![Modèle d'instance - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.37.04.png)\n\nVous arrivez dans un formulaire ressemblant à celui de la création d'instance.\n\n![Modèle d'instance - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.39.26.png)\n\nDans disque de démarrage, vous devez choisir l'image que vous venez de créer, elle est disponible dans l'onglet \"images personnalisées\" .\n\n![Image perso - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.41.14.png)\n\nEt n'oubliez pas de cocher la case \"Autoriser le trafic HTTP\". Puis cliquez sur \"Créer\".\nPour vérifier que tout est bon, nous allons créer de nouvelles instances via ce template.\n\n### Etape 4, création d'un groupe d'instance:\n\nAllez dans le menu \"Groupes d'instances\" puis cliquez sur \"Créer un groupe d'instances\".\n\n![Créer groupe d'instances - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.47.54.png)\n\nVous avez l'habitude, nous arrivons sur un formulaire assez long.\n\n![Formulaire 1 - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.49.30.png)\n\n![Formulaire 2 - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.49.43.png)\n\n- Choisissez un nom pour votre groupe\n- Puis l'emplacement (le mieux c'est multizone qui permet d'avoir des serveurs dans le monde entier)\n- Prenez ensuite le \"modèle d'instance\" que vous venez de créer\n- Activez l'évolution dynamique\n- Mettez le minimum d'instances à 3\n\nVous pouvez alors créer le groupe.\nSi vous retournez dans le menu \"Instances de VM\" vous pourrez voir les trois machines en cours de création. Une fois terminé, cliquez sur l\"IP externe\" de chaque machine. Normalement la page d'apache par défaut s'affiche.\n\n![groupe d'instance - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-18.56.59.png)\n\nÀ partir de maintenant, nous avons un groupe d'instances qui va scaler selon le trafic. Seulement, le trafic arrive sur les trois Ips, il nous faut donc un \"load balancer\" devant les machines pour envoyer le trafic sur le groupe d'instances.\n\n### Etape 5, le load balancer :\n\nChangez de menu et allez dans \"réseau\".\n\n![Réseau - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.02.40.png)\n\nPuis allez dans \"Équilibrage des charges\", et créez un équilibreur.\n\n![Load Balancer - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.05.27.png)\n\nChoisissez un équilibrage des charges HTTP(S).\nVous pouvez alors configurer l'équilibreur.\n\n![Configuration équilibreur - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.07.08.png)\n\nChoisissez un nom.\nPuis cliquez sur \"Configuration des backends\", et créez un service backend.\nVous arrivez sur le formulaire suivant :\n\n![Backend - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.10.37.png)\n\n![Formulaire - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.10.42.png)\n\n- Choisissez un nom\n- Puis l'instance backend (c'est le groupe créé juste avant)\n\nAjoutez un test périodique.\n\n![Test périodique - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.11.07.png)\n\n- Choisissez un nom\n- Puis le protocole http\n- Laissez le reste\n\nIl ne nous reste plus qu'a cliquer sur \"Règles d'hôte et de chemin d'accès\", qui passera directement en vert. La même chose pour \"Configuration du frontend\" qui passe en vert automatique.\nVous n'avez plus qu'à créer, cela va prendre pas mal de temps (environs 5 min).\nVous pourrez trouver l'IP d'entrée du load balancer dans le menu \"Équilibrage des charges\", puis sur le load balancer fraîchement configuré vous aurez l'ip disponible.\n\n![Load balancer - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.17.18.png)\n\nToujours dans cette interface, dans l'onglet surveillance vous pouvez suivre les backends qui reçoivent les requêtes.\n\n![Surveillance Backend - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.20.22.png)\n\nEt voila vous avez une architecture scalable automatiquement avec un load balancer comme un vrai architecte réseau.\n\n### Etape 6, on supprime les machines :\n\nAvant de vous quitter, nous allons supprimer les machines.  Vous devez le faire dans l'ordre suivant car sinon les machines se relanceront automatiquement.\n\n- Supprimez le load balancer\n- Puis dans le menu avancé de l'équilibrage des charges supprimez le service backend\n- Retourner dans le menu \"compute engine\", puis \"groupe d'instances\"\n- Supprimez votre groupe d'instance\n\nSi vous allez dans le dashboard vous devez ne plus voir de machine \"compute engine\"\n\n\n![Dashboard - Google Cloud Platform](/imgs/posts/2016-12-12-google-cloud-platform-compute-engine-architecture-complete/capture-decran-2016-11-30-a-19.28.32.png)\n"}