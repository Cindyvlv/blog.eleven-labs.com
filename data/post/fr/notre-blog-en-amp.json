{"date":"2017-09-27T00:00:00.000Z","title":"Notre blog en AMP","excerpt":"Notre blog est à l'image d'Eleven-labs, on aime partager et suivre les dernières tendances. À la fois pour notre blog et pour nos lecteurs nous voulons ce qu'il y a de meilleur et de plus confortable. C'est pour cela qu'aujourd'hui notre blog est AMP compliant.","readingTime":"6mn","authors":["captainjojo"],"categories":["javascript"],"content":"Notre blog est à l'image d'Eleven-labs, on aime partager et suivre les dernières tendances. À la fois pour notre blog et pour nos lecteurs nous voulons ce qu'il y a de meilleur et de plus confortable. C'est pour cela qu'aujourd'hui notre blog est **AMP compliant**.\n\n### Mais c'est quoi AMP ?\n\nPetit résumé pour ceux qui n'ont pas lu l'article [AMP le futur du web ?](https://blog.eleven-labs.com/fr/amp-le-futur-du-web/){:rel=\"nofollow noreferrer\"}.\n[AMP](https://www.ampproject.org/){:rel=\"nofollow noreferrer\"} est un projet open-source ayant pour volonté d'améliorer les performances de nos sites internet. À la base AMP est créé pour les pages mobiles, même si il est totalement possible de faire de l'AMP sur votre site desktop.\nAMP est surtout une technologie Google, en effet le principe est de limiter le nombre de requêtes et tout ce qui fait ralentir l'affichage de vos pages web. Le petit plus c'est que vos pages AMP sont alors cachées directement par les CDN de Google.\nComme Google donne une préférence aux pages AMP lors des recherches mobile, votre SEO n'en est que meilleur.\n\n### Notre blog est AMP !!\n\nEh oui, c'est fait ! Notre blog peut être servi en AMP, ce qui va permettre à nos utilisateurs mobile d'avoir une expérience améliorée.\n\n    Mais comment on a fait ca ?\n\nSi vous avez suivi l'activité de notre blog cette année, nous [venons de migrer ce dernier](https://blog.eleven-labs.com/fr/migration-du-blog/). En passant de Wordpress à Jekyll nous pouvons faire plus de développement (enfin plus facilement){:rel=\"nofollow noreferrer\"}, et c'est pour cela que nous avons passé nos pages articles en AMP.\n\nPour commencer nous avons installé le plugin [AMP-jekyll](https://github.com/juusaw/amp-jekyll){:rel=\"nofollow noreferrer\"} qui permet de générer le site avec deux layouts différents.\n\nIl nous a donc fallu créer le layout pour nos pages AMP. Le principe est simple : pas d'import de fichier js ou css, et l'utilisation de certaines balises interdite.\n\n\n```html\n---\nlayout: amp\n---\n<!doctype html>\n<html amp lang=\"fr\" class=\"no-js\">\n  <head>\n    <meta charset=\"utf-8\">\n    <title>{{ page.title }}</title>\n    <link rel=\"canonical\" href=\"{{ page.canonical_url | prepend: site.baseurl_root | prepend: site.url }}\" />\n    <meta name=\"viewport\" content=\"width=device-width,minimum-scale=1,initial-scale=1\">\n    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>\n    <script async src=\"https://cdn.ampproject.org/v0.js\"></script>\n  </head>\n  <body>\n<div class=\"content container\">\n    <article {% if page.cover %}class=\"feature-image\"{% endif %}>\n        <header class=\"page-heading\">\n            <div class=\"container\">\n                <h1 class=\"page-heading-title\">{{ page.title }}</h1>\n                <span class=\"meta\">\n                    <span class=\"meta-content\">\n                        {{ page.date | date: \"%B %-d, %Y\" }}\n                        {% include author_link.html authors=page.authors %}\n                    </span>\n                </span>\n                <div class=\"page-heading-reading-time\">{% include reading_time.html content=content %}</div>\n            </div>\n        </header>\n\n        <section class=\"slice\">\n            <div class=\"post-content container\">{{ content | markdownify | amp_images }}</div>\n        </section>\n\n    </article>\n    {% include links.html %}\n</div>\n    {% include newsletter_link.html %}\n{% include footer.html %}\n\n</body>\n</html>\n```\n\n\nMaintenant que la base est posée nous devons mettre notre CSS. Comme nous ne pouvons pas importer le fichier existant, nous devons inliner le css directement dans la balise `<style amp-custom>`\n\nNous avons choisi de continuer d'utiliser Saas, nous avons donc créé un fichier `amp.scss` dans le dossier `_includes` de Jekyll pour nous permettre de *l'inliner* facilement dans notre layout.\n\n```scss\n// Settings\n@import 'settings/fonts';\n@import 'settings/variables';\n\n// External\n@import 'external/reset';\n@import 'external/syntax';\n\n// Base\n@import 'base/global';\n@import 'base/utility';\n\n// objects\n@import 'objects/layout';\n@import 'objects/meta';\n@import 'objects/buttons';\n@import 'objects/page-heading';\n@import 'objects/read-also';\n@import 'objects/search-bar';\n@import 'objects/avatar';\n@import 'objects/newsletter';\n\n// Posts\n@import 'layouts/posts';\n@import 'layouts/index';\n\n// Partials\n@import 'includes/header';\n@import 'includes/footer';\n@import 'includes/md-content';\n@import 'includes/author';\n```\n\nUne fois cette étape réalisée, il suffit de l'appeler dans notre layout en ajoutant dans la balise `head` :\n\n\n```html\n<style amp-custom>\n\t{% capture include_to_sassify %}{% include amp.scss %}{% endcapture %}{{ include_to_sassify | scssify }}\n</style>\n```\n\n\nComme nous n'importons aucun javascript, nous n'avons plus de tag Google Analytics mais heureusement AMP y a pensé. D'abord il faut ajouter le script javascript :\n\n```html\n<script async custom-element=\"amp-analytics\" src=\"https://cdn.ampproject.org/v0/amp-analytics-0.1.js\"></script>\n````\n\n\nCe qui nous permet d'utiliser la balise `<amp-analytics>` et d'y intégrer le code javascript. Juste avant la fermeture de la balise `body`, il faut ajouter :\n\n\n```html\n<amp-analytics type=\"googleanalytics\">\n<script type=\"application/json\">\n{\n  \"vars\": {\n    \"account\": \"{{ site.theme_settings.google_analytics }}\"\n  },\n  \"triggers\": {\n    \"default pageview\": {\n      \"on\": \"visible\",\n      \"request\": \"pageview\",\n      \"vars\": {\n        \"title\": \"{{ page.title }}\"\n      }\n    }\n  }\n}\n</script>\n</amp-analytics>\n```\n\n\nUne dernière étape nécessaire pour que Google voie nos pages AMP est de laisser une balise `link` dans nos pages non AMP avec l'url des nouvelles pages.\n\nDans notre layout principal nous ajoutons le code suivant dans le `head` :\n\n\n```html\n{% if page.path contains '_posts' %}\n     <link rel=\"amphtml\" href=\"{{ page.id | prepend: '/amp' | prepend: site.baseurl_root | prepend: site.url }}\">\n{% endif %}\n```\n\n\nSi vous le souhaitez, vous pouvez voir la pull request [ici](https://github.com/eleven-labs/blog.eleven-labs.com/pull/211){:rel=\"nofollow noreferrer\"}.\n\n### Le mot de la fin\n\nEt voilà ! Vous pouvez retrouver ceci dans vos recherches Google Mobile :\n\n![Search Google](/imgs/posts/2017-09-27-notre-blog-amp/search-google.png)\n\nEt notre page dans le CDN google :\n\n![AMP](/imgs/posts/2017-09-27-notre-blog-amp/amp.png)\n\n**Bonne lecture.**\n"}