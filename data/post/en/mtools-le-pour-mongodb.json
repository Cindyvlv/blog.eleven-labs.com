{"date":"2016-09-29T00:00:00.000Z","title":"mTools - A must have for MongoDB","excerpt":"Maintain an application using MongoDB can be painful, especially when you either have a large amount of data, or a lot of writing operations. This is even more true if, as a developer, you don't have access to production servers, oftenly allowed to few.","readingTime":"7mn","authors":["pouzor"],"categories":[],"content":"\nMaintain an application using MongoDB can be painful, especially when you either have a large amount of data, or a lot of writing operations. This is even more true if, as a developer, you don't have access to production servers, oftenly allowed to few.\n\nHere is the problem : how to find in your huge amount of data or in your daily requests, which one has a negative impact on your performances and much more, find bottlenecks.\n\nGiving the help of MongoDB Inc. on Numeric Editions subjects at FranceTV, we automated the use of tools, in order to study behaviours of our production servers without incidences on our applications.\n\nThe tool, or rather the toolbox we most oftenly use is [MTools](https://github.com/rueckstiess/mtools). This project was started and is still maintained by [Thomas Rückstieß](https://github.com/rueckstiess){:rel=\"nofollow\"}, who worked for MongoDB.\n\nMTools : 6 tools in one\n=======================\n\n### Mloginfo\n\nMloginfo reads logs generated by MongoDB and returns informations about the usage of the database. In our case, we wanted to monitor and profile our request to define the ones which will be take a long amount of time and the ones which will be used the most.\n\nHere is an example of use:\n\n```\nmloginfo --queries logs.mongo/mongod.log\n\nnamespace              operation        pattern                              count     min (ms)    max (ms)    mean (ms)    95%-ile (ms)    sum (ms)\n\nmyCol.$cmd               findandmodify    {\"ID\": 1}                          916493         101       10486          277           453.0    254423325\nmyCol.User               count            {\"activeSeg\": 1, \"updatedAt\": 1}   68           30135     1413998       419353       1350776.4    28516024\nmyCol.InactiveUser       count            {\"inactiveSeg\": 1}                 32          625038     1019698       813384        984999.6    26028315\n```\n\nAbout columns:\n\n-   namespace: which database and collection is used;\n-   operation: the operation being executed (find, update, remove, etc.);\n-   pattern: the filter used on the request. On the first row for example, ID is the field used to filter the findAndModify operation, and could have any values(3, 42, etc...);\n-   count: the total amount of similar requests in log file;\n-   min, max, mean, 95%-ile: the time it takes to execute a request;\n-   sum: cumulated time for this request (in milliseconds).\n\nIn this example, we can see that findandmodify operation is extremly used in an acceptable amount of time. However, simple count operations are taking a huge amount and time, which can be due to a missing index.\n\nMore info [here](https://github.com/rueckstiess/mtools/wiki/mloginfo){:rel=\"nofollow\"}.\n\n### Mlogfilter\n\nIts name says all, Mlogfilter allows you to filter logs. You can easily apply multiple filters and maybe combine it with mloginfo.\n\n```\ncat logs.mongo/mongod.log | mlogfilter --human --slow --from start +1day\n\nFri Sep 16 08:01:58.883 I COMMAND [conn195591] command dbm_rcu_v2.Client command:\naggregate { aggregate: \"Client\", pipeline: [ { $match: { somedate:\n{ $lte: new Date(1474005604000), $gte: new Date(1469951542000) } } }, { $sort:\n{ somedate: -1 } },{ $unwind: \"$someArray\" }, { $skip: 165000 },\n{ $limit: 5000 } ], allowDiskUse: true }\nntoskip:0 keyUpdates:0 writeConflicts:0 numYields:549 reslen:862557\nlocks:{ Global: { acquireCount: { r: 1120 } },\nDatabase: { acquireCount: { r: 560 } }, Collection: { acquireCount: { r: 560 } } }\nprotocol:op_query (0hr 0min 3secs 99ms) 3,099ms\n```\n\nThis command for example show only the slower operations within a day from the beginning of the log file. As we can see, the output gives us an aggregate of commands which took more than three seconds to execute.\n\nMore info [here](https://github.com/rueckstiess/mtools/wiki/mlogfilter){:rel=\"nofollow\"}.\n\n### Mplotqueries & Mlogvis\n\nThose tools allows you to generate graphics to visualize data in a human-readable format. We can see : calls distribution, type of commands, etc :\n\n![mlogvis](/imgs/posts/2016-09-29-mtools-mongodb/mlogvis.png)\n\nMore info on [Mlogvis](https://github.com/rueckstiess/mtools/wiki/mlogvis) & [Mplotqueries](https://github.com/rueckstiess/mtools/wiki/mplotqueries){:rel=\"nofollow\"}.\n\n### Mgenerate\n\nMgenerate is a tool that can randomly fill a MongoDB database given a JSON model. It is a must have when it comes to test functions or requests behavior with a large set of data.\n\nThis is an example of JSON file used to generate an user collection :\n\n```json\n{\n    \"user\": {\n        \"name\": {\n            \"first\": {\"$choose\": [\"Liam\", \"Noah\", \"Ethan\", \"Mason\", \"Logan\", \"Jacob\", \"Lucas\", \"Jackson\", \"Aiden\", \"Jack\", \"James\", \"Elijah\", \"Luke\", \"William\", \"Michael\", \"Alexander\", \"Oliver\", \"Owen\", \"Daniel\", \"Gabriel\", \"Henry\", \"Matthew\", \"Carter\", \"Ryan\", \"Wyatt\", \"Andrew\", \"Connor\", \"Caleb\", \"Jayden\", \"Nathan\", \"Dylan\", \"Isaac\", \"Hunter\", \"Joshua\", \"Landon\", \"Samuel\", \"David\", \"Sebastian\", \"Olivia\", \"Emma\", \"Sophia\", \"Ava\", \"Isabella\", \"Mia\", \"Charlotte\", \"Emily\", \"Abigail\", \"Avery\", \"Harper\", \"Ella\", \"Madison\", \"Amelie\", \"Lily\", \"Chloe\", \"Sofia\", \"Evelyn\", \"Hannah\", \"Addison\", \"Grace\", \"Aubrey\", \"Zoey\", \"Aria\", \"Ellie\", \"Natalie\", \"Zoe\", \"Audrey\", \"Elizabeth\", \"Scarlett\", \"Layla\", \"Victoria\", \"Brooklyn\", \"Lucy\", \"Lillian\", \"Claire\", \"Nora\", \"Riley\", \"Leah\"] },\n            \"last\": {\"$choose\": [\"Smith\", \"Jones\", \"Williams\", \"Brown\", \"Taylor\", \"Davies\", \"Wilson\", \"Evans\", \"Thomas\", \"Johnson\", \"Roberts\", \"Walker\", \"Wright\", \"Robinson\", \"Thompson\", \"White\", \"Hughes\", \"Edwards\", \"Green\", \"Hall\", \"Wood\", \"Harris\", \"Lewis\", \"Martin\", \"Jackson\", \"Clarke\", \"Clark\", \"Turner\", \"Hill\", \"Scott\", \"Cooper\", \"Morris\", \"Ward\", \"Moore\", \"King\", \"Watson\", \"Baker\" , \"Harrison\", \"Morgan\", \"Patel\", \"Young\", \"Allen\", \"Mitchell\", \"James\", \"Anderson\", \"Phillips\", \"Lee\", \"Bell\", \"Parker\", \"Davis\"] }\n        },\n        \"gender\": {\"$choose\": [\"female\", \"male\"]},\n        \"age\": \"$number\",\n        \"address\": {\n            \"street\": {\"$string\": {\"length\": 10}},\n            \"house_no\": \"$number\",\n            \"zip_code\": {\"$number\": [10000, 99999]},\n            \"city\": {\"$choose\": [\"Manhattan\", \"Brooklyn\", \"New Jersey\", \"Queens\", \"Bronx\"]}\n        },\n        \"phone_no\": { \"$missing\" : { \"percent\" : 30, \"ifnot\" : {\"$number\": [1000000000, 9999999999]} } },\n        \"created_at\": {\"$date\": [\"2010-01-01\", \"2014-07-24\"] },\n        \"is_active\": {\"$choose\": [true, false]}\n    },\n    \"tags\": {\"$array\": {\"of\": {\"label\": \"$string\", \"id\": \"$oid\", \"subtags\":\n        {\"$missing\": {\"percent\": 80, \"ifnot\": {\"$array\": [\"$string\", {\"$number\": [2, 5]}]}}}}, \"number\": {\"$number\": [0, 10] }}}\n}\n```\n\nMore info on [Mgenerate](https://github.com/rueckstiess/mtools/wiki/mgenerate){:rel=\"nofollow\"}.\n\n### Mlaunch\n\nMlaunch on the other hand let you create quickly a local workable environment for MongoDB. It can provide a configuration for a standalone usage or for replicas or/and shards. Combined with Mgenerate, it's an efficient and a quick way to setup test environments in order to test apps using MongoDB.\n\nExample :\n\n```\nmlaunch --replicaset --nodes 5\n```\n\nThis command is creating a MongoDB server with 5 replicas.\n\n### Bonus: MongoDB Compass\n\nCompass is a desktop client allowing you to browse and analyze data from a MongoDB database. Its goal is to allow a person to manipulate data without real knowledges on MongoDB querying. However, it's only available on Windows and MacOS yet.\n\n![date-sample](/imgs/posts/2016-09-29-mtools-mongodb/date-sample.png)\n\n![query-builder](/imgs/posts/2016-09-29-mtools-mongodb/query-builder.png)\n"}