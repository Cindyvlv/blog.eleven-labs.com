{"date":"2018-09-10T00:00:00.000Z","title":"Presentation of the PHP library Xpression","excerpt":"As developers, all of us already had to filter dataset (array, collection, API, etc...). Let's focus on the Xpression library, wich allows us to filter different content sources with a simplified query syntax.","readingTime":"13mn","authors":["amoutte"],"categories":["php"],"content":"\n## Presentation of Xpression\n\n[**Xpression**](https://github.com/Symftony/Xpression) is a simple parser which converts textual expression ([DSL](https://fr.wikipedia.org/wiki/Langage_d%C3%A9di%C3%A9)) into logical one (**specification pattern**).\nHere's an overview of Xpression's functionnalities.\n\n## The syntax\n\nThere is some expression examples:\n\nAge must be equal to `26`.\n\n\n```\nage=26\n```\n\n\nAge must be greater than or equal to `20` (included) and less than `30` (excluded).\n\n\n```\nage≥20&age<30\n```\n\n\nOperators supported by bridges:\n\nOperator | Syntax | Examples | ORM | ODM | ArrayCollection | Closure |\n-------- | ------ | ------- | --- | --- | --------------- | ------- |\nequal | `=` | `param=value` | X | X | X | X |\nnot equal | `!=` `≠` | `param!=value` `param≠value` | X | X | X | X |\ngreater than | `>` | `param>value` | X | X | X | X |\ngreater equal than | `>=` `≥` | `param>=value` `param≥value` | X | X | X | X |\nless than | `<` | `param<value` | X | X | X | X |\nless equal than | `<=` `≤` | `param<=value` `param≤value` | X | X | X | X |\nin | `[` `]` | `param[value1,value2]` | X | X | X | X |\ncontains | `{{` `}}` | `param{{value}}` | X | X |  | X |\nnot contains | `!{{` `}}` | `param!{{value}}` | X | X |  | X |\nand | `&` | `param>1&param<10` | X | X | X | X |\nnot and | `!&` | `param>1!&param<10` |  | X |  | X |\nor | <code>&#124;</code> | <code>param>1&#124;param<10</code> | X | X | X | X |\nnot or | <code>!&#124;</code> | <code>param>1!&#124;param<10</code> |  |  |  | X |\nexclusive or | <code>^&#124;</code> `⊕` | <code>param>1^&#124;param<10</code> `param>1⊕param<10` |  |  |  | X |\n\n> Yes, the library provides some bridges like doctrine `ORM`, `ODM` and `common` (collections filter).\n\n#### Priority of composition operator\n\nPay attention to the composition priority operator (`&`, `!&`, `|`, `!|`, `⊕`).\nThe bigger priority applies first.\n\n- `and`: 15\n- `not and`: 14\n- `or`: 10\n- `exclusive or`: 9\n- `not or`: 8\n\nUse parenthesis `(` `)` to group the expressions as you need.\n\nFor example, this expression will select the `Raccoon` or the `Schizo` with more than 100 points.\n\n`planet='Raccoon'|name='Schizo'&point>100` is equal to `planet='Raccoon'|(name='Schizo'&point>100)`\n\nBut the following expression will select `Raccoon` with more than 100 points or `Schizo` with more than 100 points.\n\n`(planet='Raccoon'|name='Schizo')&point>100`\n\n## Usage\n\nLet's see with which cases we should use this library.\n\n### As specification\n\nIn order to have a specification we will use `ClosureExpressionBuilder`.\nIn fact, this class builds a callback with the input expression.\n\n\n```php\n<?php\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// class with getter\nclass Astronaut {\n    private $name;\n    private $planet;\n    private $points;\n    private $rank;\n\n    public function __construct($name, $planet, $points, $rank)\n    {\n        $this->name = $name;\n        $this->planet = $planet;\n        $this->points = $points;\n        $this->rank = $rank;\n    }\n\n    public function getName()\n    {\n        return $this->name;\n    }\n\n    public function getPlanet()\n    {\n        return $this->planet;\n    }\n\n    public function getPoints()\n    {\n        return $this->points;\n    }\n\n    public function getRank()\n    {\n        return $this->rank;\n    }\n}\n\n// objet with public property\n$astronaut1 = new \\stdClass();\n$astronaut1->name = 'Mehdy';\n$astronaut1->planet = 'Raccoons of Asgard';\n$astronaut1->points = 675;\n$astronaut1->rank = 'Captain';\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n$parser = new Parser(new ClosureExpressionBuilder());\n$specification = $parser->parse($query);\n\n$specification(['name' => 'Arnaud', 'planet' => 'Duck Invaders', 'points' => 785, 'rank' => 'Fleet Captain']); // false\n$specification($astronaut1);// true\n$specification(new Astronaut('Ilan', 'Donut Factory', 1325, 'Commodore')); // true\n```\n\n\nAs you see, the specification can be called with an associative array, an object with public properties and an object with getters.\n\n### Filter dataset\n\nWe filter an associative array.`\nWe use again `ClosureExpressionBuilder`.\n\nThis is the dataset we use for the following examples:\n\n\n```php\n<?php\n$astronauts = [\n    ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n    ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n    ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n    ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n    ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n    ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n    ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n    ['name' => 'Noel', 'planet' => 'Duck Invaders', 'points' => 960, 'rank' => 'Fleet Captain'],\n    ['name' => 'Damien', 'planet' => 'Donut Factory', 'points' => 925, 'rank' => 'Fleet Captain'],\n    ['name' => 'Quentin', 'planet' => 'Donut Factory', 'points' => 910, 'rank' => 'Fleet Captain'],\n    ['name' => 'Martin', 'planet' => 'Schizo Cats', 'points' => 860, 'rank' => 'Fleet Captain'],\n    ['name' => 'Carl', 'planet' => 'Donut Factory', 'points' => 800, 'rank' => 'Fleet Captain'],\n    ['name' => 'Arnaud', 'planet' => 'Duck Invaders', 'points' => 785, 'rank' => 'Fleet Captain'],\n    ['name' => 'Alexandre', 'planet' => 'Donut Factory', 'points' => 785, 'rank' => 'Fleet Captain'],\n    ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n    ['name' => 'Romain', 'planet' => 'Donut Factory', 'points' => 735, 'rank' => 'Captain'],\n    ['name' => 'Julie', 'planet' => 'Donut Factory', 'points' => 735, 'rank' => 'Captain'],\n    ['name' => 'Cedric', 'planet' => 'Donut Factory', 'points' => 700, 'rank' => 'Captain'],\n    ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n    ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n];\n```\n\n\nI want to get a 'Raccoons' astronaut.\n\n\n```php\n<?php\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// dataset\n$astronauts = [...];\n\n$query = 'planet{{Raccoons}}';\n\n$parser = new Parser(new ClosureExpressionBuilder());\n$expression = $parser->parse($query);\n\n$filteredAstronauts = array_filter($astronauts, $expression);\n// array contains only 'Raccoons' astronauts\n// $filteredAstronauts = [\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n> Tips: here we use the `$expression` with `array_filter`.\n\nNow, I'd like to select astronauts with more than 1000 points but `Raccoons` too.\n\n\n```php\n<?php\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// dataset\n$astronauts = [...];\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n$parser = new Parser(new ClosureExpressionBuilder());\n$expression = $parser->parse($query);\n\n$filteredAstronauts = array_filter($astronauts, $expression);\n// contains only the 1000 points astronauts and the 'Raccoons'\n// $filteredAstronauts = [\n//     ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n//     ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n//     ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n//     ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n//     ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n### ArrayCollection Filter\n\nTo filter an ArrayCollection we use the bridge `Symftony\\Xpression\\Bridge\\Doctrine\\Common\\ExpressionBuilderAdapter`.\n\n\n```php\n<?php\nuse Doctrine\\Common\\Collections\\ArrayCollection;\nuse Doctrine\\Common\\Collections\\Criteria;\nuse Doctrine\\Common\\Collections\\ExpressionBuilder;\nuse Symftony\\Xpression\\Bridge\\Doctrine\\Common\\ExpressionBuilderAdapter;\nuse Symftony\\Xpression\\Parser;\n\n// dataset\n$astronauts = [...];\n\n// we wrap the array dataset in `ArrayCollection`\n$astronauts = new ArrayCollection($astronauts);\n\n$parser = new Parser(new ExpressionBuilderAdapter(new ExpressionBuilder()));\n$expression = $parser->parse($query);\n$filteredAstronauts = $astronauts->matching(new Criteria($expression));\n```\n\n\n> ℹ️ `ArrayCollection` are used by doctrine to manage relations (oneToMany, manyToMany etc...).\n\n> To filter `Collection` you can use `ClosureExpressionBuilder` and inject it in `Collection::filter(Closure $p)`.\n\n### Database filter\n\n#### Doctrine ODM\n\nNow, we will filter some data in the MongoDB database.\n\n> Brace yourselves, it's gonna be tough!\n\n\n```php\n<?php\nuse Doctrine\\Common\\EventManager;\nuse Doctrine\\MongoDB\\Connection;\nuse Doctrine\\MongoDB\\Database;\nuse Symftony\\Xpression\\Bridge\\Doctrine\\MongoDb\\ExprBuilder;\nuse Symftony\\Xpression\\Expr\\ClosureExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// init connection\n$connection = new Connection('mongodb://localhost');\n$database = $connection->selectDatabase('eleven-labs');\n$collection = $database->selectCollection('astronauts');\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n$parser = new Parser(new ExprBuilder());\n$queryBuilder = $parser->parse($query);\n$astronauts = $collection->createQueryBuilder()->setQueryArray($queryBuilder->getQuery())->getQuery()->execute();\n// $astronauts is a Doctrine\\MongoDB\\Cursor\n// iterator_to_array($astronauts) = [\n//     ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n//     ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n//     ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n//     ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n//     ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n> Pretty simple in the end!\n\n#### Doctrine ORM\n\nAnd doctrine/orm then?\n\n\n```php\n<?php\nuse Doctrine\\ORM\\Tools\\Setup;\nuse Symftony\\Xpression\\Bridge\\Doctrine\\ORM\\ExprAdapter;\nuse Symftony\\Xpression\\Expr\\MapperExpressionBuilder;\nuse Symftony\\Xpression\\Parser;\n\n// in this example I will use the annotation reader for my schema\n$config = Setup::createAnnotationMetadataConfiguration(array(__DIR__ . \"/Orm/Entity\"), true, null, null, false);\n$entityManager = EntityManager::create(array(\n    // database configuration\n    'driver' => 'pdo_sqlite',\n    'path' => __DIR__ . '/ORM/astronauts.sqlite',\n), $config);\n\n$query = 'planet{{Raccoons}}|points≥1000';\n\n// MapperExpressionBuilder use to dynamicly add `a` alias the the query field\n$parser = new Parser(new MapperExpressionBuilder(new ExprAdapter(new Expr()), ['*' => 'a.%s']));\n$expression = $parser->parse($query);\n$qb = $entityManager->getRepository('Example\\Orm\\Entity\\Product')->createQueryBuilder('a');\n$astronauts = $qb->where($expression)->getQuery()->execute();\n// $astronauts = [\n//     ['name' => 'Jonathan', 'planet' => 'Duck Invaders', 'points' => 5505, 'rank' => 'Fleet Admiral'],\n//     ['name' => 'Thierry', 'planet' => 'Duck Invaders', 'points' => 2555, 'rank'=> 'Vice Admiral'],\n//     ['name' => 'Vincent', 'planet' => 'Donut Factory', 'points' => 1885, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Rémy', 'planet' => 'Schizo Cats', 'points' => 1810, 'rank' => 'Rear Admiral'],\n//     ['name' => 'Charles Eric', 'planet' => 'Donut Factory', 'points' => 1385, 'rank' => 'Commodore'],\n//     ['name' => 'Ilan', 'planet' => 'Donut Factory', 'points' => 1325, 'rank' => 'Commodore'],\n//     ['name' => 'Alexandre', 'planet' => 'Schizo Cats', 'points' => 1135, 'rank' => 'Commodore'],\n//     ['name' => 'Thibaud', 'planet' => 'Raccoons of Asgard', 'points' => 760, 'rank' => 'Fleet Captain'],\n//     ['name' => 'Mehdy', 'planet' => 'Raccoons of Asgard', 'points' => 675, 'rank' => 'Captain'],\n//     ['name' => 'Romain', 'planet' => 'Raccoons of Asgard', 'points' => 550, 'rank' => 'Captain'],\n// ];\n```\n\n\n⚠️ When we create queryBuilder with ORM we have to specifiy an alias `EntityRepository::createQueryBuilder($alias)`. That's why it can't identify query field `planet`.\n\nFirst solution is to write the full quallified path field in the query like `a.planet{{Raccoons}}|a.points≥1000`. But some database informations leak in the query.\n\nThe second solution is to use `MapperExpressionBuilder`. This class will decorate `ExpressionBuilder` to dynamically add the alias when the query builder is configured.\n\nIn the following example we prefix all (`*`) fields with `a`.\n\n\n```php\n$parser = new Parser(\n    new MapperExpressionBuilder(\n        new ExprAdapter(new Expr()),\n        ['*' => 'a.%s']\n    )\n);\n```\n\n\n### API endpoint filter\n\nMany solutions are available if you want to filter your API:\n\n - use GraphQL.\n\n> This is not the lightest one. It is not the best choice to only filter data.\n\n - manually get request params and manually build the query with a lot of \"if\" conditions.\n\n> http query params are not readable and can be very heavy for complex query.\n\nGood news! If your API uses one of the previous data sources, you can filter your endpoint with `Xpression`.\n\n> Keep in mind that Xpression is different than GraphQL\n\nWe are going to use [Xpression Bundle](https://github.com/Symftony/Xpression-Bundle).\n\nInstall it with `composer require symftony/xpression-bundle` then add it in symfony (AppKernel.php or bundle.php).\n\nYou must activate querystring correction to fix the parsing of reserved char.\n\n\n```php\n<?php\n// public/index.php or web/app.php (web/app_dev.php)\n// ...\n\\Symftony\\Xpression\\QueryStringParser::correctServerQueryString(); // add this line right before Request creation\n$request = Request::createFromGlobals();\n// ...\n```\n\n\nTo use it you just need to add annotation `@Xpression(expressionBuilder=\"odm\")` over desired filter controller.\n\n\n```php\n<?php\nnamespace App\\Controller;\n\nuse App\\Document\\Astronaut;\nuse App\\Repository\\AstronautsRepository;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\AbstractController;\nuse Symfony\\Component\\HttpFoundation\\JsonResponse;\nuse Symftony\\XpressionBundle\\Annotations\\Xpression;\n\nclass AstronautController extends AbstractController\n{\n    /**\n     * @Xpression(expressionBuilder=\"odm\")\n     *\n     * @return JsonResponse\n     */\n    public function list(AstronautsRepository $astronautsRepository, $query = null)\n    {\n        $qb = $astronautsRepository->createQueryBuilder();\n        if (null !== $query) {\n            $qb->setQueryArray($query->getQuery());\n        }\n\n        return $this->json($qb->getQuery()->execute());\n    }\n}\n```\n\n\nYou can configure the following options:\n\n - source (query source (request, query, attributes, cookies, files, server, headers default: query))\n - sourceName (param name, in the source)\n - targetName (controller argument name to inject the built expression)\n - expressionBuilder (expressionBuilder used for building query *required*)\n\nNow you can go to your endpoint url and add `query`.\n\n\n```\nhttp://localhost/astronauts/list?query={planet{{Raccoons}}|points≥1000}\n```\n\n\n### Conclusion\n\nThis presentation is now over! Don't hesitate to test this library and contribute (idea, bugs, features, documentation, etc).\n\nTo do list :\n- fix usage of query placeholder.\n- add more bridges.\n- refacto lib core to be extensible (easer way to add some syntax).\n- implement a query builder in PHP and JS in order to create directly textual query from the front.\n\n### Useful resources\n\n- [Demo Xpression](http://symftony-xpression.herokuapp.com/)\n- [Code source Xpression](https://github.com/Symftony/Xpression)\n- [Code source Xpression-bundle](https://github.com/Symftony/Xpression-Bundle)\n"}