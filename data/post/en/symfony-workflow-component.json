{"date":"2016-09-29T00:00:00.000Z","title":"Use the Symfony Workflow component","excerpt":"Since Symfony 3.2, a new useful component was born: the [Workflow component](http://symfony.com/blog/new-in-symfony-3-2-workflow-component){:rel=\"nofollow\"}.","readingTime":"8mn","authors":["vcomposieux"],"categories":["php"],"content":"Since Symfony 3.2, a new useful component was born: the [Workflow component](http://symfony.com/blog/new-in-symfony-3-2-workflow-component){:rel=\"nofollow\"}.\nIt is indeed really convenient and can simplify greatly your developments when you have to manage status workflows in your application, that occurs a lot.\n\n# Installation\n\nIn all cases, you have to install the following dependency:\n\n```json\n\"symfony/workflow\": \"~3.2@dev\"\n```\n\nIf you use an earlier version of Symfony but >=2.3 you are also able to use this component, but you have to install the following non-official bundle, which loads the component itself and add the required configuration under the bundle's namespace:\n\n```json\n\"fduch/workflow-bundle\": \"~0.2@dev\"\n```\n\nDo not forget to enable the bundle in your kernel class.\n\n# Configuration\n\nTime has come to write our workflow configuration. We will have to define all our places (statuses / states) and available transitions.\nIn this blog post, we will take a pull request status example. A pull request can have one of the following status: `opened` , `closed` , `needs_review` , `reviewed`  or `merged`.\nHowever, it cannot be, for instance, moved from the `merged` status without having the `reviewed`  status before. The workflow component makes sense here.\n\nHere is our full workflow configuration:\n```yaml\nworkflow:\n    workflows:\n        pull_request:\n            marking_store:\n                type: multiple_state\n                arguments:\n                    - state\n            supports:\n                - AppBundle\\Entity\\PullRequest\n            places:\n                - opened\n                - closed\n                - needs_review\n                - reviewed\n                - merged\n            transitions:\n                feedback:\n                    from: opened\n                    to:   needs_review\n                review:\n                    from: [opened, needs_review]\n                    to:   reviewed\n                merge:\n                    from: reviewed\n                    to:   merged\n                close:\n                    from: [opened, needs_review, reviewed]\n                    to:   closed\n```\n\nHere, we specify we want to use a `multiple_state`  workflow. Please not that if you want to use a simple transition from one state to another, you can use a `single_state`.\nFor this example, we also have defined a `AppBundle\\Entity\\PullRequest` class which has a `state`  property and associated setter and getter methods (component will use these methods to manage transitions):\n\n```php\n<?php\n\nnamespace AppBundle\\Entity;\n\nuse Doctrine\\ORM\\Mapping as ORM;\n\n/**\n * @ORM\\Table(name=\"pull_request\")\n */\nclass PullRequest\n{\n    /**\n     * @ORM\\Column(type=\"json_array\", nullable=true)\n     */\n    protected $state;\n\n    public function setState($state)\n    {\n        $this->state = $state;\n    }\n\n    public function getState()\n    {\n        return $this->state;\n    }\n}\n```\n\n\nEverything is now ready, we can start to use the Workflow component!\n\n# Usage\n\nFirst useful thing to do after you have written your workflow configuration is to generate a graph using the Symfony command. The command will generate one graph using the [Graphviz](http://www.graphviz.org){:rel=\"nofollow\"} format.\n\nHere is the Symfony command you have to run:\n\n```bash\n$ bin/console workflow:dump pull_request\n```\n\nThe generated Graphviz will give you the following diagram:\n\n![Workflow Graphviz](/imgs/posts/2016-09-29-symfony-workflow-component/workflow.png)\n\nThis one gives you a really clear vision of your workflow and allows everyone at every level (developers, product owners, customers, ...) to understand the business logic.\nThe Workflow component implements methods that allow you to verify if a transition is applicable and to later apply it depending on the current status and to also list all enabled transitions.\n\nIn order to check if you can apply a specific transition and apply it, simply use the following code:\n\n```php\n<?php\n\nnamespace AppBundle\\Controller;\n\nuse AppBundle\\Manager\\PullRequestManager;\nuse Symfony\\Bundle\\FrameworkBundle\\Controller\\Controller;\nuse Symfony\\Component\\HttpFoundation\\RedirectResponse;\n\nclass PullRequestController extends Controller\n{\n    /**\n     * @param int $identifier A pull request identifier.\n     *\n     * @return RedirectResponse\n     */\n    public function update($identifier)\n    {\n        ...\n\n        // Notre pull request est au statut \"reviewed\"\n        $pullRequest = $this->getPullRequestManager()->find($identifier);\n\n        // Nous obtenons le service \"workflow.<nom du workflow>\"\n        $workflow = $this->get('workflow.pull_request');\n\n        if ($workflow->can($pullRequest, 'merge')) {\n            $workflow->apply($pullRequest, 'merge');\n        }\n\n        ...\n    }\n}\n```\n\nIn the case you do not want to use the `can()` method, the `apply()` ``` one``` will throw an exception if the transition cannot be effectively done, so you will be able to catch exceptions on the `Symfony\\Component\\Workflow\\Exception\\LogicException` type.\n\n\nTo list all enabled transitions:\n\n```php\n$workflow->getEnabledTransitions($pullRequest);\n```\n\nOverall, the component usage is just as simple as these 3 methods. As you can see, complex workflows are now easier to manage!\n\n# Tune in for events!\n\nThe component also dispatches multiple events, chronologically sorted as:\n\n* `workflow.leave`: when our pull request will leave its current state,\n* `workflow.transition`: when the transition to the new state is launched,\n* `workflow.enter`: when the new state is just defined on our pull request,\n* `workflow.guard`: this one allows you to prevent the asked transition from occurring, you can do that by calling the following method: `$event->setBlocked(true);`\n\nFinally, you have to know that these events also exist in a unique way for each workflow in order to allow you to tune in your workflow events only.\nIf you want to do that, you have to listen to the following name: `workflow.pull_request.enter`.\n\nLet's do better than that: you are also able to listen to a specific transition or a state for a specific workflow:\n\n* `workflow.pull_request.enter.needs_review`: is only dispatched when a `needs_review` state is defined on our pull request. We could for instance send an email to the author with the changes the reviewer has suggested,\n* `workflow.pull_request.transition.merge`: will occur when the merge transition will be dispatched on our pull request.\n\n# Conclusion\n\nThe Workflow component is a really useful component to manage state or status on most of web applications.\nDo not hesitate to use it because its simplicity of configuration and use will probably help you a lot on your projects.\nAlso, this component helps me a lot to give people I was working with a clear vision on a complex workflow we have to manage. The graph generation allows to clarify all of that for everyone!\n"}