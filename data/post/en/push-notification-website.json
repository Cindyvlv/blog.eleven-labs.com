{"date":"2016-11-21T00:00:00.000Z","title":"Push notification on your website","excerpt":"The convenience of PWA is to act like a mobile application, to be installed on a phone, to manage off-line mode, and especially to send push notifications. Notifications are the essential element of user involvement, they allow to send a reminder and to communicate with our users","readingTime":"9mn","authors":["captainjojo"],"categories":["javascript"],"content":"\nIn a [previous article](https://blog.eleven-labs.com/fr/votre-premiere-pwa/) we created our first PWA, but we haven't seen the whole concept. The convenience of [PWA](https://blog.eleven-labs.com/fr/progressive-web-apps-au-googledevsummit/) is to act like a mobile application, to be installed on a phone, to manage off-line mode, and especially to send push notifications. Notifications are the essential element of user involvement, they allow to send a reminder and to communicate with our users. We are going to finalize the last tutorial by setting up a simple push notification system, using [Firebase](https://firebase.google.com/){:rel=\"nofollow\"} to store user tokens.\n\nTo go quicker, we invite you to catch up by retrieving the project [https://github.com/CaptainJojo/pwa-parisjs](https://github.com/CaptainJojo/pwa-parisjs){:rel=\"nofollow\"} that contains a ready to go PWA.\n\n```sh\ngit clone https://github.com/CaptainJojo/pwa-parisjs\ncd pwa-parisjs\ngit checkout manifest\nnpm install\nnpm start\n```\n\nAt this point, you should have access to your PWA at localhost:8080. If you haven't done it yet, you have to install [Lighthouse](https://chrome.google.com/webstore/detail/lighthouse/blipmdconlkpinefehnmjammfjpmpbjk){:rel=\"nofollow\"}, this will allow you to make sure that you have a PWA.\nBefore getting into sending push notifications, we are going to go through the configuration. Yes! It's not magic, we are going to ask Google for authorization.\nLet's go to [Firebase](https://console.firebase.google.com/){:rel=\"nofollow\"} to create a project.\n\n![Firebase - créer un projet](/imgs/posts/2016-11-21-push-notification-website/newproject.png)\n\nFeel free to choose any name for the project. Once you are on the dashboard, you have to click the small wheel, and then \"Project settings\".\n\n![](/imgs/posts/2016-11-21-push-notification-website/settings-1.png)\n\nIn the \"Cloud messaging\" tab you'll find your sender ID.\n\n![](/imgs/posts/2016-11-21-push-notification-website/cloud.png)\n\nIn the manifest.json, available in the public folder of the application, you have to add at the end of the file the \"gsm_sender_id\" with the value of the sender ID.\n\n```json\n{\n  \"name\": \"Lemonde\",\n  \"short_name\": \"Lemonde\",\n  \"icons\": [{\n        \"src\": \"images/touch/icon-128x128.png\",\n        \"sizes\": \"128x128\",\n        \"type\": \"image/png\"\n      }, {\n        \"src\": \"images/touch/apple-touch-icon.png\",\n        \"sizes\": \"152x152\",\n        \"type\": \"image/png\"\n      }, {\n        \"src\": \"images/touch/ms-touch-icon-144x144-precomposed.png\",\n        \"sizes\": \"144x144\",\n        \"type\": \"image/png\"\n      }, {\n        \"src\": \"images/touch/chrome-touch-icon-192x192.png\",\n        \"sizes\": \"192x192\",\n        \"type\": \"image/png\"\n      }],\n  \"start_url\": \"/\",\n  \"display\": \"standalone\",\n  \"background_color\": \"#3E4EB8\",\n  \"theme_color\": \"#2F3BA2\",\n  \"gcm_sender_id\": \"309914158916\"\n}\n```\n\nWe are now going to ask the user to accept notifications. It's very easy, you only need to add the following code to the file public/register.js:\n\n```javascript\nif('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function() {\n      return navigator.serviceWorker.ready;\n    }).then(function(registration) {\n      registration.pushManager.subscribe({userVisibleOnly: true}).then(function(sub) {\n        var endpointSections = sub.endpoint.split('/');\n        var subscriptionId = endpointSections[endpointSections.length - 1];\n        console.log('endpoint:', subscriptionId);\n      });\n    });\n  navigator.serviceWorker.ready.then(function(registration) {\n     console.log('Service Worker Ready');\n  });\n}\n```\n\nAs you would expect, if you restart your server, you'll have a request to accept the notifications.\n\n![PWA - Autoriser les notifications](/imgs/posts/2016-11-21-push-notification-website/capture-decran-2016-10-26-a-15.34.14.png)\n\nYou should also see in your console a message such as:\n\n```json\nendpoint: cV2kP3sOb24:APA91bHfZgFSPQ3CXyG9LejWdq9jOT-WqQpvK4peX9ZZtrfsHCf6OPEvDegjsTF3uXj-Qsf4jOJ5O8rwdEm9fjKZbqerzcZUjDmsiaRcqmxuOOkpuEqPca31Dlh-6g0YgkvnLccIPz_Z\n```\n\nThis is the device token, we will use it to send a push notification.\nSince we want to do something clean (even if it's just a tutorial), we are going to use Firebase to store user tokens. To do so, let's go back to the Firebase console, and click \"Web setup\" in the \"Authentication\" tab.\n\n![](/imgs/posts/2016-11-21-push-notification-website/web_setup.png)\n\nThe script installation is done in the HTML code, in files public/home.html and public/article/alorscettearticle.html.\n\n```html\n<html>\n  <head>\n    <meta charset=utf-8/>\n    <meta name=\"theme-color\" content=\"#2F3BA2\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\n    <link rel=\"manifest\" href=\"/public/manifest.json\">\n  </head>\n  <body>\n    <script src=\"https://www.gstatic.com/firebasejs/3.5.2/firebase.js\"></script>\n    <script src=\"/register.js\"></script>\n    <link rel=\"stylesheet\" href=\"/main.css\">\n    <link rel=\"stylesheet\" href=\"/async.css\">\n```\n\nThe initialization goes to public/register.js.\n\n```javascript\n// Initialize Firebase\nvar config = {\n  apiKey: \"AIzaSyCGg4NPckoKkYdGlZeNHbRAnnK-jLhEPjY\",\n  authDomain: \"pwa-parisjs.firebaseapp.com\",\n  databaseURL: \"https://pwa-parisjs.firebaseio.com\",\n  storageBucket: \"pwa-parisjs.appspot.com\",\n  messagingSenderId: \"309914158916\"\n};\n\nfirebase.initializeApp(config);\n\nif('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function() {\n      return navigator.serviceWorker.ready;\n    }).then(function(registration) {\n      registration.pushManager.subscribe({userVisibleOnly: true}).then(function(sub) {\n        var endpointSections = sub.endpoint.split('/');\n        var subscriptionId = endpointSections[endpointSections.length - 1];\n        console.log('endpoint:', subscriptionId);\n      });\n    });\n  navigator.serviceWorker.ready.then(function(registration) {\n     console.log('Service Worker Ready');\n  });\n}\n```\n\nNow that Firebase is installed, we have to store the user token in the \"database\". You will find all the help you need in the Firebase documentation.\nSo, we are going to add the file public/register.js\n\n```javascript\n// Initialize Firebase\nvar config = {\n  apiKey: \"AIzaSyCGg4NPckoKkYdGlZeNHbRAnnK-jLhEPjY\",\n  authDomain: \"pwa-parisjs.firebaseapp.com\",\n  databaseURL: \"https://pwa-parisjs.firebaseio.com\",\n  storageBucket: \"pwa-parisjs.appspot.com\",\n  messagingSenderId: \"309914158916\"\n};\n\nfirebase.initializeApp(config);\n\nif('serviceWorker' in navigator) {\n  navigator.serviceWorker.register('/sw.js', { scope: '/' }).then(function() {\n      return navigator.serviceWorker.ready;\n    }).then(function(registration) {\n      registration.pushManager.subscribe({userVisibleOnly: true}).then(function(sub) {\n        var endpointSections = sub.endpoint.split('/');\n        var subscriptionId = endpointSections[endpointSections.length - 1];\n        var newKey = firebase.database().ref().child('token').push().key;\n        firebase.database().ref('token/' + newKey).set({subscriptionId: subscriptionId});\n        console.log('endpoint:', subscriptionId);\n      });\n    });\n  navigator.serviceWorker.ready.then(function(registration) {\n     console.log('Service Worker Ready');\n  });\n}\n```\n\nBefore starting the server, you have to open permissions to Firebase in order for it to be able to write into the database. In the tab \"Database\" -> \"Rules\" you need to put:\n\n```json\n{\n  \"rules\": {\n    \".read\": true,\n    \".write\": true\n  }\n}\n```\n\n![](/imgs/posts/2016-11-21-push-notification-website/rules.png)\n\nIf you restart the server, you will see a token stored in the DB in the \"Database\" tab of Firebase.\n\n![](/imgs/posts/2016-11-21-push-notification-website/capture-decran-2016-10-26-a-16.24.58.png)\n\nNow that the tokens are stored in the database, we are going to prepare a message that will appear when a push notification occurs. Let's add the following code to the file public/sw.js:\n\n```javascript\nconsole.log('Started', self);\n\nself.addEventListener('install', function(event) {\n  self.skipWaiting();\n  console.log('Installed', event);\n});\n\nself.addEventListener('activate', function(event) {\n  console.log('Activated', event);\n});\n\nself.addEventListener('push', function(event) {\n  console.log('Push message', event);\n\n  var title = 'Le push de test :)';\n\n  event.waitUntil(\n    self.registration.showNotification(title, {\n     body: 'Bravo tu las reçu',\n     icon: 'images/icon.png',\n     tag: 'my-tag'\n   }));\n});\n```\n\nIt's almost ready! We are going to create a \"/sender\" url that will allow us to send notifications to all the tokens that we have in the database. To do so, we are going to use the <em>request</em> and <em>firebase</em> modules (npm version). Here is the new package.json:\n\n```json\n{\n  \"name\": \"pwa-parisjs\",\n  \"version\": \"0.0.1\",\n  \"description\": \"A Progressive Web App\",\n  \"main\": \"app.js\",\n  \"scripts\": {\n    \"start\": \"node app.js\",\n    \"sw\": \"gulp sw-precache\"\n  },\n  \"dependencies\": {\n    \"express\": \"^4.14.0\",\n    \"firebase\": \"^3.5.1\",\n    \"request\": \"^2.75.0\"\n  },\n  \"devDependencies\": {\n    \"gulp\": \"^3.9.1\",\n    \"sw-precache\": \"^3.2.0\"\n  }\n}\n```\n\nIn the app.js file, we initialize Firebase. You are going to need a server key file. Click the wheel in Firebase, and then \"Permissions\". You are now taken to another console.\n\n![](/imgs/posts/2016-11-21-push-notification-website/permissions.png)\n\nIn \"Service accounts\", create a new account.\n\n![](/imgs/posts/2016-11-21-push-notification-website/account.png)\n\nA json file will be downloaded, you need to add it to your project folder.\n\n![JsonFile - Racine](/imgs/posts/2016-11-21-push-notification-website/capture-decran-2016-10-26-a-17.22.04.png)\n\nIn the app.js file, we are going to add the route /sender that will send a request of a push notification with all the tokens.\n\n```javascript\nvar path = require('path');\nvar express = require('express');\nvar app = express();\nvar firebase = require('firebase');\nvar request = require('request');\n\nfirebase.initializeApp({\n  databaseURL: 'https://pwa-parisjs.firebaseio.com/', // To be found in the Database tab\n  serviceAccount: 'pwa-parisjs-cf0bc079ee69.json' // Name of the json file at the root of your app folder\n});\n\napp.use(express.static(path.join(__dirname, 'public'), {index: false}))\n\napp.get('/sender', function(req, res){\n  var allToken = firebase.database().ref('/token');\n  Promise.all([allToken.once('value')]).then(function(resp) {\n    var allToken = resp[0].val();\n    tokenRep = '';\n    Object.keys(allToken).forEach(function(uid) {\n      var token = allToken[uid];\n      request({\n        url: 'https://android.googleapis.com/gcm/send',\n        method: 'POST',\n        headers: {\n          'Content-Type' :' application/json',\n          'Authorization': 'key=AIzaSyDV-KhCa9dM-bSg_r23GUwpRJqBw6qrJIc', // Server key available in the parameters of the Firebase project\n        },\n        body: JSON.stringify(\n          {\n            \"registration_ids\" : [token.subscriptionId]\n          }\n        )\n      }, function(error, response, body) {\n\n      });\n    });\n  }).catch(function(error) {\n    console.log('Failed to start weekly top posts emailer:', error);\n  });\n\n  res.send('ok');\n});\n\n\napp.use('/', function (req, res) {\n  res.sendFile(__dirname + '/public/home.html');\n});\n\napp.listen(8080, function () {\n  console.log('Example app listening on port 8080!');\n});\n```\n\nBe careful! The authorization key is in the first tab that we opened.\n\n![](/imgs/posts/2016-11-21-push-notification-website/cloud.png)\n\nIf everything is ok, when you restart the server and go to / and then /sender, you will get a notification. If it isn't the case, clear the cache of your application in the chrome console.\n\n![Enfin - la push notification](/imgs/posts/2016-11-21-push-notification-website/capture-decran-2016-10-26-a-17.46.23.png)\n\n\nOnce again, this code is only a tutorial, I invite you to open issues for any question. The finale code is available [here](https://github.com/CaptainJojo/pwa-parisjs/tree/push){:rel=\"nofollow\"}.\n\n*Article translated from the french by Marie Gautier*\n"}