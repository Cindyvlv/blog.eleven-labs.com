{"date":"2020-12-15T00:00:00.000Z","title":"Using Traefik as a reverse proxy","excerpt":"In need for exposing websites and applications easily on the internet with a valid SSL certificate ? You're on the right spot ! :)","readingTime":"11mn","authors":["jmoati","dfert"],"categories":[],"content":"\n![Cover](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/cover.jpg)\n\n## Introduction\n\nAt home, I've got a NAS, a Raspberry PI running on Octopi, a server running on Debian, etc. In short, a galaxy of smart devices serving websites and apps, but nonetheless, none of them are easily accessible from outside my place and even less, from a secured connection.\n\nMaking this charming little world accessible from the unique public IP adress in my possesion leads me to use a reverse proxy system.\n\nBut what actually is a reverse proxy  ? Quoting Wikipedia,\n\n> [...] A reverse proxy is a type of [proxy server](https://en.wikipedia.org/wiki/Proxy_server) that retrieves resources on behalf of a [client](https://en.wikipedia.org/wiki/Client_(computing)) from one or more servers. These resources are then returned to the client, appearing as if they originated from the reverse proxy server itself. Unlike a forward proxy, which is an intermediary for its associated clients to contact any server, a reverse proxy is an intermediary for its associated servers to be contacted by any client. In other words, a proxy is associated with the client(s), while a reverse proxy is associated with the server(s); a reverse proxy is usually an internal-facing proxy used as a 'front-end' to control and protect access to a server on a private network.\n>\n\nThere are loads of reverse proxy on the market, but today's focus will be on Traefik which allows:\n- HTTP and TCP request forwarding\n- Automatic service discovery (featuring Docker for instance)\n- Secured connections via Let's Encrypt certificates\n\nOf course to make it work you will need a domain name (_wilson.net_ in my case), and to make sure the different DNS Zones are pointing to your server.\n\n![My DNS zones](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/11-zones.jpg)\n\nYou could also emulate a domain name through your local `/etc/hosts` file, but in such case the generation of a SSL certificate won't be possible.\n\nOkay, let's set everything up together now :)\n\n\n## Setting-up Traefik\n\nFirst, you'll need to setup Traefik on a webserver accessible from the internet.\n\nIn my case, that server will be 192.168.0.1: it is where ports 80 (HTTP) and 443 (HTTPS) of my internet router (freebox) are forwarded to.\n\n![Port mapping of my freebox router](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/01-ports.jpg)\n\nIt is just as well to install Traefik's binary file, compile it from source, or, just like we'll be doing in this blog post, deploy it with a Docker image.\n\nWe'll use `docker-compose` to avoid typing the same command again and again and also enhance it with new configuration elements as this tutorial goes along.\n\nLet's create our first file `/srv/docker-compose.yaml`\n``` yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n```\n\nIf, for any reason, our server must restart, the `restart: always` instruction will allow our reverse-proxy service to restart automatically, on its own.\n\nInside the `ports` section, we expose the ports of the reverse proxy service to the outside.\n\nInside the `volume` section, we share files and/or directories with our service.\n\nOkay, sharing `/srv/traefik.toml` file with our container is all well and good, but maybe we should create it, right?\n\nWe are then going to create Traefik's main configuration file `/srv/traefik.toml` which declares, at least, the 2 endpoints mentionned earlier:\n\n``` toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n```\n\nNext, we can start our reverse-proxy service from our `/srv` directory using the following command:\n\n``` shell\ndocker-compose up -d\n```\n\n![Launching Traefik with docker-compose](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/02-docker-compose-up.jpg)\n\nOf course, we'll have a pretty 404 response if we visit our server's page for the moment, but take it a proof that our server is here and can't wait to serve us content.\n\n![Traefik returning 404](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/03-nothing-for-the-moment.jpg)\n\n\n## Configuring the dashboard\n\nWe just saw that our reverse-proxy is running but has nothing to display for the moment.\nWe'll now plug the dashboard, allowing us to know if our services, endpoints and routing rules are correctly applyied by Traefik.\n\nFirst, we'll add an `[api]` section to enable the dashboard and the API. Also, adding a `[providers.docker]` section will enable Docker provider and watch for its labels.\n\nTraefik needs to know Docker's socket path in order to activate its provider.\n\nOur main Traefik configuration file `/srv/traefik.toml` should now be similar to:\n\n``` toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n\n[api]\n\n[providers.docker]\n  endpoint = \"unix:///var/run/docker.sock\"\n```\n\nWe'll have to generate a password for dashboard access and prevent anonymous access.\nFor that, we must use `htpasswd` and as we don't want to install it inside our ravishing machine, we'll use an Apache Docker image in order to hash our password.\n\n\n``` shell\ndocker run --rm --name apache httpd:alpine htpasswd -nb wilson schizo\n```\n\n![Password generation](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/04-password.jpg)\n\nIn that exemple, *wilson* is my login, *schizo* is my password.\nThe ouput from our last command is `wilson:$apr1$1eZu7RXg$Ql9Z5AvZNc0Oe4In900mi0`\n\nNow that we have our hashed password, we'll add a `basicauth` middleware which will be in charge of securing access to the page by asking for a password with the `traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0` instruction.\n\nDefine the (http) endpoint with `traefik.http.routers.api.entrypoints=http`.\n\nDeclare we want to use the _api_ service provided by the _internal_ provider `traefik.http.routers.api.service=api@internal`:\nFinally, we now have to adapt the `/srv/docker-compose.yaml` file to something similar to that:\n\n```yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n```\n\nI'd like to highlight that I had to double the `$` symbols in order to escape the `$` symbols as it tries to reference a variable.\nIt is important to stay consistent with names inside routers and middlewares.\n\nHere, the name of my rule is `api`. You could use any name if you like considering that it's not already used for another service and that the name stays the same everywhere.\n\nWe can now ask our service to apply our modifications running the following command again from the `/srv` directory\n\n``` shell\ndocker-compose up -d\n```\n\nHere's what I see when I browse the URL defined in my routing rule above:\n\n![Dashboard](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/05-dashboard.jpg)\n\n\n## Reverse proxy of a website accessible from local network\n\nConnected to my network, there's my NAS I'd like to reach from outside.\n\n\n![My NAS Synology](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/06-nas-http.jpg)\n\nWe'll need to declare it to with the `file` provider as, unlike Docker, it can't be automatically discovered.\nTherefore, we'll create the `/srv/services.toml` file as below:\n\n```toml\n[http]\n  [http.services]\n    [http.services.nas]\n      [http.services.nas.loadBalancer]\n        [[http.services.nas.loadBalancer.servers]]\n          url = \"http://192.168.0.11:5000/\"\n```\n`192.168.0.11` is my NAS IP here and it awaits HTTP requests on port 5000\n\nI'll declare this file provider in `/srv/traefik.toml` in order to load this service file:\n\n```toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n\n[api]\n\n[providers.docker]\n  endpoint = \"unix:///var/run/docker.sock\"\n\n[providers.file]\n  filename = \"/etc/traefik/services.toml\"\n```\n\nAs you may see, the container will search for our service file under `/etc/traefik` but yet, we will keep it under `/srv`.\n\nWe will declare these routing rules in `/srv/docker-compose.yaml` as docker labels:\n\n```yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /srv/services.toml:/etc/traefik/services.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n\n    - \"traefik.http.routers.nas.entrypoints=http\"\n    - \"traefik.http.routers.nas.rule=Host(`nas.wilson.net`)\"\n    - \"traefik.http.routers.nas.service=nas@file\"\n```\nYou probably understood this already but, the service name is always in the form of [service name]@[provider.\n\n`rule` allows me to define which route let me reach my service. Here, I only match on the domain name which must be `nas.wilson.net` .\n\nOnce again, let's not forget to apply our changes with docker-compose:\n\n``` shell\ndocker-compose up -d\n```\n\n_Voilà_, here's what I get now when I reach my NAS using th hostname declared above.\n\n![My reversed nas synology](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/07-nas-reversed.jpg)\n\n\n## Generating SSL certificate\n\nThanks to Let's Encrypt, we can very easily generate SSL certificates that will be automatically renewed for free.\n\nNo more excuses now refraining to embrace HTTP2 and securing the data of your users.\n\nIn order to generate certificates signed by Let's Encrypt, I need to create a `/srv/acme.json` file and make it accessible for Traefik to store its aforesaid certificates.\n\n```shell\n touch /srv/acme.json\n ```\nNext, add this file insde the volume section `/srv/acme.json:/acme.json` of your `/srv/docker-compose.yaml` file.\n\nInside `/srv/traefik.toml`, I declare a certificatesResolver allowing me to get certificates.\n\n```toml\n[certificatesResolvers.wilson.acme]\n  email = \"YOUR@EMAIL.COM\"\n  storage = \"acme.json\"\n  [certificatesResolvers.wilson.acme.httpChallenge]\n    entryPoint = \"http\"\n```\n\nWhich would give me a `/srv/traefik.toml` file similar to:\n\n```toml\n[entryPoints]\n  [entryPoints.http]\n  address = \":80\"\n  [entryPoints.https]\n  address = \":443\"\n\n[api]\n\n[providers.docker]\n  endpoint = \"unix:///var/run/docker.sock\"\n\n[providers.file]\n  filename = \"/etc/traefik/services.toml\"\n\n[certificatesResolvers.wilson.acme]\n  email = \"VOTRE@MAIL.COM\"\n  storage = \"acme.json\"\n  [certificatesResolvers.wilson.acme.httpChallenge]\n    entryPoint = \"http\"\n```\nBeware, your email adress is mandatory.\n\nInside `/srv/docker-compose.yaml` we still need to add labels for generating the SSL certificate of my NAS, that would give:\n\n```yaml\nversion: '3'\n\nservices:\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /srv/services.toml:/etc/traefik/services.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n\n    - \"traefik.http.routers.nas.entrypoints=https,http\"\n    - \"traefik.http.routers.nas.rule=Host(`nas.wilson.net`)\"\n    - \"traefik.http.routers.nas.service=nas@file\"\n    - \"traefik.http.routers.nas.tls=true\"\n    - \"traefik.http.routers.nas.tls.certresolver=wilson\"\n```\n\n`entrypoints` indicates that I want a HTTPS access, else HTTP.\n\n`tls`, that I want to use a SSL certificate.\n\n`tls.certresolver` what certresolver I should use.\n\nAnd let's not forget again to ask docker-compose to apply our new configuration:\n\n``` shell\ndocker-compose up -d\n```\nOnce done, I have an access to my NAS, secured by HTTPS :D\n\n![My nas synology https](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/08-nas-https.jpg)\n\nAnd that I can, of course, see inside my Traefik dashboard:\n\n![My nas synology dashboard](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/09-traefik-dashboard-nas.jpg)\n\n\n## Reverse proxy for services running in Docker containers\n\nNow that we know how to write different routing rules for a service and how to generate SSL certificates, doing such for a Docker service should be a breeze.\n\nAfter reading [DOMOTIZE YOUR WORKSPACE (lang. French)](https://blog.eleven-labs.com/fr/domotize-your-workspace/) article, I wanted to setup _Home Assistant_ at home.\n\n_Home Assistant_ can be set up with a Docker container, so we will add the extra lines inside `/srv/docker-compose.yml` which should now look like this:\n\n```yaml\nversion: '3'\n\nservices:\n  home-assistant:\n    restart: always\n    image: homeassistant/home-assistant\n    volumes:\n    - /srv/docker/home-assistant:/config\n    labels:\n    - \"traefik.enable=true\"\n    - \"traefik.http.routers.home.rule=Host(`home.wilson.net`)\"\n    - \"traefik.http.routers.home.entrypoints=https,http\"\n    - \"traefik.http.routers.home.tls=true\"\n    - \"traefik.http.routers.home.tls.certresolver=wilson\"\n    - \"traefik.http.services.home.loadbalancer.server.port=8123\"\n\n  reverse-proxy:\n    restart: always\n    image: traefik:v2.0\n    ports:\n    - \"443:443\"\n    - \"80:80\"\n    volumes:\n    - /srv/traefik.toml:/etc/traefik/traefik.toml\n    - /srv/services.toml:/etc/traefik/services.toml\n    - /var/run/docker.sock:/var/run/docker.sock\n    labels:\n    - \"traefik.http.routers.api.rule=Host(`traefik.home.wilson.net`)\"\n    - \"traefik.http.routers.api.service=api@internal\"\n    - \"traefik.http.routers.api.entrypoints=http\"\n    - \"traefik.http.routers.api.middlewares=auth\"\n    - \"traefik.http.middlewares.auth.basicauth.users=wilson:$$apr1$$1eZu7RXg$$Ql9Z5AvZNc0Oe4In900mi0\"\n\n    - \"traefik.http.routers.nas.entrypoints=https,http\"\n    - \"traefik.http.routers.nas.rule=Host(`nas.wilson.net`)\"\n    - \"traefik.http.routers.nas.service=nas@file\"\n    - \"traefik.http.routers.nas.tls=true\"\n    - \"traefik.http.routers.nas.tls.certresolver=wilson\"\n```\n\n`traefik.enable=true` enables the reverse proxy for the service and then make it accessible from the internet.\n\n`traefik.http.routers.home.entrypoints=https,http` activates https endpoint, then http endpoint otherwise.\n\n`traefik.http.routers.home.tls=true` indicates that I wish for a SSL certificate.\n\n`traefik.http.routers.home.tls.certresolver=wilson` indicates I want to use the *wilson* certresolver to generate my certificate.\n\n`traefik.http.services.home.loadbalancer.server.port=8123` indicates that the service port I want to expose is 8123.\n\nOnce last time, don't forget to ask docker-compose to apply our new configuration:\n\n``` shell\ndocker-compose up -d\n```\n\nWe can now use _Home Assistant_  and do so directly through https ;)\n\n![Home Assistant](/imgs/posts/2019-12-18-utiliser-traefik-comme-reverse-proxy/10-home-assistant.jpg)\n\nI hope that you enjoyed this article and that you'll be delighted to play with Traefik.\n\nSee ya /o/\n"}