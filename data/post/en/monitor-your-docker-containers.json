{"date":"2020-12-09T00:00:00.000Z","title":"Monitor your Docker containers","excerpt":"Containers are widely used today from development to production. However, a `docker stats` in ssh does not allow you to correctly assess your production environment. We will therefore see how to meet this monitoring need for containers in production.","readingTime":"5mn","authors":["qneyrat","marishka"],"categories":[],"content":"\nContainers are widely used today from development to production. However, a `docker stats` in ssh does not allow you to correctly assess your production environment. We will therefore see how to meet this monitoring need for containers in production.\n\nWe will discuss several technologies to meet this need:\n- [cAdvisor](https://github.com/google/cadvisor), solution made open-source by Google which allows all container metrics to be exposed.\n- [Prometheus](https://github.com/prometheus/prometheus), open-source solution for time series oriented databases.\n- [Grafana](https://github.com/grafana/grafana), open-source solution for easily configurable dashboards which will help draw nice graphs.\n\n> **Resource:**\n> [ctop](https://ctop.sh/) allows you to view `docker stats` info in` htop` style.\n\nThe stack that we are going to see works like this:\n\n- `cAdvisor` will expose the `http://cadvisor:8080/metrics` endpoint with all the metrics of the containers at a given time `t`.\n\n- `Prometheus` will query every `x` seconds the endpoint from cAdvisor and store metrics in its database.\n\n- `Grafana` will display metrics from Prometheus in the form of graphs.\n\nBefore you begin, make sure you have `docker` and` docker-compose` installed. My versions for writing this article are:\n\n```bash\n> $ docker --version; docker-compose --version\nDocker version 17.11.0-ce, build 1caf76c\ndocker-compose version 1.17.1, build 6d101fb\n```\n\nFor starters, we're going to quickly install an app, take for example [Api Platform](https://api-platform.com/).\n\n```bash\n> $ git clone git@github.com:api-platform/api-platform.git\n> $ cd api-platform\n> $ git checkout v2.1.4\n> $ docker-compose up\n> $ open http://127.0.0.1\n```\nWe now have access to the documentation for the API you just installed.\n\n![api]({{site.baseurl}}/assets/2017-12-12-monitorer-ses-containers-docker/api.png)\n\n## cAdvisor\n\nWe are going to add `cAdvisor` to `docker-compose.yml`:\n\n> **Resource:**\n> you can find [`docker-compose.yml` and `prometheus.yml` files here](https://gist.github.com/qneyrat/318e7433b8c4de9edeccbac8ef0ec335).\n\n```yml\nservices:\n...\n  cadvisor:\n    image: google/cadvisor\n    container_name: cadvisor\n    volumes:\n      - /:/rootfs:ro\n      - /var/run:/var/run:rw\n      - /sys:/sys:ro\n      - /var/lib/docker/:/var/lib/docker:ro\n    expose:\n      - 8080\n    ports:\n      - \"8005:8080\"\n    networks:\n      - monitoring\n\nnetworks:\n  monitoring:\n    driver: bridge\n```\n\nLet's restart `docker-compose`.\n\n```bash\n> $ docker-compose build\n> $ docker-compose up\n> $ open http://localhost:8005/docker/\n```\n\nWe can now access `cAdvisor`'s interface.\n\n![cadvisor]({{site.baseurl}}/assets/2017-12-12-monitorer-ses-containers-docker/cadvisor.png)\n\nThis already allows us to see briefly the metrics of our containers.\n\n![metrics]({{site.baseurl}}/assets/2017-12-12-monitorer-ses-containers-docker/metrics.png)\n\nHowever, this solution alone is not configurable enough and cannot fully meet our needs.\n\n## Prometheus\n\nLet's begin by installing `Prometheus`:\n\n```yml\nservices:\n...\n  prometheus:\n    image: prom/prometheus:v2.0.0\n    container_name: prometheus\n    volumes:\n    - ./docker/prometheus/:/etc/prometheus/\n    - prometheus-data:/prometheus\n    command:\n    - '--config.file=/etc/prometheus/prometheus.yml'\n    - '--storage.tsdb.path=/prometheus'\n    - '--web.console.libraries=/etc/prometheus/console_libraries'\n    - '--web.console.templates=/etc/prometheus/consoles'\n    - '--storage.tsdb.retention=200h'\n    expose:\n    - 9090\n    ports:\n    - \"9090:9090\"\n    networks:\n    - monitoring\n\nvolumes:\n...\n  prometheus-data: {}\n```\n\nAnd let's add the configuration file `prometheus.yml` into the `docker/prometheus` folder.\n\n```yml\nglobal:\n  scrape_interval: 15s\n  evaluation_interval: 15s\n  external_labels:\n    monitor: 'docker-host-alpha'\n\nrule_files:\n  - \"targets.rules\"\n  - \"host.rules\"\n  - \"containers.rules\"\n\nscrape_configs:\n  - job_name: 'cadvisor'\n    scrape_interval: 5s\n    static_configs:\n      - targets: ['cadvisor:8080']\n\n  - job_name: 'prometheus'\n    scrape_interval: 10s\n    static_configs:\n      - targets: ['localhost:9090']\n```\n\nWe can notice the `cadvisor` scraping job on the` cadvisor: 8080` endpoint. Prometheus will always scrape according to the following scheme:\n\n```\n<host>:<port>/metrics\n```\n\nFor configuration, the `/metrics` is implied.\n\nWe can restart `docker-compose` again.\n\n```bash\n> $ docker-compose build\n> $ docker-compose up\n> $ open http://localhost:9090/targets\n```\n\nWe can see that the jobs we configured are up. That is to say that `Prometheus` has managed to scrape the metrics from` cAdvisor` and `Prometheus`.\n\n![prom]({{site.baseurl}}/assets/2017-12-12-monitorer-ses-containers-docker/prom.png)\n\n## Grafana\n\nWe are going to install `Grafana` now:\n\n```yml\nservices:\n...\n  grafana:\n    image: grafana/grafana:4.6.2\n    container_name: grafana\n    volumes:\n      - grafana-data:/var/lib/grafana\n    expose:\n      - 3000\n    ports:\n      - \"3000:3000\"\n    networks:\n      - monitoring\n\nvolumes:\n...\n  grafana-data: {}\n```\n\nLet's restart `docker-compose` one last time.\n\n```bash\n> $ docker-compose build\n> $ docker-compose up\n> $ open http://localhost:3000\n```\n\n> **Access:**\n> Default access codes for Grafana are\n>admin\n>admin\n\nLet's start by adding our `Prometheus` as` Data Sources`. Let's go to [http://localhost:3000/datasources/new](http://localhost:3000/datasources/new) and add the host of our `Prometheus`.\n\n![grafana]({{site.baseurl}}/assets/2017-12-12-monitorer-ses-containers-docker/grafana.png)\n\nNow that `Grafana` can access our` Prometheus` all we have to do is create a new dashboard. To save time we will import it directly.\n\n> [https://grafana.com/dashboards/193](https://grafana.com/dashboards/193)\n\nLet's import this new dashboard [http://localhost:3000/dashboard/new?editview=import∨gId=1](http://localhost:3000/dashboard/new?editview=import∨gId=1) and put the template id `193`. Once done, we can go to our dashboard.\n\n> [http://localhost:3000/dashboard/db/docker-monitoring?refresh=10s∨gId=1](http://localhost:3000/dashboard/db/docker-monitoring?refresh=10s∨gId=1)\n\n![dashboard]({{site.baseurl}}/assets/2017-12-12-monitorer-ses-containers-docker/dashboard.png)\n\nWe can now see the system metrics of our containers, like the consumption `cpu` or `ram` for each of them.\n\nDepending on your needs, you can create more specific dashboards with the information you need.\nFor `Prometheus`, there are many `exporters` to be able to retrieve even more metrics like for example for `Redis` or `RabbitMQ`.\nYou can also create an `exporter` yourself as long as it exposes metrics on an `HTTP` `/metrics` endpoint or even exposes business metrics from your application.\n\n> **Resource:**\n> you can find the business metrics exposure in a Java application, as explained in this article\n> [http://blog.xebia.fr/2017/07/28/superviser-mon-application-play-avec-prometheus](http://blog.xebia.fr/2017/07/28/superviser-mon-application-play-avec-prometheus)\n\n## Additional resources\n\n- [https://prometheus.io/blog/2017/05/17/interview-with-iadvize/](https://prometheus.io/blog/2017/05/17/interview-with-iadvize/)\n- [https://www.digitalocean.com/community/tutorials/how-to-install-prometheus-on-ubuntu-16-04](https://www.digitalocean.com/community/tutorials/how-to-install-prometheus-on-ubuntu-16-04)\n- [https://www.ctl.io/developers/blog/post/monitoring-docker-services-with-prometheus/](https://www.ctl.io/developers/blog/post/monitoring-docker-services-with-prometheus/)\n\n## Github repositories for monitoring with Docker\n- [https://github.com/vegasbrianc/prometheus](https://github.com/vegasbrianc/prometheus)\n- [https://github.com/stefanprodan/dockprom](https://github.com/stefanprodan/dockprom)\n"}